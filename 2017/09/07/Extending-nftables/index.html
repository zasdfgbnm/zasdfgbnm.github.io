<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="d44tDfSSWxm1_XP1dAq65hkgyD6zw70Ua9JdCaJqWGg" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Linux,Kernel,nftables,network,netfilter," />





  <link rel="alternate" href="/atom.xml" title="zasdfgbnm" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="IntroductionI’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentation">
<meta name="keywords" content="Linux,Kernel,nftables,network,netfilter">
<meta property="og:type" content="article">
<meta property="og:title" content="Adding new expressions to nftables">
<meta property="og:url" content="https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/index.html">
<meta property="og:site_name" content="zasdfgbnm">
<meta property="og:description" content="IntroductionI’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentation">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-09-14T01:58:43.677Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Adding new expressions to nftables">
<meta name="twitter:description" content="IntroductionI’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentation">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/"/>





  <title>Adding new expressions to nftables | zasdfgbnm</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7583294-5', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a56abdeb557a286a6b7a104348fdfbcd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zasdfgbnm</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">

    <div>
      
      
      <ul class="post-copyright">
        <li class="post-copyright-author">
            <strong>本文作者：</strong>zasdfgbnm
        </li>
        <li class="post-copyright-link">
          <strong>本文链接：</strong>
          <a href="/2017/09/07/Extending-nftables/" title="Adding new expressions to nftables">2017/09/07/Extending-nftables/</a>
        </li>
        <li class="post-copyright-license">
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
        </li>
      </ul>
      
    </div>

    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zasdfgbnm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zasdfgbnm">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Adding new expressions to nftables</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T15:50:12-04:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/07/Extending-nftables/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/09/07/Extending-nftables/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentations about this topic I find online are quite dated. These old documents are mainly for kernel version 2.4 and earlier 2.6.x, in which new matches or targets are registered by calling <code>ipt_register_match</code> and <code>ipt_register_target</code>. The related subsystem of kernel has changed a lot since then, and iptables has been replaced by nftables. Although we can use <code>xt_register_match</code> and <code>xt_register_target</code> instead, I prefer to move to the new nftables framework. Due to the lack of documentation, I have to dig into the source code of Linux kernel to figure out how things works, and this post is the note for that. As Linus Torvalds says in 2008, “Linux is evolution, not intelligent design”, the design and API of nftables might be changing very fast. So I’m not only trying to make a brief review on the design or API of nftables. But also, this post will serve as a guide on how to find the correct way of doing things by reading the kernel source code. The eager reader can go directly to <a href="#summary">the summary section</a>. This post is based on kernel version 4.13, the most recent version when this post is started writing.</p>
<p>Here in this post, we will solve a toy problem: monitor all outgoing TCP traffic from port 80, if it contains the string given by the user, log it. I don’t assume any knowledge in the design or kernel API of nftables, but I do assume the reader has read and understand well <a href="https://wiki.nftables.org" target="_blank" rel="noopener">the official documents on how to use nftables</a>.</p>
<a id="more"></a>
<h1 id="Starting-point-of-kernel-code"><a href="#Starting-point-of-kernel-code" class="headerlink" title="Starting point of kernel code"></a>Starting point of kernel code</h1><p>The starting point is to find which source file to read. The following command gives a nice overview on nftables in Linux kernel:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -P <span class="string">'nftables|nf_tables'</span> -r .</div></pre></td></tr></table></figure></p>
<p>The output shall be something that looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">./include/net/netfilter/nf_tables_core.h:int nf_tables_core_module_init(void);</div><div class="line">./include/net/netfilter/nf_tables_core.h:void nf_tables_core_module_exit(void);</div><div class="line">./include/net/netfilter/nf_tables_ipv4.h:#include &lt;net/netfilter/nf_tables.h&gt;</div><div class="line">./include/net/netfilter/nf_tables.h:#include &lt;linux/netfilter/nf_tables.h&gt;</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_verdict - nf_tables verdict</div><div class="line">./include/net/netfilter/nf_tables.h: *  @code: nf_tables/netfilter verdict code</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_regs - nf_tables register set</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_ctx - nf_tables rule/set context</div><div class="line">...........</div></pre></td></tr></table></figure></p>
<p>The files listed in the output will be the files to look at. A good tool to read Linux kernel source code is <a href="http://elixir.free-electrons.com/linux/v4.13/source" target="_blank" rel="noopener">FreeElectrons</a>. We can start by looking at the file names in directory <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter" target="_blank" rel="noopener">include/net/netfilter</a> on its website. We can see nft_masq.h, nft_redir.h, nft_reject.h in that directory. These are all actions in nftables. Following the references of symbols defined in these files will lead us towards sample codes on how to create new actions. Let’s take reject as an example. From its <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nft_reject.h" target="_blank" rel="noopener">header</a>, we can find an interesting symbol <code>nft_reject_init</code>. Looking around <a href="http://elixir.free-electrons.com/linux/v4.13/ident/nft_reject_init" target="_blank" rel="noopener">all the definitions and references of that symbol</a>, we are able to find the core code at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/ipv4/netfilter/nft_reject_ipv4.c" target="_blank" rel="noopener">net/ipv4/netfilter/nft_reject_ipv4.c</a>.  In its core code, <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/ipv4/netfilter/nft_reject_ipv4.c#L61" target="_blank" rel="noopener">L61-L72</a> reads:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">nft_reject_ipv4_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> nft_register_expr(&amp;nft_reject_ipv4_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">nft_reject_ipv4_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	nft_unregister_expr(&amp;nft_reject_ipv4_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(nft_reject_ipv4_module_init);</div><div class="line">module_exit(nft_reject_ipv4_module_exit);</div></pre></td></tr></table></figure></p>
<p>We can immediately know from the above code that we should call <code>nft_register_expr</code> to register an expression and call <code>nft_unregister_expr</code> to unregister.</p>
<p>Now let’s take a look at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L999" target="_blank" rel="noopener">the prototype of <code>nft_register_expr</code> in nf_tables.h</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_register_expr</span><span class="params">(struct nft_expr_type *)</span></span>;</div></pre></td></tr></table></figure></p>
<p>It takes one parameter of type <code>struct nft_expr_type *</code>. This struct is also defined in nf_tables.h at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L681" target="_blank" rel="noopener">L681</a>.  The usage of <code>nft_register_expr</code> and <code>nft_expr_type</code> can be guessed by reading all the examples. The list of all examples can be found from its reference in <a href="http://elixir.free-electrons.com/linux/v4.13/ident/nft_register_expr" target="_blank" rel="noopener">here</a>. In that list, there is one file that looks very interesting from its file name:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net/netfilter/nf_tables_core.c, line 251</div></pre></td></tr></table></figure></p>
<p><a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nf_tables_core.c#L251" target="_blank" rel="noopener">Open this link</a>, we can see all these basic expressions:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">nft_basic_types</span>[] = &#123;</span></div><div class="line">	&amp;nft_imm_type,</div><div class="line">	&amp;nft_cmp_type,</div><div class="line">	&amp;nft_lookup_type,</div><div class="line">	&amp;nft_bitwise_type,</div><div class="line">	&amp;nft_byteorder_type,</div><div class="line">	&amp;nft_payload_type,</div><div class="line">	&amp;nft_dynset_type,</div><div class="line">	&amp;nft_range_type,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">nf_tables_core_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> err, i;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(nft_basic_types); i++) &#123;</div><div class="line">		err = nft_register_expr(nft_basic_types[i]);</div><div class="line">		<span class="keyword">if</span> (err)</div><div class="line">			<span class="keyword">goto</span> err;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">err:</div><div class="line">	<span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</div><div class="line">		nft_unregister_expr(nft_basic_types[i]);</div><div class="line">	<span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Now we know what to look at. The next step will be to read these examples to get a feeling on how to write our own expression.</p>
<h1 id="The-usage-of-kernel-API"><a href="#The-usage-of-kernel-API" class="headerlink" title="The usage of kernel API"></a>The usage of kernel API</h1><p>To know the usage of related API, we choose to read the reject operation for the inet family and compare operation as sample code. The source code of reject is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c" target="_blank" rel="noopener">net/netfilter/nft_reject_inet.c</a>. The source code of compare is loacated at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_cmp.c" target="_blank" rel="noopener">net/netfilter/nft_cmp.c</a>. In the case that one expression only correspond to one operation, the usage is shown below by the source code of reject operation at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L120" target="_blank" rel="noopener">L120</a>:<a name="nft_expr_ops_and_nft_expr_type_reject"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_reject_inet_type</span>;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_reject_inet_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_reject_inet_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_reject)),</div><div class="line">	.eval		= nft_reject_inet_eval,</div><div class="line">	.init		= nft_reject_inet_init,</div><div class="line">	.dump		= nft_reject_inet_dump,</div><div class="line">	.validate	= nft_reject_validate,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_reject_inet_type</span> __<span class="title">read_mostly</span> = &#123;</span></div><div class="line">	.family		= NFPROTO_INET,</div><div class="line">	.name		= <span class="string">"reject"</span>,</div><div class="line">	.ops		= &amp;nft_reject_inet_ops,</div><div class="line">	.policy		= nft_reject_policy,</div><div class="line">	.maxattr	= NFTA_REJECT_MAX,</div><div class="line">	.owner		= THIS_MODULE,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From the above code, we know that we should create an instance of both <code>struct nft_expr_ops</code> and <code>struct nft_expr_type</code> and point to each other at <code>nft_expr_ops.type</code> and <code>nft_expr_type.ops</code>.  In the case that one expression correspond to many operations, the usage is shown below by the source code of compare operation:<a name="nft_expr_ops_and_nft_expr_type_cmp"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_cmp_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_cmp_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_cmp_expr)),</div><div class="line">	.eval		= nft_cmp_eval,</div><div class="line">	.init		= nft_cmp_init,</div><div class="line">	.dump		= nft_cmp_dump,</div><div class="line">&#125;;</div><div class="line">...........</div><div class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_cmp_fast_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_cmp_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_cmp_fast_expr)),</div><div class="line">	.eval		= <span class="literal">NULL</span>,	<span class="comment">/* inlined */</span></div><div class="line">	.init		= nft_cmp_fast_init,</div><div class="line">	.dump		= nft_cmp_fast_dump,</div><div class="line">&#125;;</div><div class="line">...........</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct nft_expr_ops *</span></div><div class="line"><span class="title">nft_cmp_select_ops</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span></div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data_desc</span> <span class="title">desc</span>;</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data</span> <span class="title">data</span>;</span></div><div class="line">	<span class="keyword">enum</span> nft_cmp_ops op;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_CMP_SREG] == <span class="literal">NULL</span> ||</div><div class="line">	    tb[NFTA_CMP_OP] == <span class="literal">NULL</span> ||</div><div class="line">	    tb[NFTA_CMP_DATA] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line"></div><div class="line">	op = ntohl(nla_get_be32(tb[NFTA_CMP_OP]));</div><div class="line">	<span class="keyword">switch</span> (op) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_EQ:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_NEQ:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LT:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LTE:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GT:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GTE:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = nft_data_init(<span class="literal">NULL</span>, &amp;data, <span class="keyword">sizeof</span>(data), &amp;desc,</div><div class="line">			    tb[NFTA_CMP_DATA]);</div><div class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> ERR_PTR(err);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (desc.type != NFT_DATA_VALUE) &#123;</div><div class="line">		err = -EINVAL;</div><div class="line">		<span class="keyword">goto</span> err1;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (desc.len &lt;= <span class="keyword">sizeof</span>(u32) &amp;&amp; op == NFT_CMP_EQ)</div><div class="line">		<span class="keyword">return</span> &amp;nft_cmp_fast_ops;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;nft_cmp_ops;</div><div class="line">err1:</div><div class="line">	nft_data_release(&amp;data, desc.type);</div><div class="line">	<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_cmp_type</span> __<span class="title">read_mostly</span> = &#123;</span></div><div class="line">	.name		= <span class="string">"cmp"</span>,</div><div class="line">	.select_ops	= nft_cmp_select_ops,</div><div class="line">	.policy		= nft_cmp_policy,</div><div class="line">	.maxattr	= NFTA_CMP_MAX,</div><div class="line">	.owner		= THIS_MODULE,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From this we can see that we should create an instance of <code>struct nft_expr_ops</code> for each operation, and use <code>select_ops</code> to choose dynamically which operation to use.  The <code>select_ops</code> should return the pointer to the operation chosen, or an <code>ERR_PTR</code> in case of error. Now Let’s discuss <code>struct nft_expr_ops</code> and <code>struct nft_expr_type</code> in detail separately.</p>
<h2 id="struct-nft-expr-ops"><a href="#struct-nft-expr-ops" class="headerlink" title="struct nft_expr_ops"></a>struct nft_expr_ops</h2><p>Let’s take a look at <code>struct nft_expr_ops</code> first. It’s definition is at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L722" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L722</a>:<a name="nft_expr_ops"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *	struct nft_expr_ops - nf_tables expression operations</div><div class="line"> *</div><div class="line"> *	@eval: Expression evaluation function</div><div class="line"> *	@size: full expression size, including private data size</div><div class="line"> *	@init: initialization function</div><div class="line"> *	@destroy: destruction function</div><div class="line"> *	@dump: function to dump parameters</div><div class="line"> *	@type: expression type</div><div class="line"> *	@validate: validate expression, called during loop detection</div><div class="line"> *	@data: extra data to attach to this expression operation</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span>;</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> &#123;</span></div><div class="line">	<span class="keyword">void</span>				(*eval)(<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						struct nft_regs *regs,</div><div class="line">						<span class="keyword">const</span> struct nft_pktinfo *pkt);</div><div class="line">	<span class="keyword">int</span>				(*clone)(struct nft_expr *dst,</div><div class="line">						 <span class="keyword">const</span> struct nft_expr *src);</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>			size;</div><div class="line"></div><div class="line">	<span class="keyword">int</span>				(*init)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[]);</div><div class="line">	<span class="keyword">void</span>				(*destroy)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						   <span class="keyword">const</span> struct nft_expr *expr);</div><div class="line">	<span class="keyword">int</span>				(*dump)(struct sk_buff *skb,</div><div class="line">						<span class="keyword">const</span> struct nft_expr *expr);</div><div class="line">	<span class="keyword">int</span>				(*validate)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						    <span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						    <span class="keyword">const</span> struct nft_data **data);</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span>	*<span class="title">type</span>;</span></div><div class="line">	<span class="keyword">void</span>				*data;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From the name and comments of these fields, we can see that <code>init</code>, <code>destroy</code>, <code>clone</code> play the role of constructor, destructor, and copy constructor. What to do in these functions is shown in <a href="#nft_expr_ops_and_nft_expr_type_reject">the code above</a>. In that code, <code>init</code> is defined as <code>nft_reject_inet_init</code> and <code>clone</code> and <code>destroy</code> are not defined. The source code for <code>nft_reject_inet_init</code> is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L64" target="_blank" rel="noopener">L64</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_reject_inet_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></div><div class="line">				<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">				<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">int</span> icmp_code;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_REJECT_TYPE] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">	priv-&gt;type = ntohl(nla_get_be32(tb[NFTA_REJECT_TYPE]));</div><div class="line">	<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">		<span class="keyword">if</span> (tb[NFTA_REJECT_ICMP_CODE] == <span class="literal">NULL</span>)</div><div class="line">			<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">		icmp_code = nla_get_u8(tb[NFTA_REJECT_ICMP_CODE]);</div><div class="line">		<span class="keyword">if</span> (priv-&gt;type == NFT_REJECT_ICMPX_UNREACH &amp;&amp;</div><div class="line">		    icmp_code &gt; NFT_REJECT_ICMPX_MAX)</div><div class="line">			<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">		priv-&gt;icmp_code = icmp_code;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>By reading this function and looking into all other functions called by this function, we can see that the following things will happen: The kernel will allocate memory for an instance of <code>struct nft_reject</code>, which is the struct that stores operation specific data, at <code>expr-&gt;data</code>. In order for the kernel to know the size of memory to allocate for <code>struct nft_reject</code>, its size is passed to <code>nft_expr_ops.size</code> as shown in the 4th line at <a href="#nft_expr_ops_and_nft_expr_type_reject">the code snippet above</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.size = NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_reject))</div></pre></td></tr></table></figure></p>
<p>The <code>init</code> function is responsible to initialize the fields of this instance by reading attributes from <a href="https://en.wikipedia.org/wiki/Netlink" target="_blank" rel="noopener">netlink</a> by calling functions like <code>nla_get_&lt;type&gt;</code>. Data from netlink is stored at the argument <code>tb</code>. In case of error, the <code>init</code> function should return a negative number, otherwise <code>0</code> should be returned. <a name="question_netlink"></a>Up to now, we are not sure how to let netlink know what attributes are expected and what are the length of these attributes yet, but don’t worry, things will become clear as we keep reading. Let’s for now just forget about this problem.</p>
<p>Now let’s take a look at the <code>dump</code> field, it is implemented by <code>nft_reject_inet_dump</code> for reject operation. The code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L96" target="_blank" rel="noopener">L96</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_reject_inet_dump</span><span class="params">(struct sk_buff *skb,</span></span></div><div class="line">				<span class="keyword">const</span> struct nft_expr *expr)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (nla_put_be32(skb, NFTA_REJECT_TYPE, htonl(priv-&gt;type)))</div><div class="line">		<span class="keyword">goto</span> nla_put_failure;</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">		<span class="keyword">if</span> (nla_put_u8(skb, NFTA_REJECT_ICMP_CODE, priv-&gt;icmp_code))</div><div class="line">			<span class="keyword">goto</span> nla_put_failure;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">nla_put_failure:</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>We can see that this operation send back the parameters to netlink using functions like <code>nla_put_&lt;type&gt;</code>. In case of success, <code>0</code> should be returned, otherwise it should return a negative number.</p>
<p>The function that evaluate the evaluation correspond to the field <code>eval</code>. We can think of there are two types of expressions: those that match some conditions, and those that do something, such as drop, reject, accept, dnat, etc., to the packets. For these two types, the <code>eval</code> should be slightly different. Here we use the source code of both compare and reject as example. In reject, it is implemented as <code>nft_reject_inet_eval</code>. The source code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L20" target="_blank" rel="noopener">L20</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_reject_inet_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr,</span></span></div><div class="line">				 struct nft_regs *regs,</div><div class="line">				 <span class="keyword">const</span> struct nft_pktinfo *pkt)</div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (nft_pf(pkt)) &#123;</div><div class="line">	<span class="keyword">case</span> NFPROTO_IPV4:</div><div class="line">		<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">			nf_send_unreach(pkt-&gt;skb, priv-&gt;icmp_code,</div><div class="line">					nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">			nf_send_reset(nft_net(pkt), pkt-&gt;skb, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">			nf_send_unreach(pkt-&gt;skb,</div><div class="line">					nft_reject_icmp_code(priv-&gt;icmp_code),</div><div class="line">					nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFPROTO_IPV6:</div><div class="line">		<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">			nf_send_unreach6(nft_net(pkt), pkt-&gt;skb,</div><div class="line">					 priv-&gt;icmp_code, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">			nf_send_reset6(nft_net(pkt), pkt-&gt;skb, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">			nf_send_unreach6(nft_net(pkt), pkt-&gt;skb,</div><div class="line">					 nft_reject_icmpv6_code(priv-&gt;icmp_code),</div><div class="line">					 nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	regs-&gt;verdict.code = NF_DROP;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>In the compare operation, it is implemented as <code>nft_cmp_eval</code>. The source code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_cmp.c#L27" target="_blank" rel="noopener">L27</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_cmp_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr,</span></span></div><div class="line">			 struct nft_regs *regs,</div><div class="line">			 <span class="keyword">const</span> struct nft_pktinfo *pkt)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_cmp_expr</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">int</span> d;</div><div class="line"></div><div class="line">	d = <span class="built_in">memcmp</span>(&amp;regs-&gt;data[priv-&gt;sreg], &amp;priv-&gt;data, priv-&gt;len);</div><div class="line">	<span class="keyword">switch</span> (priv-&gt;op) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_EQ:</div><div class="line">		<span class="keyword">if</span> (d != <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_NEQ:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LT:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LTE:</div><div class="line">		<span class="keyword">if</span> (d &gt; <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GT:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GTE:</div><div class="line">		<span class="keyword">if</span> (d &lt; <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"></div><div class="line">mismatch:</div><div class="line">	regs-&gt;verdict.code = NFT_BREAK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>From these two functions, we can see that this function tells the kernel to do something by setting <code>regs-&gt;verdict.code</code> or to continue to the next expression by not changing <code>regs-&gt;verdict.code</code>. For actions, the value of <code>regs-&gt;verdict.code</code> should be set to one of the following as shown in <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter.h#L9" target="_blank" rel="noopener">include/uapi/linux/netfilter.h#L9</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Responses from hook functions. */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_DROP 0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_ACCEPT 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_STOLEN 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_QUEUE 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_REPEAT 4</span></div></pre></td></tr></table></figure></p>
<p>For matches, it should be a value in <code>enum nft_verdicts</code>, which is listed at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h#L49" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h#L49</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * enum nft_verdicts - nf_tables internal verdicts</div><div class="line"> *</div><div class="line"> * @NFT_CONTINUE: continue evaluation of the current rule</div><div class="line"> * @NFT_BREAK: terminate evaluation of the current rule</div><div class="line"> * @NFT_JUMP: push the current chain on the jump stack and jump to a chain</div><div class="line"> * @NFT_GOTO: jump to a chain without pushing the current chain on the jump stack</div><div class="line"> * @NFT_RETURN: return to the topmost chain on the jump stack</div><div class="line"> *</div><div class="line"> * The nf_tables verdicts share their numeric space with the netfilter verdicts.</div><div class="line"> */</div><div class="line"><span class="keyword">enum</span> nft_verdicts &#123;</div><div class="line">	NFT_CONTINUE	= <span class="number">-1</span>,</div><div class="line">	NFT_BREAK	= <span class="number">-2</span>,</div><div class="line">	NFT_JUMP	= <span class="number">-3</span>,</div><div class="line">	NFT_GOTO	= <span class="number">-4</span>,</div><div class="line">	NFT_RETURN	= <span class="number">-5</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>validate</code> is used to check the validation of operation, for example: masquerade is only available at hook point <code>POSTROUTING</code>, reject is only available at hook point <code>LOCAL INPUT</code>, <code>LOCAL_OUTPUT</code> and <code>FORWARD</code>, etc. This can be shown at the source code of at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject.c#L29" target="_blank" rel="noopener">net/netfilter/nft_reject.c#L29</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_reject_validate</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></div><div class="line">			<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">			<span class="keyword">const</span> struct nft_data **data)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> nft_chain_validate_hooks(ctx-&gt;chain,</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_IN) |</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_FORWARD) |</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_OUT));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>The function <code>nft_chain_validate_hooks</code> is used to validate the hook point. There are other helper functions to validate different things, the list of these functions can be obtained by searching the string “validate” at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h</a>.</p>
<h2 id="struct-nft-expr-type"><a href="#struct-nft-expr-type" class="headerlink" title="struct nft_expr_type"></a>struct nft_expr_type</h2><p>The definition of <code>nft_expr_type</code> is at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L681" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L681</a>:<a name="nft_expr_type"></a><br><a name="nft_expr_type"></a><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *	struct nft_expr_type - nf_tables expression type</div><div class="line"> *</div><div class="line"> *	@select_ops: function to select nft_expr_ops</div><div class="line"> *	@ops: default ops, used when no select_ops functions is present</div><div class="line"> *	@list: used internally</div><div class="line"> *	@name: Identifier</div><div class="line"> *	@owner: module reference</div><div class="line"> *	@policy: netlink attribute policy</div><div class="line"> *	@maxattr: highest netlink attribute number</div><div class="line"> *	@family: address family for AF-specific types</div><div class="line"> *	@flags: expression type flags</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> &#123;</span></div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span>	*(*<span class="title">select_ops</span>)(<span class="title">const</span> <span class="title">struct</span> <span class="title">nft_ctx</span> *,</span></div><div class="line">						       <span class="title">const</span> <span class="title">struct</span> <span class="title">nlattr</span> * <span class="title">const</span> <span class="title">tb</span>[]);</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span>	*<span class="title">ops</span>;</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span>			*name;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>			*<span class="title">owner</span>;</span></div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span>		*<span class="title">policy</span>;</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>			maxattr;</div><div class="line">	u8				family;</div><div class="line">	u8				flags;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>ops</code> and <code>select_ops</code> is already discussed; the field <code>list</code> is internally, so we should not worry about it here; the field <code>name</code> is the name of the expression; the field <code>owner</code> should be set to the pointer towards the current module. These are all trivial fields. Now let’s take a look at the <code>policy</code> and <code>maxattr</code> field. The related code at <a href="#nft_expr_ops_and_nft_expr_type_reject">the definition of <code>nft_reject_inet_type</code></a> is:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">.policy = nft_reject_policy,</div><div class="line">.maxattr = NFTA_REJECT_MAX,</div></pre></td></tr></table></figure></p>
<p>The array <code>nft_reject_policy</code> is defined at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject.c#L23" target="_blank" rel="noopener">L23</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> <span class="title">nft_reject_policy</span>[<span class="title">NFTA_REJECT_MAX</span> + 1] = &#123;</span></div><div class="line">	[NFTA_REJECT_TYPE]		= &#123; .type = NLA_U32 &#125;,</div><div class="line">	[NFTA_REJECT_ICMP_CODE]		= &#123; .type = NLA_U8 &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The two array index above, <code>NFTA_REJECT_TYPE</code> and <code>NFTA_REJECT_ICMP_CODE</code>, belongs to an enum named <code>nft_reject_attributes</code>. And the definition of <code>NFTA_REJECT_MAX</code> and <code>nft_reject_attributes</code> is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h#L1089" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h#L1089</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * enum nft_reject_attributes - nf_tables reject expression netlink attributes</div><div class="line"> *</div><div class="line"> * @NFTA_REJECT_TYPE: packet type to use (NLA_U32: nft_reject_types)</div><div class="line"> * @NFTA_REJECT_ICMP_CODE: ICMP code to use (NLA_U8)</div><div class="line"> */</div><div class="line"><span class="keyword">enum</span> nft_reject_attributes &#123;</div><div class="line">	NFTA_REJECT_UNSPEC,</div><div class="line">	NFTA_REJECT_TYPE,</div><div class="line">	NFTA_REJECT_ICMP_CODE,</div><div class="line">	__NFTA_REJECT_MAX</div><div class="line">&#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFTA_REJECT_MAX		(__NFTA_REJECT_MAX - 1)</span></div></pre></td></tr></table></figure></p>
<p>Recall that we raised a question <a href="#question_netlink">before</a> on how does the kernel knows what are the attributes expected by the expression. The <code>policy</code> field is exactly the answer to this question. Let’s now dig deeper and read the source code of netlink starting at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netlink.h#L9" target="_blank" rel="noopener">include/net/netlink.h#L9</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ========================================================================</span></div><div class="line"> *         Netlink Messages and Attributes Interface (As Seen On TV)</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *                          Messages Interface</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Message Format:</div><div class="line"> *    &lt;--- nlmsg_total_size(payload)  ---&gt;</div><div class="line"> *    &lt;-- nlmsg_msg_size(payload) -&gt;</div><div class="line"> *   +----------+- - -+-------------+- - -+-------- - -</div><div class="line"> *   | nlmsghdr | Pad |   Payload   | Pad | nlmsghdr</div><div class="line"> *   +----------+- - -+-------------+- - -+-------- - -</div><div class="line"> *   nlmsg_data(nlh)---^                   ^</div><div class="line"> *   nlmsg_next(nlh)-----------------------+</div><div class="line"> *</div><div class="line"> * Payload Format:</div><div class="line"> *    &lt;---------------------- nlmsg_len(nlh) ---------------------&gt;</div><div class="line"> *    &lt;------ hdrlen ------&gt;       &lt;- nlmsg_attrlen(nlh, hdrlen) -&gt;</div><div class="line"> *   +----------------------+- - -+--------------------------------+</div><div class="line"> *   |     Family Header    | Pad |           Attributes           |</div><div class="line"> *   +----------------------+- - -+--------------------------------+</div><div class="line"> *   nlmsg_attrdata(nlh, hdrlen)---^</div><div class="line"> *</div><div class="line"> * Data Structures:</div><div class="line"> *   struct nlmsghdr			netlink message header</div><div class="line"> *</div><div class="line"> * Message Construction:</div><div class="line"> *   nlmsg_new()			create a new netlink message</div><div class="line"> *   nlmsg_put()			add a netlink message to an skb</div><div class="line"> *   nlmsg_put_answer()			callback based nlmsg_put()</div><div class="line"> *   nlmsg_end()			finalize netlink message</div><div class="line"> *   nlmsg_get_pos()			return current position in message</div><div class="line"> *   nlmsg_trim()			trim part of message</div><div class="line"> *   nlmsg_cancel()			cancel message construction</div><div class="line"> *   nlmsg_free()			free a netlink message</div><div class="line"> *</div><div class="line"> * Message Sending:</div><div class="line"> *   nlmsg_multicast()			multicast message to several groups</div><div class="line"> *   nlmsg_unicast()			unicast a message to a single socket</div><div class="line"> *   nlmsg_notify()			send notification message</div><div class="line"> *</div><div class="line"> * Message Length Calculations:</div><div class="line"> *   nlmsg_msg_size(payload)		length of message w/o padding</div><div class="line"> *   nlmsg_total_size(payload)		length of message w/ padding</div><div class="line"> *   nlmsg_padlen(payload)		length of padding at tail</div><div class="line"> *</div><div class="line"> * Message Payload Access:</div><div class="line"> *   nlmsg_data(nlh)			head of message payload</div><div class="line"> *   nlmsg_len(nlh)			length of message payload</div><div class="line"> *   nlmsg_attrdata(nlh, hdrlen)	head of attributes data</div><div class="line"> *   nlmsg_attrlen(nlh, hdrlen)		length of attributes data</div><div class="line"> *</div><div class="line"> * Message Parsing:</div><div class="line"> *   nlmsg_ok(nlh, remaining)		does nlh fit into remaining bytes?</div><div class="line"> *   nlmsg_next(nlh, remaining)		get next netlink message</div><div class="line"> *   nlmsg_parse()			parse attributes of a message</div><div class="line"> *   nlmsg_find_attr()			find an attribute in a message</div><div class="line"> *   nlmsg_for_each_msg()		loop over all messages</div><div class="line"> *   nlmsg_validate()			validate netlink message incl. attrs</div><div class="line"> *   nlmsg_for_each_attr()		loop over all attributes</div><div class="line"> *</div><div class="line"> * Misc:</div><div class="line"> *   nlmsg_report()			report back to application?</div><div class="line"> *</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *                          Attributes Interface</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Attribute Format:</div><div class="line"> *    &lt;------- nla_total_size(payload) -------&gt;</div><div class="line"> *    &lt;---- nla_attr_size(payload) -----&gt;</div><div class="line"> *   +----------+- - -+- - - - - - - - - +- - -+-------- - -</div><div class="line"> *   |  Header  | Pad |     Payload      | Pad |  Header</div><div class="line"> *   +----------+- - -+- - - - - - - - - +- - -+-------- - -</div><div class="line"> *                     &lt;- nla_len(nla) -&gt;      ^</div><div class="line"> *   nla_data(nla)----^                        |</div><div class="line"> *   nla_next(nla)-----------------------------'</div><div class="line"> *</div><div class="line"> * Data Structures:</div><div class="line"> *   struct nlattr			netlink attribute header</div><div class="line"> *</div><div class="line"> * Attribute Construction:</div><div class="line"> *   nla_reserve(skb, type, len)	reserve room for an attribute</div><div class="line"> *   nla_reserve_nohdr(skb, len)	reserve room for an attribute w/o hdr</div><div class="line"> *   nla_put(skb, type, len, data)	add attribute to skb</div><div class="line"> *   nla_put_nohdr(skb, len, data)	add attribute w/o hdr</div><div class="line"> *   nla_append(skb, len, data)		append data to skb</div><div class="line"> *</div><div class="line"> * Attribute Construction for Basic Types:</div><div class="line"> *   nla_put_u8(skb, type, value)	add u8 attribute to skb</div><div class="line"> *   nla_put_u16(skb, type, value)	add u16 attribute to skb</div><div class="line"> *   nla_put_u32(skb, type, value)	add u32 attribute to skb</div><div class="line"> *   nla_put_u64_64bit(skb, type,</div><div class="line"> *                     value, padattr)	add u64 attribute to skb</div><div class="line"> *   nla_put_s8(skb, type, value)	add s8 attribute to skb</div><div class="line"> *   nla_put_s16(skb, type, value)	add s16 attribute to skb</div><div class="line"> *   nla_put_s32(skb, type, value)	add s32 attribute to skb</div><div class="line"> *   nla_put_s64(skb, type, value,</div><div class="line"> *               padattr)		add s64 attribute to skb</div><div class="line"> *   nla_put_string(skb, type, str)	add string attribute to skb</div><div class="line"> *   nla_put_flag(skb, type)		add flag attribute to skb</div><div class="line"> *   nla_put_msecs(skb, type, jiffies,</div><div class="line"> *                 padattr)		add msecs attribute to skb</div><div class="line"> *   nla_put_in_addr(skb, type, addr)	add IPv4 address attribute to skb</div><div class="line"> *   nla_put_in6_addr(skb, type, addr)	add IPv6 address attribute to skb</div><div class="line"> *</div><div class="line"> * Nested Attributes Construction:</div><div class="line"> *   nla_nest_start(skb, type)		start a nested attribute</div><div class="line"> *   nla_nest_end(skb, nla)		finalize a nested attribute</div><div class="line"> *   nla_nest_cancel(skb, nla)		cancel nested attribute construction</div><div class="line"> *</div><div class="line"> * Attribute Length Calculations:</div><div class="line"> *   nla_attr_size(payload)		length of attribute w/o padding</div><div class="line"> *   nla_total_size(payload)		length of attribute w/ padding</div><div class="line"> *   nla_padlen(payload)		length of padding</div><div class="line"> *</div><div class="line"> * Attribute Payload Access:</div><div class="line"> *   nla_data(nla)			head of attribute payload</div><div class="line"> *   nla_len(nla)			length of attribute payload</div><div class="line"> *</div><div class="line"> * Attribute Payload Access for Basic Types:</div><div class="line"> *   nla_get_u8(nla)			get payload for a u8 attribute</div><div class="line"> *   nla_get_u16(nla)			get payload for a u16 attribute</div><div class="line"> *   nla_get_u32(nla)			get payload for a u32 attribute</div><div class="line"> *   nla_get_u64(nla)			get payload for a u64 attribute</div><div class="line"> *   nla_get_s8(nla)			get payload for a s8 attribute</div><div class="line"> *   nla_get_s16(nla)			get payload for a s16 attribute</div><div class="line"> *   nla_get_s32(nla)			get payload for a s32 attribute</div><div class="line"> *   nla_get_s64(nla)			get payload for a s64 attribute</div><div class="line"> *   nla_get_flag(nla)			return 1 if flag is true</div><div class="line"> *   nla_get_msecs(nla)			get payload for a msecs attribute</div><div class="line"> *</div><div class="line"> * Attribute Misc:</div><div class="line"> *   nla_memcpy(dest, nla, count)	copy attribute into memory</div><div class="line"> *   nla_memcmp(nla, data, size)	compare attribute with memory area</div><div class="line"> *   nla_strlcpy(dst, nla, size)	copy attribute to a sized string</div><div class="line"> *   nla_strcmp(nla, str)		compare attribute with string</div><div class="line"> *</div><div class="line"> * Attribute Parsing:</div><div class="line"> *   nla_ok(nla, remaining)		does nla fit into remaining bytes?</div><div class="line"> *   nla_next(nla, remaining)		get next netlink attribute</div><div class="line"> *   nla_validate()			validate a stream of attributes</div><div class="line"> *   nla_validate_nested()		validate a stream of nested attributes</div><div class="line"> *   nla_find()				find attribute in stream of attributes</div><div class="line"> *   nla_find_nested()			find attribute in nested attributes</div><div class="line"> *   nla_parse()			parse and validate stream of attrs</div><div class="line"> *   nla_parse_nested()			parse nested attribuets</div><div class="line"> *   nla_for_each_attr()		loop over all attributes</div><div class="line"> *   nla_for_each_nested()		loop over the nested attributes</div><div class="line"> *=========================================================================</div><div class="line"> */</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Standard attribute types to specify validation policy</div><div class="line">  */</div><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">	NLA_UNSPEC,</div><div class="line">	NLA_U8,</div><div class="line">	NLA_U16,</div><div class="line">	NLA_U32,</div><div class="line">	NLA_U64,</div><div class="line">	NLA_STRING,</div><div class="line">	NLA_FLAG,</div><div class="line">	NLA_MSECS,</div><div class="line">	NLA_NESTED,</div><div class="line">	NLA_NESTED_COMPAT,</div><div class="line">	NLA_NUL_STRING,</div><div class="line">	NLA_BINARY,</div><div class="line">	NLA_S8,</div><div class="line">	NLA_S16,</div><div class="line">	NLA_S32,</div><div class="line">	NLA_S64,</div><div class="line">	__NLA_TYPE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NLA_TYPE_MAX (__NLA_TYPE_MAX - 1)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * struct nla_policy - attribute validation policy</div><div class="line"> * @type: Type of attribute or NLA_UNSPEC</div><div class="line"> * @len: Type specific length of payload</div><div class="line"> *</div><div class="line"> * Policies are defined as arrays of this struct, the array must be</div><div class="line"> * accessible by attribute type up to the highest identifier to be expected.</div><div class="line"> *</div><div class="line"> * Meaning of `len' field:</div><div class="line"> *    NLA_STRING           Maximum length of string</div><div class="line"> *    NLA_NUL_STRING       Maximum length of string (excluding NUL)</div><div class="line"> *    NLA_FLAG             Unused</div><div class="line"> *    NLA_BINARY           Maximum length of attribute payload</div><div class="line"> *    NLA_NESTED           Don't use `len' field -- length verification is</div><div class="line"> *                         done by checking len of nested header (or empty)</div><div class="line"> *    NLA_NESTED_COMPAT    Minimum length of structure payload</div><div class="line"> *    NLA_U8, NLA_U16,</div><div class="line"> *    NLA_U32, NLA_U64,</div><div class="line"> *    NLA_S8, NLA_S16,</div><div class="line"> *    NLA_S32, NLA_S64,</div><div class="line"> *    NLA_MSECS            Leaving the length field zero will verify the</div><div class="line"> *                         given type fits, using it verifies minimum length</div><div class="line"> *                         just like "All other"</div><div class="line"> *    All other            Minimum length of attribute payload</div><div class="line"> *</div><div class="line"> * Example:</div><div class="line"> * static const struct nla_policy my_policy[ATTR_MAX+1] = &#123;</div><div class="line"> * 	[ATTR_FOO] = &#123; .type = NLA_U16 &#125;,</div><div class="line"> *	[ATTR_BAR] = &#123; .type = NLA_STRING, .len = BARSIZ &#125;,</div><div class="line"> *	[ATTR_BAZ] = &#123; .len = sizeof(struct mystruct) &#125;,</div><div class="line"> * &#125;;</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> &#123;</span></div><div class="line">	u16		type;</div><div class="line">	u16		len;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The comments explains itself very well. The source code of attributes of different expressions are all defined at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h</a>. To get a feeling on how to write an array like this, just search the string “attributes” in this file. All definition of attributes should begin with an <code>UNSPEC</code> to leave space for internal usage.</p>
<p>The field <code>family</code> is the address family of your expression. Possible values can be found at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter.h#L59" target="_blank" rel="noopener">include/uapi/linux/netfilter.h#L59</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">	NFPROTO_UNSPEC =  <span class="number">0</span>,</div><div class="line">	NFPROTO_INET   =  <span class="number">1</span>,</div><div class="line">	NFPROTO_IPV4   =  <span class="number">2</span>,</div><div class="line">	NFPROTO_ARP    =  <span class="number">3</span>,</div><div class="line">	NFPROTO_NETDEV =  <span class="number">5</span>,</div><div class="line">	NFPROTO_BRIDGE =  <span class="number">7</span>,</div><div class="line">	NFPROTO_IPV6   = <span class="number">10</span>,</div><div class="line">	NFPROTO_DECNET = <span class="number">12</span>,</div><div class="line">	NFPROTO_NUMPROTO,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>flags</code> are used to denote expression types. Currently, only one flag is available, that is if an expression is stateful. See <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L707" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L707</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFT_EXPR_STATEFUL		0x1</span></div></pre></td></tr></table></figure></p>
<h1 id="Summary-on-kernel-codes"><a href="#Summary-on-kernel-codes" class="headerlink" title="Summary on kernel codes"></a><a name="summary"></a>Summary on kernel codes</h1><p>Create an instance of <code>struct nft_expr_ops</code> for each operation of this expression. Implements its fields as in <a href="#nft_expr_ops">its definition</a>. Use <code>init</code>, <code>clone</code>, <code>destroy</code> to initialize, clone and destroy object. In <code>init</code>, read attributes from netlink and setup operation’s struct. Implement the core function of this operation in <code>eval</code>, tell kernel what to do by setting <code>regs-&gt;verdict.code</code>. In <code>dump</code>, send the attributes through netlink. Apply constraints to operations in <code>validate</code>.</p>
<p>Create an instance of <code>struct nft_expr_type</code> for your expression. Implements its fields as in <a href="#nft_expr_type">its definition</a>. If you have multiple operations that should be selected dynamically, implement <code>select_ops</code> otherwise set <code>ops</code>. Set <code>name</code>, <code>owner</code> according to your expression. If applicable, set address family at <code>family</code>. If applicable, use <code>flags</code> to indicate if your expression is stateful. Create an array of <code>struct nla_policy</code>, setup attribute information in that array, and set this array as <code>policy</code>. Set <code>maxattr</code> as the maximum number of attributes.</p>
<p>Call <code>nft_register_expr</code> to register your expression. Call <code>nft_unregister_expr</code> to unregister your expression.</p>
<h1 id="Writing-our-own-kernel-code"><a href="#Writing-our-own-kernel-code" class="headerlink" title="Writing our own kernel code"></a>Writing our own kernel code</h1><p>With the knowledge on how to write kernel codes, we are ready to write our own module to add our expression. Here we call our expression “abcde”</p>
<p>abcde.h:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _ABCDE_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _ABCDE_H</span></div><div class="line"></div><div class="line"><span class="keyword">enum</span> nft_abcde_attributes &#123;</div><div class="line">	NFTA_ABCDE_UNSPEC,</div><div class="line">	NFTA_ABCDE_TEXT,</div><div class="line">	__NFTA_ABCDE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFTA_ABCDE_MAX (__NFTA_ABCDE_MAX - 1)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _ABCDE_H */</span></span></div></pre></td></tr></table></figure></p>
<p>abcde.c:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/netfilter/nf_tables.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"abcde.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ABCDE_TEXT_SIZE 128</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> &#123;</span></div><div class="line">	<span class="keyword">char</span> text[ABCDE_TEXT_SIZE];</div><div class="line">	<span class="keyword">int</span> len;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">match_packet</span><span class="params">(struct nft_abcde *priv, struct sk_buff *skb)</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> = <span class="title">tcp_hdr</span>(<span class="title">skb</span>);</span></div><div class="line">	<span class="keyword">char</span> *user_data = (<span class="keyword">char</span> *)((<span class="keyword">char</span> *)tcph + (tcph-&gt;doff * <span class="number">4</span>));</div><div class="line">	<span class="keyword">char</span> *tail = skb_tail_pointer(skb);</div><div class="line">	<span class="keyword">char</span> *p;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (p = user_data; p &lt; tail - priv-&gt;len; p++) &#123;</div><div class="line">		<span class="keyword">int</span> i; <span class="keyword">bool</span> found = <span class="literal">true</span>;</div><div class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; priv-&gt;len; i++)</div><div class="line">			<span class="keyword">if</span> (p[i] != priv-&gt;text[i]) &#123;</div><div class="line">				found = <span class="literal">false</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		<span class="keyword">if</span> (found)</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> <span class="title">nft_abcde_policy</span>[<span class="title">NFTA_ABCDE_MAX</span> + 1] = &#123;</span></div><div class="line">	[NFTA_ABCDE_TEXT]		= &#123; .type = NLA_STRING, .len = ABCDE_TEXT_SIZE &#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_abcde_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr, struct nft_regs *regs, <span class="keyword">const</span> struct nft_pktinfo *pkt)</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span> = <span class="title">pkt</span>-&gt;<span class="title">skb</span>;</span></div><div class="line">	<span class="keyword">if</span>(match_packet(priv, skb))</div><div class="line">		regs-&gt;verdict.code = NFT_CONTINUE;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		regs-&gt;verdict.code = NFT_BREAK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_abcde_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, <span class="keyword">const</span> struct nft_expr *expr, <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_ABCDE_TEXT] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line">	nla_strlcpy(priv-&gt;text, tb[NFTA_ABCDE_TEXT], ABCDE_TEXT_SIZE);</div><div class="line">	priv-&gt;len = <span class="built_in">strlen</span>(priv-&gt;text);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_abcde_dump</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nft_expr *expr)</span> </span>&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">if</span> (nla_put_string(skb, NFTA_ABCDE_TEXT, priv-&gt;text))</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_abcde_type</span>;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_abcde_op</span> = &#123;</span></div><div class="line">	.eval = nft_abcde_eval,</div><div class="line">	.size = <span class="keyword">sizeof</span>(struct nft_abcde),</div><div class="line">	.init = nft_abcde_init,</div><div class="line">	.dump = nft_abcde_dump,</div><div class="line">	.type = &amp;nft_abcde_type,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_abcde_type</span> __<span class="title">read_mostly</span> =  &#123;</span></div><div class="line">	.ops = &amp;nft_abcde_op,</div><div class="line">	.name = <span class="string">"abcde"</span>,</div><div class="line">	.owner = THIS_MODULE,</div><div class="line">	.policy = nft_abcde_policy,</div><div class="line">	.maxattr = NFTA_ABCDE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">nft_abcde_module_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> nft_register_expr(&amp;nft_abcde_type);</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">nft_abcde_module_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">	nft_unregister_expr(&amp;nft_abcde_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(nft_abcde_module_init);</div><div class="line">module_exit(nft_abcde_module_exit);</div><div class="line"></div><div class="line">MODULE_AUTHOR(<span class="string">"Xiang Gao"</span>);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line">MODULE_DESCRIPTION(<span class="string">"A sample nftables expression."</span>);</div></pre></td></tr></table></figure></p>
<p>Makefile:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">obj-m = abcde.o</div><div class="line">KVERSION = <span class="variable">$(<span class="built_in">shell</span> uname -r)</span></div><div class="line"><span class="section">all:</span></div><div class="line">	make -C /lib/modules/<span class="variable">$(KVERSION)</span>/build M=<span class="variable">$(PWD)</span> modules</div><div class="line"><span class="section">clean:</span></div><div class="line">	make -C /lib/modules/<span class="variable">$(KVERSION)</span>/build M=<span class="variable">$(PWD)</span> clean</div></pre></td></tr></table></figure></p>
<p>The complete source code for this example can be found at GitHub:<br><a href="https://github.com/zasdfgbnm/nftables-abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/nftables-abcde</a></p>
<h1 id="Modify-user-space-tool"><a href="#Modify-user-space-tool" class="headerlink" title="Modify user space tool"></a>Modify user space tool</h1><p>In order to be able to conveniently use our new expression “abcde”,  it would be good to modify the source code of user space tool, i.e. the <code>nft</code> command, to make it aware of our new expression. Extending the user space tool is easier. We first check it out from its git repository and switch to tag v0.7 (the newest release when this article is written):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git://git.netfilter.org/nftables</div><div class="line"><span class="built_in">cd</span> nftables</div><div class="line">git checkout v0.7 -b abcde</div></pre></td></tr></table></figure></p>
<p>To figure out where to modify, let’s run <code>grep</code> to see how the expression <code>reject</code> is implemented:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -i reject -r src include</div></pre></td></tr></table></figure></p>
<p>The above command will output something like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">src/datatype.c:         SYMBOL(&quot;reject-route&quot;,          ICMPV6_REJECT_ROUTE),</div><div class="line">......</div><div class="line">src/evaluate.c:static int reject_payload_gen_dependency_tcp(struct eval_ctx *ctx,</div><div class="line">......</div><div class="line">src/netlink_delinearize.c:static void netlink_parse_reject(struct netlink_parse_ctx *ctx,</div><div class="line">......</div><div class="line">src/parser_bison.y:%token _REJECT                       &quot;reject&quot;</div><div class="line">......</div><div class="line">src/scanner.l:&quot;reject&quot;          &#123; return _REJECT; &#125;</div><div class="line">src/statement.c:static void reject_stmt_print(const struct stmt *stmt)</div><div class="line">......</div><div class="line">include/linux/netfilter/nf_tables.h: * enum nft_reject_types - nf_tables reject expression reject types</div><div class="line">......</div><div class="line">include/statement.h:struct reject_stmt &#123;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>This tells us the files we may want to modify. A good start point is <code>scanner.l</code> and <code>parser_bison.y</code>. We can copy and paste the code for reject, replace it with our own thing.</p>
<p>After some try and error, we end up with the following patch generated by <code>git diff v0.7</code>:<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div></pre></td><td class="code"><pre><div class="line">diff --git a/include/statement.h b/include/statement.h</div><div class="line">index 277ff2f..9043790 100644</div><div class="line"><span class="comment">--- a/include/statement.h</span></div><div class="line"><span class="comment">+++ b/include/statement.h</span></div><div class="line">@@ -76,6 +76,12 @@ struct reject_stmt &#123;</div><div class="line"></div><div class="line"> extern struct stmt *reject_stmt_alloc(const struct location *loc);</div><div class="line"></div><div class="line"><span class="addition">+struct abcde_stmt &#123;</span></div><div class="line"><span class="addition">+	const char *	text;</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+extern struct stmt *abcde_stmt_alloc(const struct location *loc);</span></div><div class="line"><span class="addition">+</span></div><div class="line"> struct nat_stmt &#123;</div><div class="line"> 	enum nft_nat_types	type;</div><div class="line"> 	struct expr		*addr;</div><div class="line">@@ -199,6 +205,7 @@ extern struct stmt *xt_stmt_alloc(const struct location *loc);</div><div class="line">  * @STMT_LIMIT:		limit statement</div><div class="line">  * @STMT_LOG:		log statement</div><div class="line">  * @STMT_REJECT:	REJECT statement</div><div class="line"><span class="addition">+ * @STMT_ABCDE:		abcde statement</span></div><div class="line">  * @STMT_NAT:		NAT statement</div><div class="line">  * @STMT_MASQ:		masquerade statement</div><div class="line">  * @STMT_REDIR:		redirect statement</div><div class="line">@@ -222,6 +229,7 @@ enum stmt_types &#123;</div><div class="line"> 	STMT_LIMIT,</div><div class="line"> 	STMT_LOG,</div><div class="line"> 	STMT_REJECT,</div><div class="line"><span class="addition">+	STMT_ABCDE,</span></div><div class="line"> 	STMT_NAT,</div><div class="line"> 	STMT_MASQ,</div><div class="line"> 	STMT_REDIR,</div><div class="line">@@ -280,6 +288,7 @@ struct stmt &#123;</div><div class="line"> 		struct log_stmt		log;</div><div class="line"> 		struct limit_stmt	limit;</div><div class="line"> 		struct reject_stmt	reject;</div><div class="line"><span class="addition">+		struct abcde_stmt	abcde;</span></div><div class="line"> 		struct nat_stmt		nat;</div><div class="line"> 		struct masq_stmt	masq;</div><div class="line"> 		struct redir_stmt	redir;</div><div class="line">diff --git a/src/evaluate.c b/src/evaluate.c</div><div class="line">index 8a3da54..751d702 100644</div><div class="line"><span class="comment">--- a/src/evaluate.c</span></div><div class="line"><span class="comment">+++ b/src/evaluate.c</span></div><div class="line">@@ -2495,6 +2495,8 @@ int stmt_evaluate(struct eval_ctx *ctx, struct stmt *stmt)</div><div class="line"> 		return stmt_evaluate_ct(ctx, stmt);</div><div class="line"> 	case STMT_LOG:</div><div class="line"> 		return stmt_evaluate_log(ctx, stmt);</div><div class="line"><span class="addition">+	case STMT_ABCDE:</span></div><div class="line"><span class="addition">+		return 0;</span></div><div class="line"> 	case STMT_REJECT:</div><div class="line"> 		return stmt_evaluate_reject(ctx, stmt);</div><div class="line"> 	case STMT_NAT:</div><div class="line">diff --git a/src/netlink_delinearize.c b/src/netlink_delinearize.c</div><div class="line">index cb0f6ac..f8b83a6 100644</div><div class="line"><span class="comment">--- a/src/netlink_delinearize.c</span></div><div class="line"><span class="comment">+++ b/src/netlink_delinearize.c</span></div><div class="line">@@ -799,6 +799,16 @@ static void netlink_parse_reject(struct netlink_parse_ctx *ctx,</div><div class="line"> 	ctx-&gt;stmt = stmt;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void netlink_parse_abcde(struct netlink_parse_ctx *ctx,</span></div><div class="line"><span class="addition">+				 const struct location *loc,</span></div><div class="line"><span class="addition">+				 const struct nftnl_expr *expr)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct stmt *stmt;</span></div><div class="line"><span class="addition">+	stmt = abcde_stmt_alloc(loc);</span></div><div class="line"><span class="addition">+	stmt-&gt;abcde.text = xstrdup(nftnl_expr_get_str(expr, NFTNL_EXPR_ABCDE_TEXT));</span></div><div class="line"><span class="addition">+	ctx-&gt;stmt = stmt;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void netlink_parse_nat(struct netlink_parse_ctx *ctx,</div><div class="line"> 			      const struct location *loc,</div><div class="line"> 			      const struct nftnl_expr *nle)</div><div class="line">@@ -1144,6 +1154,7 @@ static const struct &#123;</div><div class="line"> 	&#123; .name = "limit",	.parse = netlink_parse_limit &#125;,</div><div class="line"> 	&#123; .name = "range",	.parse = netlink_parse_range &#125;,</div><div class="line"> 	&#123; .name = "reject",	.parse = netlink_parse_reject &#125;,</div><div class="line"><span class="addition">+	&#123; .name = "abcde",	.parse = netlink_parse_abcde &#125;,</span></div><div class="line"> 	&#123; .name = "nat",	.parse = netlink_parse_nat &#125;,</div><div class="line"> 	&#123; .name = "notrack",	.parse = netlink_parse_notrack &#125;,</div><div class="line"> 	&#123; .name = "masq",	.parse = netlink_parse_masq &#125;,</div><div class="line">diff --git a/src/netlink_linearize.c b/src/netlink_linearize.c</div><div class="line">index 0915038..893ae7e 100644</div><div class="line"><span class="comment">--- a/src/netlink_linearize.c</span></div><div class="line"><span class="comment">+++ b/src/netlink_linearize.c</span></div><div class="line">@@ -874,6 +874,18 @@ static void netlink_gen_reject_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 	nftnl_rule_add_expr(ctx-&gt;nlr, nle);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void netlink_gen_abcde_stmt(struct netlink_linearize_ctx *ctx,</span></div><div class="line"><span class="addition">+				    const struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr *nle;</span></div><div class="line"><span class="addition">+	nle = alloc_nft_expr("abcde");</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (stmt-&gt;abcde.text != NULL) &#123;</span></div><div class="line"><span class="addition">+		nftnl_expr_set_str(nle, NFTNL_EXPR_ABCDE_TEXT, stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	nftnl_rule_add_expr(ctx-&gt;nlr, nle);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void netlink_gen_nat_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 				 const struct stmt *stmt)</div><div class="line"> &#123;</div><div class="line">@@ -1200,6 +1212,8 @@ static void netlink_gen_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 		return netlink_gen_log_stmt(ctx, stmt);</div><div class="line"> 	case STMT_REJECT:</div><div class="line"> 		return netlink_gen_reject_stmt(ctx, stmt);</div><div class="line"><span class="addition">+	case STMT_ABCDE:</span></div><div class="line"><span class="addition">+		return netlink_gen_abcde_stmt(ctx, stmt);</span></div><div class="line"> 	case STMT_NAT:</div><div class="line"> 		return netlink_gen_nat_stmt(ctx, stmt);</div><div class="line"> 	case STMT_MASQ:</div><div class="line">diff --git a/src/parser_bison.y b/src/parser_bison.y</div><div class="line">index deaaf06..ac16c72 100644</div><div class="line"><span class="comment">--- a/src/parser_bison.y</span></div><div class="line"><span class="comment">+++ b/src/parser_bison.y</span></div><div class="line">@@ -399,6 +399,7 @@ static void location_update(struct location *loc, struct location *rhs, int n)</div><div class="line"> %token RANDOM			"random"</div><div class="line"> %token FULLY_RANDOM		"fully-random"</div><div class="line"> %token PERSISTENT		"persistent"</div><div class="line"><span class="addition">+%token ABCDE			"abcde"</span></div><div class="line"></div><div class="line"> %token QUEUE			"queue"</div><div class="line"> %token QUEUENUM			"num"</div><div class="line">@@ -499,6 +500,8 @@ static void location_update(struct location *loc, struct location *rhs, int n)</div><div class="line"> %type &lt;val&gt;			set_stmt_op</div><div class="line"> %type &lt;stmt&gt;			flow_stmt flow_stmt_alloc</div><div class="line"> %destructor &#123; stmt_free($$); &#125;	flow_stmt flow_stmt_alloc</div><div class="line"><span class="addition">+%type &lt;stmt&gt;			abcde_stmt abcde_stmt_alloc</span></div><div class="line"><span class="addition">+%destructor &#123; stmt_free($$); &#125;	abcde_stmt abcde_stmt_alloc</span></div><div class="line"></div><div class="line"> %type &lt;expr&gt;			symbol_expr verdict_expr integer_expr variable_expr</div><div class="line"> %destructor &#123; expr_free($$); &#125;	symbol_expr verdict_expr integer_expr variable_expr</div><div class="line">@@ -1400,6 +1403,7 @@ stmt			:	verdict_stmt</div><div class="line"> 			|	limit_stmt</div><div class="line"> 			|	quota_stmt</div><div class="line"> 			|	reject_stmt</div><div class="line"><span class="addition">+			|	abcde_stmt</span></div><div class="line"> 			|	nat_stmt</div><div class="line"> 			|	queue_stmt</div><div class="line"> 			|	ct_stmt</div><div class="line">@@ -1736,6 +1740,21 @@ reject_opts		:       /* empty */</div><div class="line"> 			&#125;</div><div class="line"> 			;</div><div class="line"></div><div class="line"><span class="addition">+abcde_stmt		:	abcde_stmt_alloc	abcde_opts</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+abcde_stmt_alloc	:	ABCDE</span></div><div class="line"><span class="addition">+			&#123;</span></div><div class="line"><span class="addition">+				$$ = abcde_stmt_alloc(&amp;@$);</span></div><div class="line"><span class="addition">+			&#125;</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+abcde_opts		:	string</span></div><div class="line"><span class="addition">+			&#123;</span></div><div class="line"><span class="addition">+				$&lt;stmt&gt;0-&gt;abcde.text = $1;</span></div><div class="line"><span class="addition">+			&#125;</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> nat_stmt		:	nat_stmt_alloc	nat_stmt_args</div><div class="line"> 			;</div><div class="line"></div><div class="line">diff --git a/src/scanner.l b/src/scanner.l</div><div class="line">index 625023f..595db76 100644</div><div class="line"><span class="comment">--- a/src/scanner.l</span></div><div class="line"><span class="comment">+++ b/src/scanner.l</span></div><div class="line">@@ -333,6 +333,7 @@ addrstring	(&#123;macaddr&#125;|&#123;ip4addr&#125;|&#123;ip6addr&#125;)</div><div class="line"> "random"		&#123; return RANDOM; &#125;</div><div class="line"> "fully-random"		&#123; return FULLY_RANDOM; &#125;</div><div class="line"> "persistent"		&#123; return PERSISTENT; &#125;</div><div class="line"><span class="addition">+"abcde"             &#123; return ABCDE; &#125;</span></div><div class="line"></div><div class="line"> "ll"			&#123; return LL_HDR; &#125;</div><div class="line"> "nh"			&#123; return NETWORK_HDR; &#125;</div><div class="line">diff --git a/src/statement.c b/src/statement.c</div><div class="line">index e70eb51..29b8015 100644</div><div class="line"><span class="comment">--- a/src/statement.c</span></div><div class="line"><span class="comment">+++ b/src/statement.c</span></div><div class="line">@@ -417,6 +417,28 @@ struct stmt *reject_stmt_alloc(const struct location *loc)</div><div class="line"> 	return stmt_alloc(loc, &amp;reject_stmt_ops);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void abcde_stmt_print(const struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	printf("abcde \"%s\"", stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void abcde_stmt_destroy(struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	xfree(stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static const struct stmt_ops abcde_stmt_ops = &#123;</span></div><div class="line"><span class="addition">+	.type		= STMT_ABCDE,</span></div><div class="line"><span class="addition">+	.name		= "abcde",</span></div><div class="line"><span class="addition">+	.print		= abcde_stmt_print,</span></div><div class="line"><span class="addition">+	.destroy	= abcde_stmt_destroy,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct stmt *abcde_stmt_alloc(const struct location *loc)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	return stmt_alloc(loc, &amp;abcde_stmt_ops);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void print_nf_nat_flags(uint32_t flags)</div><div class="line"> &#123;</div><div class="line"> 	const char *delim = " ";</div></pre></td></tr></table></figure></p>
<p>Same thing applies to libnftnl, we clone the repository and checkout the tag libnftnl-1.0.7:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git://git.netfilter.org/libnftnl</div><div class="line"><span class="built_in">cd</span> libnftnl</div><div class="line">git checkout libnftnl-1.0.7 -b abcde</div></pre></td></tr></table></figure></p>
<p>After some try and error, we end up with the following patch using command <code>git diff libnftnl-1.0.7</code>:<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line">diff --git a/include/libnftnl/expr.h b/include/libnftnl/expr.h</div><div class="line">index 74e986d..26259a7 100644</div><div class="line"><span class="comment">--- a/include/libnftnl/expr.h</span></div><div class="line"><span class="comment">+++ b/include/libnftnl/expr.h</span></div><div class="line">@@ -186,6 +186,10 @@ enum &#123;</div><div class="line"> 	NFTNL_EXPR_REJECT_CODE,</div><div class="line"> &#125;;</div><div class="line"></div><div class="line"><span class="addition">+enum &#123;</span></div><div class="line"><span class="addition">+	NFTNL_EXPR_ABCDE_TEXT	= NFTNL_EXPR_BASE,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> enum &#123;</div><div class="line"> 	NFTNL_EXPR_QUEUE_NUM	= NFTNL_EXPR_BASE,</div><div class="line"> 	NFTNL_EXPR_QUEUE_TOTAL,</div><div class="line">diff --git a/include/linux/netfilter/abcde.h b/include/linux/netfilter/abcde.h</div><div class="line">new file mode 100644</div><div class="line">index 0000000..eb027a7</div><div class="line"><span class="comment">--- /dev/null</span></div><div class="line"><span class="comment">+++ b/include/linux/netfilter/abcde.h</span></div><div class="line"><span class="meta">@@ -0,0 +1,12 @@</span></div><div class="line"><span class="addition">+#ifndef _ABCDE_H</span></div><div class="line"><span class="addition">+#define _ABCDE_H</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+enum nft_abcde_attributes &#123;</span></div><div class="line"><span class="addition">+	NFTA_ABCDE_UNSPEC,</span></div><div class="line"><span class="addition">+	NFTA_ABCDE_TEXT,</span></div><div class="line"><span class="addition">+	__NFTA_ABCDE_MAX,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#define NFTA_ABCDE_MAX (__NFTA_ABCDE_MAX - 1)</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#endif /* _ABCDE_H */</span></div><div class="line">diff --git a/src/Makefile.am b/src/Makefile.am</div><div class="line">index 485a8c4..a9cb87d 100644</div><div class="line"><span class="comment">--- a/src/Makefile.am</span></div><div class="line"><span class="comment">+++ b/src/Makefile.am</span></div><div class="line">@@ -35,6 +35,7 @@ libnftnl_la_SOURCES = utils.c		\</div><div class="line"> 		      expr/fwd.c	\</div><div class="line"> 		      expr/limit.c	\</div><div class="line"> 		      expr/log.c	\</div><div class="line"><span class="addition">+		      expr/abcde.c	\</span></div><div class="line"> 		      expr/lookup.c	\</div><div class="line"> 		      expr/dynset.c	\</div><div class="line"> 		      expr/immediate.c	\</div><div class="line">diff --git a/src/expr/abcde.c b/src/expr/abcde.c</div><div class="line">new file mode 100644</div><div class="line">index 0000000..e76abd4</div><div class="line"><span class="comment">--- /dev/null</span></div><div class="line"><span class="comment">+++ b/src/expr/abcde.c</span></div><div class="line"><span class="meta">@@ -0,0 +1,183 @@</span></div><div class="line"><span class="addition">+#include &lt;stdio.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;stdint.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;string.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;arpa/inet.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;errno.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;linux/netfilter/nf_tables.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;linux/netfilter/abcde.h&gt;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#include "internal.h"</span></div><div class="line"><span class="addition">+#include &lt;libmnl/libmnl.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;libnftnl/expr.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;libnftnl/rule.h&gt;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct nftnl_expr_abcde &#123;</span></div><div class="line"><span class="addition">+	const char		*text;</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_set(struct nftnl_expr *e, uint16_t type,</span></div><div class="line"><span class="addition">+				 const void *data, uint32_t data_len)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	switch(type)&#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		abcde-&gt;text = strdup(data);</span></div><div class="line"><span class="addition">+		if (!abcde-&gt;text)</span></div><div class="line"><span class="addition">+			return -1;</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static const void *</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_get(const struct nftnl_expr *e, uint16_t type,</span></div><div class="line"><span class="addition">+		      uint32_t *data_len)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		*data_len = strlen(abcde-&gt;text)+1;</span></div><div class="line"><span class="addition">+		return abcde-&gt;text;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return NULL;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_cb(const struct nlattr *attr, void *data)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	const struct nlattr **tb = data;</span></div><div class="line"><span class="addition">+	int type = mnl_attr_get_type(attr);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (mnl_attr_type_valid(attr, NFTA_ABCDE_MAX) &lt; 0)</span></div><div class="line"><span class="addition">+		return MNL_CB_OK;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		if (mnl_attr_validate(attr, MNL_TYPE_STRING) &lt; 0)</span></div><div class="line"><span class="addition">+			abi_breakage();</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	tb[type] = attr;</span></div><div class="line"><span class="addition">+	return MNL_CB_OK;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_build(struct nlmsghdr *nlh, const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT))</span></div><div class="line"><span class="addition">+		mnl_attr_put_strz(nlh, NFTNL_EXPR_ABCDE_TEXT, abcde-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_parse(struct nftnl_expr *e, struct nlattr *attr)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	struct nlattr *tb[NFTA_ABCDE_MAX+1] = &#123;&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (mnl_attr_parse_nested(attr, nftnl_expr_abcde_cb, tb) &lt; 0)</span></div><div class="line"><span class="addition">+		return -1;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (tb[NFTNL_EXPR_ABCDE_TEXT]) &#123;</span></div><div class="line"><span class="addition">+		if (abcde-&gt;text)</span></div><div class="line"><span class="addition">+			xfree(abcde-&gt;text);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+		abcde-&gt;text = strdup(mnl_attr_get_str(tb[NFTNL_EXPR_ABCDE_TEXT]));</span></div><div class="line"><span class="addition">+		if (!abcde-&gt;text)</span></div><div class="line"><span class="addition">+			return -1;</span></div><div class="line"><span class="addition">+		e-&gt;flags |= (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_json_parse(struct nftnl_expr *e, json_t *root,</span></div><div class="line"><span class="addition">+					struct nftnl_parse_err *err)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+#ifdef JSON_PARSING</span></div><div class="line"><span class="addition">+	const char *text;</span></div><div class="line"><span class="addition">+	uint16_t group, qthreshold;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	text = nftnl_jansson_parse_str(root, "text", err);</span></div><div class="line"><span class="addition">+	if (text != NULL)</span></div><div class="line"><span class="addition">+		nftnl_expr_set_str(e, NFTNL_EXPR_ABCDE_TEXT, text);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+#else</span></div><div class="line"><span class="addition">+	errno = EOPNOTSUPP;</span></div><div class="line"><span class="addition">+	return -1;</span></div><div class="line"><span class="addition">+#endif</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_snprintf_default(char *buf, size_t size,</span></div><div class="line"><span class="addition">+					   const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	int ret, offset = 0, len = size;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT)) &#123;</span></div><div class="line"><span class="addition">+		ret = snprintf(buf, len, "text %s ", abcde-&gt;text);</span></div><div class="line"><span class="addition">+		SNPRINTF_BUFFER_SIZE(ret, size, len, offset);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return offset;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_export(char *buf, size_t size,</span></div><div class="line"><span class="addition">+				 const struct nftnl_expr *e, int type)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	NFTNL_BUF_INIT(b, buf, size);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT))</span></div><div class="line"><span class="addition">+		nftnl_buf_str(&amp;b, type, abcde-&gt;text, "text");</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return nftnl_buf_done(&amp;b);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_snprintf(char *buf, size_t len, uint32_t type,</span></div><div class="line"><span class="addition">+			uint32_t flags, const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_DEFAULT:</span></div><div class="line"><span class="addition">+		return nftnl_expr_abcde_snprintf_default(buf, len, e);</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_XML:</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_JSON:</span></div><div class="line"><span class="addition">+		return nftnl_expr_abcde_export(buf, len, e, type);</span></div><div class="line"><span class="addition">+	default:</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return -1;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void nftnl_expr_abcde_free(const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	xfree(abcde-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static bool nftnl_expr_abcde_cmp(const struct nftnl_expr *e1,</span></div><div class="line"><span class="addition">+				     const struct nftnl_expr *e2)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *l1 = nftnl_expr_data(e1);</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *l2 = nftnl_expr_data(e2);</span></div><div class="line"><span class="addition">+	return !strcmp(l1-&gt;text, l2-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct expr_ops expr_ops_abcde = &#123;</span></div><div class="line"><span class="addition">+	.name		= "abcde",</span></div><div class="line"><span class="addition">+	.alloc_len	= sizeof(struct nftnl_expr_abcde),</span></div><div class="line"><span class="addition">+	.max_attr	= NFTA_ABCDE_MAX,</span></div><div class="line"><span class="addition">+	.free		= nftnl_expr_abcde_free,</span></div><div class="line"><span class="addition">+	.cmp		= nftnl_expr_abcde_cmp,</span></div><div class="line"><span class="addition">+	.set		= nftnl_expr_abcde_set,</span></div><div class="line"><span class="addition">+	.get		= nftnl_expr_abcde_get,</span></div><div class="line"><span class="addition">+	.parse		= nftnl_expr_abcde_parse,</span></div><div class="line"><span class="addition">+	.build		= nftnl_expr_abcde_build,</span></div><div class="line"><span class="addition">+	.snprintf	= nftnl_expr_abcde_snprintf,</span></div><div class="line"><span class="addition">+	.json_parse	= nftnl_expr_abcde_json_parse,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line">diff --git a/src/expr_ops.c b/src/expr_ops.c</div><div class="line">index 7a0e1e3..a02878c 100644</div><div class="line"><span class="comment">--- a/src/expr_ops.c</span></div><div class="line"><span class="comment">+++ b/src/expr_ops.c</span></div><div class="line">@@ -33,6 +33,7 @@ extern struct expr_ops expr_ops_target;</div><div class="line"> extern struct expr_ops expr_ops_dynset;</div><div class="line"> extern struct expr_ops expr_ops_hash;</div><div class="line"> extern struct expr_ops expr_ops_fib;</div><div class="line"><span class="addition">+extern struct expr_ops expr_ops_abcde;</span></div><div class="line"></div><div class="line"> static struct expr_ops expr_ops_notrack = &#123;</div><div class="line"> 	.name	= "notrack",</div><div class="line">@@ -69,6 +70,7 @@ static struct expr_ops *expr_ops[] = &#123;</div><div class="line"> 	&amp;expr_ops_hash,</div><div class="line"> 	&amp;expr_ops_fib,</div><div class="line"> 	&amp;expr_ops_objref,</div><div class="line"><span class="addition">+	&amp;expr_ops_abcde,</span></div><div class="line"> 	NULL,</div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>
<p>The abcde branch of nftables and libnftnl can be found at GitHub:<br><a href="https://github.com/zasdfgbnm/nftables/tree/abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/nftables/tree/abcde</a><br><a href="https://github.com/zasdfgbnm/libnftnl/tree/abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/libnftnl/tree/abcde</a></p>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>Our new module can be tested by inserting our module, and then using our self-compiled nft tool to add a rule that looks like:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PREFIX=/home/gaoxiang/tmp/test_nftables</div><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$PREFIX</span>/lib</div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add table ip <span class="built_in">test</span></div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add chain <span class="built_in">test</span> <span class="built_in">test</span> \&#123; <span class="built_in">type</span> filter hook postrouting priority 0\; \&#125;</div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add rule ip <span class="built_in">test</span> <span class="built_in">test</span> tcp sport 4000 abcde darkhttpd <span class="built_in">log</span> prefix <span class="string">"darkhttpd___"</span></div></pre></td></tr></table></figure></p>
<p>Open a darkhttpd server, access to it, and the output of <code>dmesg</code> will looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[ 2427.056229] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=43690 RES=0x00 ACK SYN URGP=0</div><div class="line">[ 2427.094038] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9012 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK URGP=0</div><div class="line">[ 2427.094162] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=269 TOS=0x00 PREC=0x00 TTL=64 ID=9013 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.094216] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=97 TOS=0x00 PREC=0x00 TTL=64 ID=9014 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.361198] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=246 TOS=0x00 PREC=0x00 TTL=64 ID=9015 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.361215] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=258 TOS=0x00 PREC=0x00 TTL=64 ID=9016 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2475.658088] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9017 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div><div class="line">[ 2521.747363] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9018 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div><div class="line">[ 2567.826378] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9019 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div></pre></td></tr></table></figure></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/Kernel/" rel="tag"># Kernel</a>
          
            <a href="/tags/nftables/" rel="tag"># nftables</a>
          
            <a href="/tags/network/" rel="tag"># network</a>
          
            <a href="/tags/netfilter/" rel="tag"># netfilter</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/06/Rademacher复杂度学习笔记/" rel="next" title="Rademacher复杂度学习笔记">
                <i class="fa fa-chevron-left"></i> Rademacher复杂度学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/28/把docker镜像当作桌面系统来用/" rel="prev" title="把docker镜像当作桌面系统来用">
                把docker镜像当作桌面系统来用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>





    <div class="post-spread">
      
    </div>

  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="zasdfgbnm" />
          <p class="site-author-name" itemprop="name">zasdfgbnm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zasdfgbnm" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Starting-point-of-kernel-code"><span class="nav-number">2.</span> <span class="nav-text">Starting point of kernel code</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-usage-of-kernel-API"><span class="nav-number">3.</span> <span class="nav-text">The usage of kernel API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-nft-expr-ops"><span class="nav-number">3.1.</span> <span class="nav-text">struct nft_expr_ops</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-nft-expr-type"><span class="nav-number">3.2.</span> <span class="nav-text">struct nft_expr_type</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary-on-kernel-codes"><span class="nav-number">4.</span> <span class="nav-text">Summary on kernel codes</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Writing-our-own-kernel-code"><span class="nav-number">5.</span> <span class="nav-text">Writing our own kernel code</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Modify-user-space-tool"><span class="nav-number">6.</span> <span class="nav-text">Modify user space tool</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Test"><span class="nav-number">7.</span> <span class="nav-text">Test</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zasdfgbnm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zasdfgbnm-github-io.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/';
          this.page.identifier = '2017/09/07/Extending-nftables/';
          this.page.title = 'Adding new expressions to nftables';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zasdfgbnm-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
