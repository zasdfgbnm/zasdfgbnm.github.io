<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zasdfgbnm</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zasdfgbnm.github.io/"/>
  <updated>2018-09-26T15:42:34.190Z</updated>
  <id>https://zasdfgbnm.github.io/</id>
  
  <author>
    <name>zasdfgbnm</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PyTorch JIT Source Code Read Note</title>
    <link href="https://zasdfgbnm.github.io/2018/09/20/PyTorch-JIT-Source-Code-Read-Note/"/>
    <id>https://zasdfgbnm.github.io/2018/09/20/PyTorch-JIT-Source-Code-Read-Note/</id>
    <published>2018-09-21T00:12:21.000Z</published>
    <updated>2018-09-26T15:42:34.190Z</updated>
    
    <content type="html"><![CDATA[<p>This is my note for reading PyTorch’s JIT source. We begin by looking at <code>torch.jit.script</code> and <code>torch.jit.script_method</code> to find the frontend that compiles the Python code into PyTorch’s tree views, and the backend that compiles tree views to graph. We also read the structure of the internal representation of PyTorch’s graph. Finally we go to graph executor to look at how the computation graph is further compiled into instructions and how the action of these instructions are defined and executed.</p>
<a id="more"></a>
<p>PyTorch is under very active development. So the PyTorch’s source code at the time the reader reading this article won’t be the same as when I wrote this article. To get the same source code as in this article, the readers could run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout 76ab26cc3eff1d7ba822d8db93723f5c9598eead</div></pre></td></tr></table></figure>
<h1 id="Starting-point-scrip-and-script-method"><a href="#Starting-point-scrip-and-script-method" class="headerlink" title="Starting point: scrip and script_method"></a>Starting point: scrip and script_method</h1><p>In PyTorch, a Python function can be just-in-time compiled by doing something like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@torch.jit.script</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + x</div></pre></td></tr></table></figure>
<p>the <code>torch.jit.script</code> is a decorator of your function <code>f</code>. If you are unfamiliar with Python’s decorator, please refer to <a href="https://realPython.com/primer-on-Python-decorators/" target="_blank" rel="noopener">this article</a>.</p>
<p>It is also possible to create a module with its method JIT compiled by doing something like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span><span class="params">(torch.jit.ScriptModule)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @torch.jit.script_method</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(self.x)</span>:</span></div><div class="line">        <span class="keyword">return</span> x * x</div><div class="line"></div><div class="line"><span class="meta">    @torch.jit.script_method</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></div><div class="line">        <span class="keyword">return</span> x + self.f(x)</div></pre></td></tr></table></figure>
<h2 id="Scripting-a-function"><a href="#Scripting-a-function" class="headerlink" title="Scripting a function"></a>Scripting a function</h2><p>We will start by looking at <code>torch.jit.script</code>. To read <code>torch.jit.script</code>, we begin by looking at <code>torch/jit/__init__.py</code>. To quickly locate <code>script</code>, search <code>def script</code> in your editor, and you will immediately find it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">script</span><span class="params">(fn, optimize=True, _frames_up=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _enabled:</div><div class="line">        <span class="keyword">return</span> fn</div><div class="line">    rcb = createResolutionCallback(_frames_up + <span class="number">1</span>)</div><div class="line">    ast = get_jit_ast(fn, is_method=<span class="keyword">False</span>)</div><div class="line">    graph = _jit_script_compile(ast, rcb)</div><div class="line">    mod = ScriptModule()</div><div class="line">    mod._create_method_from_graph(<span class="string">'forward'</span>, graph)</div><div class="line">    <span class="comment"># <span class="doctag">TODO:</span> refactor everything so we're not 1) creating a ScriptModule</span></div><div class="line">    <span class="comment"># 2) Throwing everything away except for the graph 3) Creating a new</span></div><div class="line">    <span class="comment"># ScriptModule and dumping that graph in 4) Re-populating the schema</span></div><div class="line">    <span class="comment"># because it was lost doing the previous</span></div><div class="line">    mod.__getattr__(<span class="string">'forward'</span>).forward_schema(ast, <span class="keyword">False</span>)</div><div class="line">    <span class="comment"># Forward docstrings</span></div><div class="line">    mod.__doc__ = fn.__doc__</div><div class="line">    <span class="keyword">return</span> mod</div></pre></td></tr></table></figure>
<p>In the beginning, <code>createResolutionCallback</code> is called. This function is defined in the same file. The source code tells us that it just returns a function that maps names to its values in the scope of the caller of <code>script</code>, this would be used later in C++ to read values from Python.</p>
<p>The <code>get_jit_ast</code> in next line is imported from <code>torch.jit.frontend</code>. From the name of this function and its owning module, we can tell that this is the frontend of PyTorch’s JIT compiler that compiles the source code of the scripted function into abstract syntax tree(AST).</p>
<p>The next line uses <code>_jit_script_compile</code> to compiles the AST obtained in the previous step into computation graph. By searching <code>_jit_script_compile</code>, we find something that reads: <code>torch._C._jit_script_compile</code>, which tells us that <code>_jit_script_compile</code> is implemented in C++.</p>
<p>The next couple lines basically create a <code>ScriptModule</code> whose <code>forward</code> method is the compiled graph.</p>
<h2 id="Scripting-a-module"><a href="#Scripting-a-module" class="headerlink" title="Scripting a module"></a>Scripting a module</h2><p>We start by looking at <code>torch.jit.script_method</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ScriptMethodStub = namedtuple(<span class="string">'ScriptMethodStub'</span>, (<span class="string">'resolution_callback'</span>, <span class="string">'def_'</span>, <span class="string">'original_method'</span>))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">script_method</span><span class="params">(fn)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _enabled:</div><div class="line">        <span class="keyword">return</span> fn</div><div class="line">    <span class="comment"># ...</span></div><div class="line">    rcb = createResolutionCallback(frames_up=<span class="number">2</span>)</div><div class="line">    ast = get_jit_ast(fn, is_method=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">return</span> ScriptMethodStub(rcb, ast, fn)</div></pre></td></tr></table></figure>
<p>This is similar to <code>script</code>, but instead of creating and returning a module and put the compiled function into its <code>forward</code> method, it simply use a named tuple to store the resolution callback, AST and the original function.</p>
<p>This can not be the end of the story because a named tuple can never be called to do the computation. So there must be some magic somewhere that replace the named tuples with something that actually do the job. For readers familiar with Python’s class meta-programming, it’s not hard to imagine how the magic happens. For those not familiar with class meta-programming, I would refer to the book <a href="http://shop.oreilly.com/product/0636920032519.do" target="_blank" rel="noopener">Fluent Python</a>. I will explain a bit of detail on that:</p>
<p>In Python, everything is an object, and a class itself is not an exception. Classes in Python are objects of a special type of classes called meta-class. During import time, when Python see the following code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span><span class="params">(torch.jit.ScriptModule)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @torch.jit.script_method</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(self.x)</span>:</span></div><div class="line">        <span class="keyword">return</span> x * x</div><div class="line"></div><div class="line"><span class="meta">    @torch.jit.script_method</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></div><div class="line">        <span class="keyword">return</span> x + self.f(x)</div></pre></td></tr></table></figure>
<p>It will execute the body of the class definition, that is: compile the <code>return x * x</code>, create an function object with that compiled code, pass this function object to <code>torch.jit.script_method</code>, and set the returned named tuple as <code>f</code>. Then do the same thing for <code>forward</code>. After that, Python will have a map of attribute names and values of the class to be constructed. This map will then be passed to the meta-class of <code>MyModule</code> to actually construct <code>MyModule</code> as an instance of that meta-class.</p>
<p>To know in detail how this is achieved in PyTorch, we should take a look at <code>ScriptMeta</code> and <code>ScriptModule</code>. These two classes are lengthy, so I will not copy their full code here, but to use pseudocode to show what is done:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScriptMeta</span><span class="params">(type<span class="params">(torch._C.ScriptModule)</span>)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        <span class="comment"># delete all ScriptMethodStub</span></div><div class="line"></div><div class="line"><span class="meta">        @functools.wraps(original_init)</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">init_then_register</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">            <span class="comment"># invoke the original __init__</span></div><div class="line">            self._create_methods(defs, rcbs)</div><div class="line"></div><div class="line">        cls.__init__ = init_then_register</div><div class="line">        <span class="keyword">return</span> super(ScriptMeta, cls).__init__(name, bases, attrs)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScriptModule</span><span class="params">(with_metaclass<span class="params">(ScriptMeta, torch._C.ScriptModule, Module)</span>)</span>:</span></div><div class="line">    <span class="comment"># ......</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._has_method(attr):</div><div class="line">            <span class="comment"># ......</span></div><div class="line">            <span class="keyword">return</span> self._get_method(attr)</div><div class="line">        <span class="comment"># .....</span></div><div class="line">        <span class="keyword">return</span> Module.__getattr__(self, attr)</div></pre></td></tr></table></figure>
<p>In the above pseudocode, <code>_create_methods</code>, <code>_has_method</code>, and <code>_get_method</code> are inherited from <code>torch._C.ScriptModule</code>. So a natural question to ask is then: what does <code>torch._C.ScriptModule</code> do? Before answering this question, let’s first take a look at the frontend.</p>
<h1 id="The-frontend"><a href="#The-frontend" class="headerlink" title="The frontend"></a>The frontend</h1><p>A good starting point of the frontend is the <code>get_jit_ast</code> we just saw. This function is defined at <code>torch/jit/frontend.py</code>. The code is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_jit_ast</span><span class="params">(fn, is_method)</span>:</span></div><div class="line">    source = dedent(inspect.getsource(fn))</div><div class="line">    py_ast = ast.parse(source)</div><div class="line">    <span class="keyword">if</span> len(py_ast.body) != <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> isinstance(py_ast.body[<span class="number">0</span>], ast.FunctionDef):</div><div class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">"expected a single top-level function"</span>)</div><div class="line">    type_line = torch.jit.annotations.get_type_line(source)</div><div class="line">    ctx = SourceContext(source, _uses_true_division(fn))</div><div class="line">    <span class="keyword">return</span> build_def(ctx, py_ast.body[<span class="number">0</span>], type_line, is_method)</div></pre></td></tr></table></figure>
<p>The first 4 lines of function body just use the standard tools provided by Python, <code>dedent</code>, <code>inspect</code>, and <code>ast</code>, to construct the Python AST, and do some check to make sure the thing being compiled is “a single top-level function”.</p>
<p>The following line <code>type_line = torch.jit.annotations.get_type_line(source)</code> is interesting. After looking at <code>torch/jit/annotations.py</code>, we can see that PyTorch’s JIT allows the user to specify the type of arguments and return value by writing something like <code># type: (Tensor, torch.Tensor) -&gt; Tuple[Tensor, Tensor]</code>.</p>
<p>In the next line <code>ctx = SourceContext(source, _uses_true_division(fn))</code>, the <code>_uses_true_division</code> is defined in the same file to handle the different behavior of <code>/</code> in Python2 with or without <code>from __future__ import division</code> (see <a href="https://www.Python.org/dev/peps/pep-0238/" target="_blank" rel="noopener">PEP 238</a> for the difference). The <code>SourceContext</code> is also defined in the same file. It is a subclass of <code>SourceRangeFactory</code> with additional field to store if the division is true division. The <code>SourceRangeFactory</code> is imported by <code>from torch._C._jit_tree_views import *</code>. After reading its definition at <code>torch/csrc/jit/script/python_tree_views.cpp</code>, we can see that this is basically a class designed to store the range of source code, e.g. where in the source code a token is located.</p>
<p>The core is the <code>build_def</code> in the last line, so we move on:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_def</span><span class="params">(ctx, py_def, type_line, is_method)</span>:</span></div><div class="line">    returns = []</div><div class="line">    ret_body = []</div><div class="line">    body = py_def.body</div><div class="line">    r = ctx.make_range(py_def.lineno, py_def.col_offset,</div><div class="line">                       py_def.col_offset + len(<span class="string">"def"</span>))</div><div class="line">    param_list = build_param_list(ctx, py_def.args)</div><div class="line">    return_type = <span class="keyword">None</span></div><div class="line">    <span class="keyword">if</span> getattr(py_def, <span class="string">'returns'</span>, <span class="keyword">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        return_type = build_expr(ctx, py_def.returns)</div><div class="line">    decl = Decl(r, param_list, return_type)</div><div class="line">    <span class="keyword">if</span> type_line <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        type_comment_decl = torch._C.parse_type_comment(type_line)</div><div class="line">        decl = torch._C.merge_type_from_type_comment(decl, type_comment_decl, is_method)</div><div class="line">    <span class="keyword">return</span> Def(Ident(r, py_def.name),</div><div class="line">               decl,</div><div class="line">               build_stmts(ctx, body))</div></pre></td></tr></table></figure>
<p>Reading through this, we can see that what basically this does is to convert the Python’s AST into the internal representation. Names like <code>Decl</code>, <code>Def</code>, <code>Ident</code> are all imported by <code>from torch._C._jit_tree_views import *</code>. In the last line, we can see that the function body is constructed by <code>build_stmts</code>, so let’s go further to read <code>build_stmts</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_stmts</span><span class="params">(ctx, stmts)</span>:</span></div><div class="line">    stmts = [build_stmt(ctx, s) <span class="keyword">for</span> s <span class="keyword">in</span> stmts]</div><div class="line">    <span class="keyword">return</span> list(filter(<span class="keyword">None</span>, stmts))</div></pre></td></tr></table></figure>
<p>This is a very simple function: call <code>build_stmt</code> for each item and filter out those not needed. But what is <code>build_stmt</code>? It is defined as: <code>build_stmt = StmtBuilder()</code>. The definition of <code>StmtBuilder</code> looks like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StmtBuilder</span><span class="params">(Builder)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_Expr</span><span class="params">(ctx, stmt)</span>:</span></div><div class="line">        value = stmt.value</div><div class="line">        <span class="keyword">if</span> value.__class__.__name__ == <span class="string">'Str'</span>:</div><div class="line">            <span class="comment"># If a statement is a string literal expression,</span></div><div class="line">            <span class="comment"># then it is a docstring. Just ignore it.</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> ExprStmt([build_expr(ctx, value)])</div><div class="line">    <span class="comment"># ...</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_assign_lhs_expr</span><span class="params">(ctx, expr)</span>:</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_Assign</span><span class="params">(ctx, stmt)</span>:</span></div><div class="line">        <span class="comment">#...</span></div><div class="line">    <span class="comment"># ......</span></div></pre></td></tr></table></figure>
<p>We can see that, this is a class with many static methods that define what to do for different types of Python AST. I will not go deep into how each type is handled. Since at this point, the readers should be able to catch all the details on how each type of nodes in Python AST are dealt with by themselves. So We will stop our frontend reading right here.</p>
<h1 id="ScriptModule-and-ScriptMethod"><a href="#ScriptModule-and-ScriptMethod" class="headerlink" title="ScriptModule and ScriptMethod"></a>ScriptModule and ScriptMethod</h1><p>To find where <code>ScriptModule</code> in C++ is defined, run <code>grep &#39;ScriptModule&#39; -r torch/csrc/</code> and you will locate it at <code>torch/csrc/jit/script/init.cpp</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// torch.jit.ScriptModule is a subclass of this C++ object.</span></div><div class="line"><span class="comment">// Methods here are prefixed with _ since they should not be</span></div><div class="line"><span class="comment">// public.</span></div><div class="line">py::class_&lt;Module, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Module&gt;&gt;(m, <span class="string">"ScriptModule"</span>)</div><div class="line">    .def(py::init&lt;&gt;())</div><div class="line">    .def(<span class="string">"save"</span>, &amp;Module::save)</div><div class="line">    .def(<span class="string">"_set_optimized"</span>, &amp;Module::set_optimized)</div><div class="line">    .def(</div><div class="line">        <span class="string">"_define"</span>,</div><div class="line">        [](<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Module&gt; m,</div><div class="line">            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; script,</div><div class="line">            ResolutionCallback rcb, <span class="keyword">bool</span> has_self) &#123;</div><div class="line">          <span class="keyword">auto</span> self = has_self ? <span class="built_in">std</span>::make_shared&lt;ModuleValue&gt;(m) : <span class="literal">nullptr</span>;</div><div class="line">          <span class="keyword">return</span> defineMethodsInModule(*m, script, pythonResolver(rcb), self);</div><div class="line">        &#125;)</div><div class="line">    .def(<span class="string">"_create_methods"</span>, [](<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Module&gt; m, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Def&gt;&amp; defs, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ResolutionCallback&gt;&amp; rcbs) &#123;</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Resolver&gt; resolvers;</div><div class="line">      <span class="keyword">for</span>(<span class="keyword">auto</span> &amp; callback : rcbs) &#123;</div><div class="line">        resolvers.push_back(pythonResolver(callback));</div><div class="line">      &#125;</div><div class="line">      defineMethodsInModule(</div><div class="line">        *m,</div><div class="line">        defs,</div><div class="line">        resolvers,</div><div class="line">        <span class="built_in">std</span>::make_shared&lt;ModuleValue&gt;(m));</div><div class="line">    &#125;)</div><div class="line">    .def(<span class="string">"_get_method"</span>,</div><div class="line">    [](Module&amp; self, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name) -&gt; <span class="keyword">const</span> Method&amp; &#123;</div><div class="line">      <span class="keyword">return</span> self.get_method(name);</div><div class="line">    &#125;, py::return_value_policy::reference_internal)</div><div class="line">    <span class="comment">//.def more ...</span></div><div class="line"></div><div class="line">py::class_&lt;Method&gt;(m, <span class="string">"ScriptMethod"</span>, py::dynamic_attr())</div><div class="line">    .def(<span class="string">"graph"</span>, [&amp;](Method&amp; self) &#123;</div><div class="line">      <span class="keyword">return</span> self.graph();</div><div class="line">    &#125;)</div><div class="line">    .def(<span class="string">"__call__"</span>, invokeScriptMethodFromPython)</div><div class="line">    <span class="comment">//.def more ...</span></div></pre></td></tr></table></figure>
<p>We can see that <code>ScriptModule</code> is basically a binding for the C++ class <code>Module</code>. By skim through the list of methods defined here, we can see that it has methods for adding, getting, and checking existence of methods, parameters, submodules, buffers, etc. The class for methods is <code>Method</code>, which binds to Python as <code>ScriptMethod</code>. Methods in modules are created by <code>defineMethodsInModule</code> and invoked by <code>invokeScriptMethodFromPython</code>. <code>defineMethodsInModule</code> is a bit complicated, and we will postpone its reading to the backend compiler part of this article. But <code>invokeScriptMethodFromPython</code> is very simple. Searching with <code>grep</code>, we can easily find its definition in <code>torch/csrc/jit/pybind_utils.h</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> py::<span class="function">object <span class="title">invokeScriptMethodFromPython</span><span class="params">(</span></span></div><div class="line">    script::Method&amp; method,</div><div class="line">    py::args args, py::kwargs kwargs) &#123;</div><div class="line">  <span class="keyword">auto</span> <span class="built_in">stack</span> = createStackForSchema(method.getSchema(), <span class="built_in">std</span>::move(args), <span class="built_in">std</span>::move(kwargs));</div><div class="line">  &#123;</div><div class="line">    AutoNoGIL no_gil_guard;</div><div class="line">    method.run(<span class="built_in">stack</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> createPyObjectForStack(<span class="built_in">std</span>::move(<span class="built_in">stack</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We can easily tell that it just create a stack from the input parameters, invoke <code>Method::run</code> to consume elements on the stack as input and leave the output of graph on the stack, and finally convert elements on the stack into Python objects.</p>
<p>Now let’s move on to <code>Module</code> and <code>Method</code>. It’s easy to guess from the name that these classes are defined at <code>torch/csrc/jit/script/module.{h,cpp}</code>. Read through these two files, we would see that <code>Module</code> is just a container of things: it just uses ordered dictionary to store methods, parameters and submodules, and provide methods to access or run them.</p>
<p>What <code>Method</code> does is more interesting. One important thing that the designer of <code>Method</code> must worry about is, since methods have access to not only its arguments, but also other class members of the same object, there must be a mechanism for such kind of access. We will see how this is handled very soon. From its constructor, we can see that a method can be created either from the graph and initial class members directly, or from a method creator. The method creator is invoked lazily, i.e. it is not invoked inside the constructor, but wait until someone call <code>ensure_defined</code>. The following member functions of <code>Method</code> defines how an object of <code>Method</code> is run:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(Stack &amp; <span class="built_in">stack</span>)</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span>(at::Tensor* tp : member_inputs) &#123;</div><div class="line">    <span class="built_in">stack</span>.push_back(*tp);</div><div class="line">  &#125;</div><div class="line">  get_executor().run(<span class="built_in">stack</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">IValue <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;IValue&gt; <span class="built_in">stack</span>)</span> </span>&#123;</div><div class="line">  checkInputsAgainstSchema(<span class="built_in">stack</span>);</div><div class="line">  run(<span class="built_in">stack</span>);</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">stack</span>.size() != <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">return</span> Tuple::create(<span class="built_in">std</span>::move(<span class="built_in">stack</span>));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">stack</span>.front();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>By looking at the types of names appearing in the above code, we can see that: graph is an object of <code>Graph</code>, and the virtual machine that execute the graph is an object of <code>GraphExecutor</code>. <code>GraphExecutor</code> operate on data type <code>IValue</code>, and its stack is a <code>vector</code> of that data type. To run a method, one need to first push the arguments onto the stack, and invoke <code>Method::run</code>, which will further push other member inputs onto the stack, and invoke <code>GraphExecutor::run</code> to run the graph. The graph executor will leave its output on the stack.</p>
<p>At this point, we still don’t know how things like <code>Graph</code> and <code>GraphExecutor</code> works, but before looking deep into that, let’s pause a little bit to take a look at the backend compiler.</p>
<h1 id="From-Python-AST-to-PyTorch-IR-part-1"><a href="#From-Python-AST-to-PyTorch-IR-part-1" class="headerlink" title="From Python AST to PyTorch IR: part 1"></a>From Python AST to PyTorch IR: part 1</h1><p>Now let’s move on to read <code>_jit_script_compile</code>. To find where it is located, simply run the command <code>grep _jit_script_compile -r .</code>. We will find something like:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./torch/csrc/jit/script/init.cpp:  m.def(<span class="string">"_jit_script_compile"</span>, [](<span class="keyword">const</span> Def &amp;def, ResolutionCallback rcb) &#123;</div></pre></td></tr></table></figure>
<p>So, <code>torch/csrc/jit/script/init.cpp</code> would be a good start point. The complete definition of <code>_jit_script_compile</code> is:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">m.def(<span class="string">"_jit_script_compile"</span>, [](<span class="keyword">const</span> Def &amp;def, ResolutionCallback rcb) &#123;</div><div class="line">  <span class="keyword">return</span> compileFunction(def, PythonResolver(rcb));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So, let’s move on to <code>compileFunction</code>. Using grep to search, we would find its definition in <code>torch/csrc/jit/script/compiler.cpp</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; compileFunction(Def def, <span class="keyword">const</span> Resolver&amp; resolver) &#123;</div><div class="line">  Module m;</div><div class="line">  defineMethodsInModule(m, &#123;def&#125;, &#123;resolver&#125;, <span class="literal">nullptr</span>);</div><div class="line">  <span class="keyword">return</span> m.get_method(def.name().name()).graph();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We see the <code>defineMethodsInModule</code> that we saw before on the definition of Python bindings for <code>Module</code>. Move on to <code>defineMethodsInModule</code>, on the same file:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">defineMethodsInModule</span><span class="params">(Module &amp; m, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Def&gt;&amp; definitions, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Resolver&gt;&amp; resolvers, SugaredValuePtr self)</span> </span>&#123;</div><div class="line">  <span class="comment">// ......</span></div><div class="line">  <span class="keyword">for</span>(Def def : definitions) &#123;</div><div class="line">    <span class="comment">// ......</span></div><div class="line">    <span class="keyword">auto</span> creator = [def, &amp;table, resolver, self](Method&amp; method) &#123;</div><div class="line">      to_ir(def, table, resolver, self,  method);</div><div class="line">    &#125;;</div><div class="line">    Method&amp; method = m.create_method(name, creator);</div><div class="line">    <span class="comment">// ......</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ......</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Less important parts of the code is omitted. From above, we can find that the core of compiling an AST into a compute graph is done at <code>to_ir</code>. Skimming through <code>to_ir</code> we find that it is a struct of ~1000 lines of code, with member functions that handles different cases of Python AST. Without knowing PyTorch’s IR, it’s not easy to understand what <code>to_ir</code> does. So let’s pause a little bit to take a look at PyTorch IR and come back later.</p>
<h1 id="The-PyTorch-IR"><a href="#The-PyTorch-IR" class="headerlink" title="The PyTorch IR"></a>The PyTorch IR</h1><p>A good starting point is the class <code>Graph</code>, located at <code>torch/csrc/jit/ir.h</code>. Skimming through this file, as well as <code>to_ir</code>, we keep seeing things like <code>aten::mul</code>, <code>prim::Constant</code>. What are they? They seems to be very relevant, actually they seems to be <strong>the node</strong> in the graph. By doing some <code>grep</code> search, we find a good document of them at <code>torch/csrc/jit/interned_strings.h</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 'prim' symbols are synthetic operators that occur only in the IR</span></div><div class="line"><span class="comment">// and don't have corresponding implementations in ATen.</span></div><div class="line"></div><div class="line"><span class="comment">// 'onnx' symbols correspond to ONNX operators.  Their semantics</span></div><div class="line"><span class="comment">// are defined in https://github.com/onnx/onnx/blob/master/docs/Operators.md</span></div><div class="line"><span class="comment">// The particular version we are targeting is specified by '_onnx_opset_version'</span></div><div class="line"><span class="comment">// in torch.onnx.symbolic</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// In general, most ONNX operators won't get an entry here, because they</span></div><div class="line"><span class="comment">// are handled from the Python end.  However, you may occasionally need</span></div><div class="line"><span class="comment">// to intern an ONNX symbol here so that you can conveniently write an</span></div><div class="line"><span class="comment">// optimization on ONNX operations.</span></div><div class="line"></div><div class="line"><span class="comment">// 'attr' symbols are attribute keys.  They are shared between both ONNX and ATen</span></div><div class="line"><span class="comment">// operators (you disambiguate their meaning by looking at the operator itself).</span></div><div class="line"><span class="comment">// In general, you only need to define attribute keys that are used by</span></div><div class="line"><span class="comment">// onnx or prim; ATen attributes are automatically generated in FORALL_ATTR_BASE_SYMBOLS.</span></div><div class="line"></div><div class="line"><span class="comment">// Note [Symbol allocation]</span></div><div class="line"><span class="comment">// ~~~~~~~~~~~~~~~~~~~~~~~~</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  1. Symbol namespace is split up into namespaces.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  2. The intended access pattern for built-in symbols is onnx::MatMul</span></div><div class="line"><span class="comment">//  in the torch::jit namespace (this is a Symbol).</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Built-in constant definition strategy:</span></div><div class="line"><span class="comment">// - Enum is the most convenient way to generate a contiguous sequence</span></div><div class="line"><span class="comment">//   of numbers for an identifier.</span></div><div class="line"><span class="comment">// - However, an enum gives you a fresh type.  We want onnx::MatMul to</span></div><div class="line"><span class="comment">//   be type Symbol, not some random enum type!</span></div><div class="line"><span class="comment">// - Therefore, after using enums to generate the sequence of integers,</span></div><div class="line"><span class="comment">//   we then declare constexpr Symbols to get everything the actual Symbol</span></div><div class="line"><span class="comment">//   type we want.  Symbols must be constexpr to be valid to be "case"ed on.</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">unique_t</span> = <span class="keyword">uint32_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> domain_prefix = <span class="string">"org.PyTorch."</span>;</div><div class="line"></div><div class="line"><span class="comment">// A Symbol is like an interned string, but with a little extra</span></div><div class="line"><span class="comment">// structure; it is namespaced via SymbolNamespace and the resulting</span></div><div class="line"><span class="comment">// intern pointers support efficient namespace testing.</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TORCH_API</span> <span class="title">Symbol</span> &#123;</span></div><div class="line"><span class="comment">// more code omitted ......</span></div></pre></td></tr></table></figure>
<p>This very well explains what those things are: they are instances of <code>Symbol</code> to represent operators. Knowing this level of detail about these things is enough for us, so let’s go back to IR.</p>
<p>The beginning of file <code>torch/csrc/jit/ir.h</code> very well explains what things are:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Graph represents one "function" of computation.</span></div><div class="line"><span class="comment">// It uses a simple ownership model where the graph owns all the nodes inside it.</span></div><div class="line"><span class="comment">// All references inside the graph are raw pointers.</span></div><div class="line"><span class="comment">// Destroying the Graph will invalidate any pointers to nodes in the graph.</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Graph</span>;</span></div><div class="line"></div><div class="line"><span class="comment">// Node is the base class of the IR graph. It represents one computation</span></div><div class="line"><span class="comment">// and dependencies on a list of Values. The "prim-ops", so to speak.</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>;</span></div><div class="line"></div><div class="line"><span class="comment">// A Value represents an input or output to node that is either a</span></div><div class="line"><span class="comment">// Tensor or an opaque Handle object, as determined by type().</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Value</span>;</span></div><div class="line"></div><div class="line"><span class="comment">// ......</span></div><div class="line"></div><div class="line"><span class="comment">// A list of nodes, with inputs and outputs</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block</span>;</span></div><div class="line"></div><div class="line"><span class="comment">// Each use is represented by this type, see Node::uses()</span></div><div class="line"><span class="comment">// 'user' is the consumer of the value, offset is the index into</span></div><div class="line"><span class="comment">// 'user's input this where the produces will be found.</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Use</span> &#123;</span></div><div class="line">  Use(Node * user, <span class="keyword">size_t</span> offset)</div><div class="line">  : user(user), offset(offset) &#123;&#125;</div><div class="line">  Node * user;</div><div class="line">  <span class="keyword">size_t</span> offset;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// ......</span></div><div class="line"></div><div class="line"><span class="comment">// Scope is a node of a trie that represents the tree of nested scopes.</span></div><div class="line"><span class="comment">// Individual scopes are pushed and popped from Graph, which holds a</span></div><div class="line"><span class="comment">// pointer to the current scope. Each Node in Graph holds a pointer</span></div><div class="line"><span class="comment">// to the scope that was current when the node was created.</span></div><div class="line"><span class="comment">// The trie never needs to shrink, it only grows until it is disposed</span></div><div class="line"><span class="comment">// of when Graph is deallocated. Hence, pointers to scopes held by nodes</span></div><div class="line"><span class="comment">// will always be valid as long as Graph is alive.</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Scope</span> &#123;</span></div></pre></td></tr></table></figure>
<p>Reading through the whole file, we can summarize how it works:</p>
<p>A <code>Graph</code> object owns all <code>Node</code>s, <code>Value</code>s, and <code>Block</code>s. The internal structure is not maintained by the <code>Graph</code> object, but inside <code>Node</code>s, <code>Value</code>s, and <code>Block</code>s.</p>
<p>Each <code>Node</code> keeps pointers to its input, and output <code>Value</code>s. It also maintains pointers to siblings in a doubly-linked list of <code>Node</code>s. This doubly-linked list is a topological sort of the <code>Node</code>s in the <code>Graph</code>. Each <code>Node</code> has a <code>NodeKind</code> as an object of <code>Symbol</code>. <code>Node</code>s also maintains a pointer to the <code>Block</code> owning this <code>Node</code>, as well as pointers to subblocks.</p>
<p>Each <code>Value</code> must be an output of some <code>Node</code>, and it has a <code>Node</code> pointer pointing to the <code>Node</code> that outputs this <code>Value</code>. It also has a <code>Use</code> list storing where this <code>Value</code> is used as input.</p>
<p>Each <code>Block</code> maintains pointers to its input and output <code>Node</code>s, as well as the <code>Node</code> owning this <code>Block</code>.</p>
<h1 id="From-Python-AST-to-PyTorch-IR-part-2"><a href="#From-Python-AST-to-PyTorch-IR-part-2" class="headerlink" title="From Python AST to PyTorch IR: part 2"></a>From Python AST to PyTorch IR: part 2</h1><p>With the knowledge of IR, let’s go back to read the backend compiler.</p>
<p>In the code in <code>torch/csrc/jit/script/compiler.cpp</code>, we have been seeing <code>SugaredValue</code> many times. What <code>SugaredValue</code> does is explained in <code>torch/csrc/jit/script/compiler.h</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// The AST can contain nodes like `self`, `self.b` or `Python_fn` that</span></div><div class="line"><span class="comment">// are not first-class values in the graph representation, but instead</span></div><div class="line"><span class="comment">// will be desugared based on how they are used in the AST.</span></div><div class="line"></div><div class="line"><span class="comment">// SugaredValue is used to temporarily represent these values in a way</span></div><div class="line"><span class="comment">// that separates their behavior from the AST -&gt; IR converter itself.</span></div><div class="line"><span class="comment">// This allows us to keep dependencies on Python minimal.</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SugaredValue</span> :</span> <span class="keyword">public</span> <span class="built_in">std</span>::enable_shared_from_this&lt;SugaredValue&gt; &#123;</div></pre></td></tr></table></figure>
<p>From the comments above, together with what we see when skimming through the code, we can see that, <code>SugaredValue</code> is a super class of different types of values. These values might be first-class values like tensors or integers, or <code>ScriptModule</code> such as <code>self</code>, or Python modules like <code>torch</code>, or some builtin functions like <code>print</code>. Different types of values are handled by different subclasses: <code>SimpleValue</code> for first class values, <code>BuiltinFunction</code> for operators like <code>aten::relu</code>, <code>BuiltinModule</code> for something like <code>torch</code>, <code>NoneValue</code> for <code>None</code>, <code>PrintValue</code> for <code>print</code>, <code>CastValue</code> for types like <code>int</code>, <code>float</code>, etc. These subclasses listed above are all defined in <code>torch/csrc/jit/script/compiler.{cpp, h}</code>.</p>
<p>Now let’s move on to read the constructor of the struct <code>to_ir</code>. It basically:</p>
<ol>
<li>Read the information of parameters from the Python AST, and set them up in graph.</li>
<li>Call <code>emitStatements</code> to emit IR for function body.</li>
<li>Set up output values for the graph based on the return statement in the end of function body (compiling functions that has a return statement on somewhere other than the end is not supported).</li>
</ol>
<p>In step 1, there is a little bit of trouble that for functions that is a method of some module, the first parameter is always the reference to the object owing this method (aka. the so called “self”). So it requires a little bit of special case when checking against schema. Also, we need to add the identifier for the first parameter to the symbol table (here the symbol table is <code>Environment::value_table</code>, an object of <code>ValueTable</code>). The input to the graph is not only those appears explicitly in the argument list, but also those members access inside the function body. Recall that when we read the code of <code>Method::run</code>, there is a step that push members onto the stack. This issue is not handled here, and we will see how it is handled later.</p>
<p>In step 2, things started to get complicated. In <code>emitStatements</code>, code emitting are dispatched to different specialized private methods of the struct by its type:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">emitStatements</span><span class="params">(List&lt;Stmt&gt;::const_iterator begin, List&lt;Stmt&gt;::const_iterator end)</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span> (; begin != end; ++begin) &#123;</div><div class="line">    <span class="keyword">auto</span> stmt = *begin;</div><div class="line">    <span class="keyword">switch</span> (stmt.kind()) &#123;</div><div class="line">      <span class="keyword">case</span> TK_IF:</div><div class="line">        emitIf(If(stmt));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_WHILE:</div><div class="line">        emitWhile(While(stmt));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_FOR:</div><div class="line">        emitFor(For(stmt));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_ASSIGN:</div><div class="line">        emitAssignment(Assign(stmt));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_GLOBAL:</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> ident : Global(stmt).names()) &#123;</div><div class="line">          <span class="keyword">const</span> <span class="keyword">auto</span>&amp; name = Ident(ident).name();</div><div class="line">          environment_stack-&gt;setVar(ident.range(), name, graph-&gt;addInput(name));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_EXPR_STMT: &#123;</div><div class="line">        <span class="keyword">auto</span> exprs = ExprStmt(stmt).exprs();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; expr : exprs) &#123;</div><div class="line">          emitSugaredExpr(expr, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> TK_RETURN:</div><div class="line">        <span class="keyword">throw</span> ErrorReport(stmt) &lt;&lt; <span class="string">"return statements can appear only at the end "</span></div><div class="line">                                &lt;&lt; <span class="string">"of the function body"</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>There are so many specialized emits, I will not go over these in detail one by one. I will only go deep into <code>emitSugaredExpr</code> as an example here. <code>emitSugaredExpr</code> is defined as follows:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// any expression that can produce a SugaredValue is handled here</span></div><div class="line"><span class="comment">// expressions that only return a single Value* are handled in emitSimpleExpr</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;SugaredValue&gt; emitSugaredExpr(Expr tree, <span class="keyword">size_t</span> n_binders) &#123;</div><div class="line">  <span class="keyword">switch</span>(tree.kind()) &#123;</div><div class="line">    <span class="keyword">case</span> TK_VAR:</div><div class="line">      <span class="keyword">return</span> environment_stack-&gt;getSugaredVar(Var(tree).name());</div><div class="line">    <span class="keyword">case</span> <span class="string">'.'</span>: &#123;</div><div class="line">      <span class="keyword">auto</span> select = Select(tree);</div><div class="line">      <span class="keyword">auto</span> sv = emitSugaredExpr(select.value(), <span class="number">1</span>);</div><div class="line">      <span class="keyword">return</span> sv-&gt;attr(select.range(), method, select.selector().name());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> TK_APPLY: &#123;</div><div class="line">      <span class="keyword">auto</span> apply = Apply(tree);</div><div class="line">      <span class="keyword">auto</span> inputs = getNamedValues(apply.inputs(), <span class="literal">true</span>);</div><div class="line">      <span class="keyword">auto</span> attributes = fmap(apply.attributes(), [&amp;](<span class="keyword">const</span> Attribute&amp; attr) &#123;</div><div class="line">        <span class="keyword">return</span> NamedValue(attr.range(), attr.name().name(), emitExpr(attr.value()));</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// the apply is directly an identifier 'foo'</span></div><div class="line">      <span class="keyword">if</span>(apply.callee().kind() == TK_VAR) &#123;</div><div class="line">        <span class="keyword">return</span> emitApplyIdent(Var(apply.callee()).name(), inputs, attributes, n_binders);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> emitApplyExpr(apply.callee(), inputs, attributes, n_binders);</div><div class="line">    &#125; <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> <span class="built_in">std</span>::make_shared&lt;SimpleValue&gt;(emitSimpleExpr(tree));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>What it does is basically: for cases that guaranteed to produce a <code>SimpleValue</code>, we just call <code>emitSimpleExpr</code> to emit the code, otherwise it must be one of the following three format: <code>foo</code>, <code>foo.bar</code>, <code>foo(bar)</code>. For the <code>foo</code> case, we just lookup <code>foo</code> in the symbol table, for the <code>foo.bar</code> case, we first emit <code>foo</code> and lookup its attribute <code>bar</code>. For the <code>foo(bar)</code> case, depending on whether <code>foo</code> is an identifier or an expression, invoke <code>emitApplyIdent</code> or <code>emitApplyExpr</code> correspondingly to do code emitting.</p>
<p>The <code>self</code> argument of the method is handled a bit differently: there is a subclass of <code>SugaredValue</code> called <code>ModuleValue</code> defined in <code>torch/csrc/jit/script/init.cpp</code>, in its override method <code>attr</code>, we see:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(NamedParameter* v = <span class="keyword">module</span>-&gt;find_parameter(field)) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">std</span>::make_shared&lt;SimpleValue&gt;(m.get_or_add_parameter(v-&gt;slot()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Where the <code>get_or_add_parameter</code> defined in <code>torch/csrc/jit/script/module.h</code> reads:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function">Value * <span class="title">get_or_add_parameter</span><span class="params">(at::Tensor* slot)</span> </span>&#123;</div><div class="line">  <span class="keyword">auto</span> it = member_input_index.find(slot);</div><div class="line">  <span class="keyword">if</span>(it != member_input_index.end()) &#123;</div><div class="line">    <span class="keyword">return</span> graph()-&gt;inputs().at(it-&gt;second);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// add it as a new parameter</span></div><div class="line">  member_inputs.push_back(slot);</div><div class="line">  member_input_index[slot] = graph()-&gt;inputs().size();</div><div class="line">  <span class="keyword">return</span> graph()-&gt;addInput();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That tells us: adding members as parameters of the graph actually happens at code emitting of <code>self.bar</code>, where the <code>attr</code> of <code>ModuleValue</code> called.</p>
<h1 id="The-Graph-Executor"><a href="#The-Graph-Executor" class="headerlink" title="The Graph Executor"></a>The Graph Executor</h1><p>Now we have seen how the compilation is done and what does PyTorch JIT’s IR looks like, the thing left is how the IR are executed. From above we already know that the executor is obtained by invoking <code>Method::get_executor</code> and run by invoking <code>GraphExecutor::run</code>. Let’s first take a look at <code>Method::get_executor</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">GraphExecutor&amp; <span class="title">get_executor</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="built_in">std</span>::call_once(executor_init, [&amp;]&#123;</div><div class="line">    executor = GraphExecutor(graph(), optimize);</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> executor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We know that a graph executor is created from a graph, and does optimization if asked. It’s not hard to guess from name that <code>GraphExecutor</code> is defined in <code>torch/csrc/jit/graph_executor.{h, cpp}</code>.</p>
<p>The constructor and <code>run</code> tells us that <code>GraphExecutor</code> is just a wrapper of <code>GraphExecutorImpl</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GraphExecutor::GraphExecutor(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; graph, <span class="keyword">bool</span> optimize)</div><div class="line">: pImpl(<span class="keyword">new</span> GraphExecutorImpl(<span class="built_in">std</span>::move(graph), optimize)) &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphExecutor::run(Stack &amp; inputs) &#123;</div><div class="line">  <span class="keyword">return</span> pImpl-&gt;run(inputs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So let’s move on to <code>GraphExecutorImpl</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GraphExecutorImpl(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; graph, <span class="keyword">bool</span> optimize)</div><div class="line">  : graph(prepareGraph(graph))</div><div class="line">  , optimize(optimize)</div><div class="line">  , num_inputs(<span class="keyword">this</span>-&gt;graph-&gt;inputs().size())</div><div class="line">  , num_flat_inputs(countFlatInputs(graph))</div><div class="line">  , num_outputs(<span class="keyword">this</span>-&gt;graph-&gt;outputs().size()) &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// entry point where execution begins</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(Stack &amp; <span class="built_in">stack</span>)</span> </span>&#123;</div><div class="line">  AT_CHECK(<span class="built_in">stack</span>.size() &gt;= num_inputs, <span class="string">"expected "</span>, num_inputs, <span class="string">" inputs, but got only "</span>, <span class="built_in">stack</span>.size());</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(tracer::isTracing()) &#123;</div><div class="line">    <span class="keyword">return</span> runTraced(<span class="built_in">stack</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> &amp; execution_plan = optimize ? getOrCompile(<span class="built_in">stack</span>) : getOrCompileFallback();</div><div class="line">  <span class="keyword">return</span> execution_plan.run(<span class="built_in">stack</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We see that the graph is compiled at the first time it runs to get an execution plan. The <code>run</code> method of execution plan is called to run the graph. Compilation of graph to execution plan is done by <code>getOrCompile</code> or <code>getOrCompileFallback</code> depending on if optimization is enabled. These two methods are copied below:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">const ExecutionPlan &amp; getOrCompileFallback() &#123;</div><div class="line">  std::lock_guard&lt;std::mutex&gt; lock(compile_mutex);</div><div class="line">  if(!fallback) &#123;</div><div class="line">    auto graph_ = graph-&gt;copy();</div><div class="line">    runRequiredPasses(graph_);</div><div class="line">    fallback = ExecutionPlan(graph_);</div><div class="line">  &#125;</div><div class="line">  return fallback;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const ExecutionPlan &amp; getOrCompile(const Stack&amp; stack) &#123;</div><div class="line">  // outside lock guard, to minimize the time holding the lock on the fast path</div><div class="line">  // ArgumentSpec even computes its hashCode here.</div><div class="line">  ArgumentSpec spec(autograd::GradMode::is_enabled(), last(stack, num_inputs), num_flat_inputs);</div><div class="line">  &#123;</div><div class="line">    std::lock_guard&lt;std::mutex&gt; lock(compile_mutex);</div><div class="line">    auto it = plan_cache.find(spec);</div><div class="line">    if (it != plan_cache.end())</div><div class="line">      return it-&gt;second;</div><div class="line">    auto plan = compileSpec(spec);</div><div class="line">    auto r = plan_cache.emplace(std::move(spec), std::move(plan));</div><div class="line">    return r.first-&gt;second;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>These code explain itself well: if optimization is turned off, then we only run required passes and cache the result. Otherwise, depending on the characteristic of inputs (<code>ArgumentSpec</code>), we run full optimization and cache the generated plan for each different <code>ArgumentSpec</code>. The plan is created by the constructor of <code>ExecutionPlan</code>.</p>
<p>It worth a look at what passes are called:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function">ExecutionPlan <span class="title">compileSpec</span><span class="params">(<span class="keyword">const</span> ArgumentSpec &amp; spec)</span> </span>&#123;</div><div class="line">  <span class="keyword">auto</span> opt_graph = graph-&gt;copy();</div><div class="line">  setInputTypes(*opt_graph, spec);</div><div class="line"></div><div class="line">  <span class="comment">// Phase 1. Specialize to input definedness (this is very important for</span></div><div class="line">  <span class="comment">//          gradient graphs), and run required passes to bring the graph</span></div><div class="line">  <span class="comment">//          to an executable form.</span></div><div class="line">  runRequiredPasses(opt_graph);</div><div class="line"></div><div class="line">  <span class="comment">// Phase 2. Propagate detailed information about the spec through the</span></div><div class="line">  <span class="comment">//          graph (enabled more specializations in later passes).</span></div><div class="line">  <span class="comment">//          Shape propagation sometimes depends on certain arguments being</span></div><div class="line">  <span class="comment">//          constants, and constant propagation doesn't need shape information</span></div><div class="line">  <span class="comment">//          anyway, so it's better to run it first.</span></div><div class="line">  ConstantPropagation(opt_graph);</div><div class="line">  PropagateInputShapes(*opt_graph);</div><div class="line">  PropagateRequiresGrad(opt_graph);</div><div class="line"></div><div class="line">  <span class="comment">// Phase 3. Run differentiable optimizations (i.e. simple graph rewrites that</span></div><div class="line">  <span class="comment">//          we can still execute using autograd).</span></div><div class="line">  runOptimization(opt_graph, spec);</div><div class="line"></div><div class="line">  <span class="comment">// Phase 4. If this graph will be differentiated, we need to slice out the</span></div><div class="line">  <span class="comment">//          symbolically differentiable subgraphs for further optimizations.</span></div><div class="line">  <span class="comment">// Phase 5. Apply non-differentiable optimizations to the graphs we've found</span></div><div class="line">  <span class="comment">//          (or the whole grpah if we know we won't need its derivative).</span></div><div class="line">  <span class="keyword">if</span> (needsGradient(opt_graph)) &#123;</div><div class="line">    <span class="keyword">auto</span> diff_nodes = CreateAutodiffSubgraphs(*opt_graph);</div><div class="line">    <span class="keyword">for</span> (Node * dnode : diff_nodes) &#123;</div><div class="line">      <span class="keyword">auto</span> diff_graph = <span class="built_in">std</span>::move(dnode-&gt;g(attr::Subgraph));</div><div class="line">      Gradient gradient = differentiate(diff_graph);</div><div class="line">      runNondiffOptimization(gradient.f);</div><div class="line">      packGradient(gradient, dnode);</div><div class="line">    &#125;</div><div class="line">    InlineAutodiffSubgraphs(opt_graph);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    runNondiffOptimization(opt_graph);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Make sure there are no leftovers from any passes.</span></div><div class="line">  EliminateDeadCode(opt_graph);</div><div class="line">  <span class="keyword">return</span> ExecutionPlan(opt_graph);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">runOptimization</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt;&amp; graph, <span class="keyword">const</span> ArgumentSpec&amp; spec)</span> </span>&#123;</div><div class="line">  EliminateDeadCode(graph);</div><div class="line">  EliminateCommonSubexpression(graph);</div><div class="line">  UnrollLoops(graph);</div><div class="line">  PeepholeOptimize(graph);</div><div class="line">  CheckInplace(graph);</div><div class="line">  BatchMM(graph);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNondiffOptimization</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt;&amp; graph)</span> </span>&#123;</div><div class="line">  FuseGraph(graph);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ......</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">runRequiredPasses</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt;&amp; g)</span>  </span>&#123;</div><div class="line">  specializeUndef(*g);</div><div class="line">  LowerGradOf(*g);</div><div class="line">  <span class="comment">// implicit inserted expand nodes are not necessarily always valid</span></div><div class="line">  <span class="comment">// when used inside script methods that might have unstable shapes</span></div><div class="line">  <span class="comment">// we remove the implicitly created ones, and have shape analysis</span></div><div class="line">  <span class="comment">// add valid expand nodes when the shapes are stable</span></div><div class="line">  RemoveExpands(g);</div><div class="line">  CanonicalizeOps(g);</div><div class="line">  EliminateDeadCode(g);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I will not go deep into these passes here, interested readers can read them at <code>torch/csrc/jit/passes/</code>.</p>
<p>Now it’s time to look at <code>ExecutionPlan</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ExecutionPlan</span> &#123;</span></div><div class="line">  ExecutionPlan() = <span class="keyword">default</span>;</div><div class="line">  ExecutionPlan(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; graph)</div><div class="line">    : code(graph)</div><div class="line">    , graph(<span class="built_in">std</span>::move(graph)) &#123;&#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(Stack&amp; <span class="built_in">stack</span>)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> InterpreterState(code).runOneStage(<span class="built_in">stack</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">bool</span>&gt;(graph);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">ExecutionPlanState <span class="title">getDebugState</span><span class="params">()</span> </span>&#123;</div><div class="line">    ExecutionPlanState state;</div><div class="line">    state.code = &amp;code;</div><div class="line">    state.graph = graph.get();</div><div class="line">    <span class="keyword">return</span> state;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Code code;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; graph;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>It just convert the graph into an object of <code>Code</code>, and the running is done by <code>InterpreterState</code>.</p>
<h1 id="Compiling-to-Interpreter-Instructions"><a href="#Compiling-to-Interpreter-Instructions" class="headerlink" title="Compiling to Interpreter Instructions"></a>Compiling to Interpreter Instructions</h1><p><code>Code</code> and <code>InterpreterState</code> are defined in <code>torch/csrc/jit/interpreter.{h,cpp}</code>. These two classes are just a wrapper of its implementations:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Code::Code(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt;&amp; graph)</div><div class="line">    : pImpl(<span class="keyword">new</span> CodeImpl(graph)) &#123;&#125;</div><div class="line">Code::~Code() = <span class="keyword">default</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;GraphExecutor*&gt;&amp; Code::grad_executors() &#123;</div><div class="line">  <span class="keyword">return</span> pImpl-&gt;grad_executors();</div><div class="line">&#125;</div><div class="line"></div><div class="line">InterpreterState::InterpreterState(<span class="keyword">const</span> Code &amp; code)</div><div class="line">  : pImpl(<span class="keyword">new</span> InterpreterStateImpl(code)) &#123;&#125;</div><div class="line">InterpreterState::~InterpreterState() = <span class="keyword">default</span>;</div><div class="line"></div><div class="line"><span class="keyword">void</span> InterpreterState::runOneStage(Stack &amp; <span class="built_in">stack</span>) &#123;</div><div class="line">  <span class="keyword">return</span> pImpl-&gt;runOneStage(<span class="built_in">stack</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CodeImpl</code> is a long struct, but quite logical. A selected list of fields it has is listed below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PreprocessGraph preprocess;</div><div class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Instruction&gt; instructions;</div></pre></td></tr></table></figure>
<p>Its constructor is:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CodeImpl(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt;&amp; graph_)</div><div class="line">    : preprocess(*graph_) &#123;</div><div class="line">  graph = preprocess.graph;</div><div class="line">  <span class="comment">// std::cout &lt;&lt; "into code graph:\n" &lt;&lt; *graph &lt;&lt; "\n";</span></div><div class="line">  insertNodesFromBlock(graph-&gt;block());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Clearly we can see what it does is: 1. preprocess the graph, and then 2. emit instructions for interpreter.</p>
<p>The preprocessing of graph is very well explained in the beginning of file:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Before we translate to intepreter instructions, we do</span></div><div class="line"><span class="comment">// some preprocessing of the graph to turn it into a form that is closer</span></div><div class="line"><span class="comment">// to what the instructions will look like.</span></div><div class="line"><span class="comment">// In particular we:</span></div><div class="line"><span class="comment">// * (TODO) desugar Loop trip counts into c = 0, c += 1 instructions in the loop</span></div><div class="line"><span class="comment">// * flatten stages so that each stage starts with a load from the stack</span></div><div class="line"><span class="comment">//   and ends with a store to the stack</span></div><div class="line"><span class="comment">// *. computes move_flags (see Outputs), and inserts</span></div><div class="line"><span class="comment">// *  Drop nodes are inserted for any node that is unused to create a dummy use</span></div><div class="line"><span class="comment">//    that will cause the interpreter to free the node.</span></div><div class="line"><span class="comment">//    A drop node is just a node with no outputs that just pops its inputs off the stack,</span></div><div class="line"><span class="comment">//    to ensure the interpreter release references to nodes that are never used.</span></div><div class="line"><span class="comment">//    Drop nodes are also inserted when the last use of a node is in some conditionally</span></div><div class="line"><span class="comment">//    run control flow (e.g. one side of an If) and the interpreter must free</span></div><div class="line"><span class="comment">//    the node only after the control flow has reconverged</span></div><div class="line"><span class="comment">// Outputs are:</span></div><div class="line"><span class="comment">// * graph - the post processed copy of g</span></div><div class="line"><span class="comment">// * move_flags[n] - a list of booleans, one for each input,</span></div><div class="line"><span class="comment">//   indicating whether this is the last use of the value. The interpreter</span></div><div class="line"><span class="comment">//   should generate a move rather than a copy in this case.</span></div><div class="line"><span class="comment">// * stage_input_types: the type annotations on the inputs to each stage</span></div><div class="line"><span class="comment">//   these can be removed once the the backward tracer is no longer used</span></div></pre></td></tr></table></figure>
<p>as well as in its definition</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PreprocessGraph</span> &#123;</span></div><div class="line">  PreprocessGraph(Graph &amp; g)</div><div class="line">  : graph(g.copy()) &#123;</div><div class="line">    desugarTripCounts(graph-&gt;block());</div><div class="line">    stage_input_types = flattenStages(*graph);</div><div class="line">    dropUnused(graph-&gt;block());</div><div class="line">    <span class="comment">// fill in move_flags by scanning blocks;</span></div><div class="line">    move_flags = findLastUses(*graph);</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span> desugar Loop trip counts, for now we drop trip counts</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Outputs of the preprocessing:</span></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Graph&gt; graph;</div><div class="line">  <span class="comment">// for each input, should we move rather than copy the inputs</span></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;Node*, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;&gt; move_flags;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TypePtr&gt;&gt; stage_input_types;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>The <code>insertNodesFromBlock</code> emits instructions. It is also very self-explained:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertNodesFromBlock</span><span class="params">(Block* block)</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> node : block-&gt;nodes()) &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp; source_location = node-&gt;getSourceLocation();</div><div class="line">    <span class="keyword">switch</span>(node-&gt;kind()) &#123;</div><div class="line">      <span class="keyword">case</span> prim::If: &#123;</div><div class="line">        <span class="comment">// x = if c:</span></div><div class="line">        <span class="comment">//   &lt;then_block&gt;</span></div><div class="line">        <span class="comment">//   -&gt; (vt)</span></div><div class="line">        <span class="comment">// else:</span></div><div class="line">        <span class="comment">//    &lt;else_block&gt;</span></div><div class="line">        <span class="comment">//   -&gt; (vf)</span></div><div class="line"></div><div class="line">        <span class="comment">// turns into:</span></div><div class="line">        <span class="comment">//   JumpNZ c, then</span></div><div class="line">        <span class="comment">//   &lt;else_block&gt;</span></div><div class="line">        <span class="comment">//   x = vf</span></div><div class="line">        <span class="comment">//   Jump end</span></div><div class="line">        <span class="comment">// then:</span></div><div class="line">        <span class="comment">//   &lt;then_block&gt;</span></div><div class="line">        <span class="comment">//   x = vt</span></div><div class="line">        <span class="comment">// end:</span></div><div class="line"></div><div class="line">        <span class="comment">// prim::Placeholder instructions are replaced with branch instructions</span></div><div class="line">        <span class="comment">// when the branch target locations are known</span></div><div class="line">        <span class="keyword">auto</span> cond_branch = insertInstruction(prim::Placeholder, source_location, node-&gt;inputs(), moveFlags(node), &#123;&#125;);</div><div class="line">        <span class="keyword">auto</span> then_block = node-&gt;blocks()[<span class="number">0</span>];</div><div class="line">        <span class="keyword">auto</span> else_block = node-&gt;blocks()[<span class="number">1</span>];</div><div class="line">        insertNodesFromBlock(else_block);</div><div class="line">        insertAssign(source_location,else_block-&gt;outputs(), moveFlags(else_block), node-&gt;outputs());</div><div class="line">        <span class="keyword">auto</span> jump = insertInstruction(prim::Placeholder, source_location, &#123;&#125;, &#123;&#125;, &#123;&#125;);</div><div class="line">        <span class="keyword">auto</span> then_block_start = instructions.size();</div><div class="line">        insertNodesFromBlock(then_block);</div><div class="line">        insertAssign(source_location, then_block-&gt;outputs(), moveFlags(then_block), node-&gt;outputs());</div><div class="line">        createJump(jump, instructions.size());</div><div class="line">        createJumpNZ(cond_branch, then_block_start);</div><div class="line">      &#125; <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> prim::Loop: &#123;</div><div class="line">        <span class="comment">// omitted ......</span></div><div class="line">      &#125; <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>: &#123;</div><div class="line">        insertInstruction(node);</div><div class="line">      &#125; <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// each stage ends with a load instruction</span></div><div class="line">    <span class="comment">// we record where these instructions occur, and use them to</span></div><div class="line">    <span class="comment">// exit the interpreter</span></div><div class="line">    <span class="keyword">if</span>(node-&gt;kind() == prim::Load) &#123;</div><div class="line">      stage_end.push_back(instructions.size());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Since the nodes are topologically sorted, we just need to iterate the linked list and generate code for each node.</p>
<h1 id="The-Virtual-Machine"><a href="#The-Virtual-Machine" class="headerlink" title="The Virtual Machine"></a>The Virtual Machine</h1><p><code>InterpreterStateImpl</code> is the virtual machine that executes instructions.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">InterpreterStateImpl(<span class="keyword">const</span> Code &amp; code)</div><div class="line">: function(code.pImpl),</div><div class="line">  int_data(function-&gt;int_data.data()),</div><div class="line">  bool_data(function-&gt;bool_data),</div><div class="line">  registers(function-&gt;register_size) &#123;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">runOneStage</span><span class="params">(Stack &amp; <span class="built_in">stack</span>)</span> </span>&#123;</div><div class="line">  <span class="comment">// std::cout &lt;&lt; "running stage: " &lt;&lt; current_stage &lt;&lt; " of " &lt;&lt; function-&gt;stage_end.size() &lt;&lt; "\n";</span></div><div class="line">  <span class="comment">// std::cout &lt;&lt; *function-&gt;graph &lt;&lt; "\n";</span></div><div class="line">  <span class="comment">// function-&gt;dump(std::cout);</span></div><div class="line">  <span class="keyword">size_t</span> pc = current_pc;</div><div class="line">  <span class="keyword">size_t</span> last = function-&gt;stage_end[current_stage];</div><div class="line">  <span class="keyword">auto</span> &amp; instructions = function-&gt;instructions;</div><div class="line">  <span class="keyword">while</span>(pc &lt; last) &#123;</div><div class="line">      <span class="comment">// std::cout &lt;&lt; "executing " &lt;&lt; pc &lt;&lt; ": ";</span></div><div class="line">      <span class="comment">// function-&gt;dumpInstruction(std::cout, pc);</span></div><div class="line">      <span class="comment">// std::cout &lt;&lt; "\n";</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">auto</span> &amp; inst = instructions[pc];</div><div class="line">        loadTensorsFromRegisters(inst.inputs, <span class="built_in">stack</span>);</div><div class="line">        <span class="keyword">size_t</span> new_pc = pc + <span class="number">1</span> + inst.callback(<span class="built_in">stack</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = inst.outputs.size - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">          <span class="keyword">int</span> reg = get(inst.outputs,i);</div><div class="line">          registers[reg] = pop(<span class="built_in">stack</span>);</div><div class="line">          <span class="comment">// std::cout &lt;&lt; "pop reg[" &lt;&lt; reg &lt;&lt; "];\n" &lt;&lt; registers[reg].pImpl &lt;&lt; "\n";</span></div><div class="line">        &#125;</div><div class="line">        pc = new_pc;</div><div class="line">      &#125; <span class="keyword">catch</span>(<span class="built_in">std</span>::exception &amp; e) &#123;</div><div class="line">        <span class="keyword">if</span>(!instructions[pc].debug_location)</div><div class="line">          <span class="keyword">throw</span>; <span class="comment">// rethrow original exception</span></div><div class="line">        <span class="comment">// throw a new exception with enhanced debugging information</span></div><div class="line">        instructions[pc].debug_location-&gt;wrapAndRethrowException(e, <span class="string">"operation failed in interpreter"</span>);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  current_pc = pc;</div><div class="line">  current_stage++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>There is nothing special, just mimicking the behavior of processors. We can easily tell from the above code that the actions is defined at <code>Instruction::callback</code> and branching is implemented as returning a non-zero value from that callback function. Some of the callbacks are defined inside <code>CodeImpl</code>, such as:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// jump when input is not 0</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createJumpNZ</span><span class="params">(<span class="keyword">int</span> from_inst, <span class="keyword">int</span> to_inst)</span> </span>&#123;</div><div class="line">  <span class="keyword">auto</span> &amp; inst = instructions[from_inst];</div><div class="line">  JIT_ASSERT(inst.debug_name == prim::Placeholder);</div><div class="line">  <span class="keyword">auto</span> offset = relativeJump(from_inst, to_inst);</div><div class="line">  inst.callback = [offset](Stack &amp; <span class="built_in">stack</span>) &#123;</div><div class="line">    <span class="keyword">auto</span> t = pop(<span class="built_in">stack</span>).toInt();</div><div class="line">    <span class="keyword">return</span> (t != <span class="number">0</span>) ? offset : <span class="number">0</span>;</div><div class="line">  &#125;;</div><div class="line">  inst.debug_name = prim::JumpNZ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>while others are defined by its node kind:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> insertInstruction(Node * n) &#123;</div><div class="line">  <span class="keyword">auto</span> inst = insertInstruction(n-&gt;kind(), n-&gt;getSourceLocation(), n-&gt;inputs(), moveFlags(n) , n-&gt;outputs());</div><div class="line">  instructions[inst].callback = getOperation(n);</div><div class="line">  <span class="keyword">return</span> inst;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>where <code>getOperation</code> is defined in <code>torch/csrc/jit/operator.{h, cpp}</code>. Further reading through these two files, we can see that operations are registered by calling <code>registerOperator</code>, which is done through calling <code>RegisterOperators</code>. Using <code>grep RegisterOperators -r torch/csrc/</code>, we can locate the definition of all operations:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">torch/csrc/jit/generated/register_aten_ops.cpp:RegisterOperators reg(&#123;</div><div class="line">torch/csrc/jit/fusers/common/fusion_handle_impl.cpp:RegisterOperators reg_fused_operators(&#123;</div><div class="line">torch/csrc/jit/custom_operator.h:/// so in the global scope when a `RegisterOperators` object is assigned to a</div><div class="line">torch/csrc/jit/custom_operator.h:struct TORCH_API RegisterOperators &#123;</div><div class="line">torch/csrc/jit/custom_operator.h:  RegisterOperators() = default;</div><div class="line">torch/csrc/jit/custom_operator.h:  RegisterOperators(std::vector&lt;Operator&gt; operators) &#123;</div><div class="line">torch/csrc/jit/custom_operator.h:  RegisterOperators(const std::string&amp; name, Implementation&amp;&amp; implementation) &#123;</div><div class="line">torch/csrc/jit/custom_operator.h:  RegisterOperators&amp; op(</div><div class="line">torch/csrc/jit/Python_interpreter.cpp:RegisterOperators reg(&#123;</div><div class="line">torch/csrc/jit/register_special_ops.cpp:RegisterOperators reg(&#123;</div><div class="line">torch/csrc/jit/graph_executor.cpp:RegisterOperators reg_graph_executor_ops(&#123;</div><div class="line">torch/csrc/jit/constants.cpp:RegisterOperators reg(&#123;</div><div class="line">torch/csrc/jit/register_prim_ops.cpp:RegisterOperators reg(&#123;</div><div class="line">torch/csrc/jit/register_prim_ops.cpp:RegisterOperators reg2(&#123;</div><div class="line">torch/csrc/jit/test_jit.cpp:    RegisterOperators reg(&#123;createOperator(</div><div class="line">torch/csrc/jit/test_jit.cpp:    RegisterOperators reg(&#123;createOperator(</div><div class="line">torch/csrc/jit/test_jit.cpp:    RegisterOperators reg(&#123;createOperator(</div><div class="line">torch/csrc/jit/test_jit.cpp:    RegisterOperators reg(</div></pre></td></tr></table></figure>
<p>At this point, we are done with getting the whole big picture of PyTorch’s JIT. It’s time to stop here, and interested readers can read the code by themselves for more details.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This is my note for reading PyTorch’s JIT source. We begin by looking at &lt;code&gt;torch.jit.script&lt;/code&gt; and &lt;code&gt;torch.jit.script_method&lt;/code&gt; to find the frontend that compiles the Python code into PyTorch’s tree views, and the backend that compiles tree views to graph. We also read the structure of the internal representation of PyTorch’s graph. Finally we go to graph executor to look at how the computation graph is further compiled into instructions and how the action of these instructions are defined and executed.&lt;/p&gt;
    
    </summary>
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="PyTorch" scheme="https://zasdfgbnm.github.io/tags/PyTorch/"/>
    
      <category term="深度学习" scheme="https://zasdfgbnm.github.io/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>从头开始阅读PyTorch代码 -- Operators篇</title>
    <link href="https://zasdfgbnm.github.io/2018/06/11/%E4%BB%8E%E5%A4%B4%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BBPyTorch%E4%BB%A3%E7%A0%81%20--%20Operators%E7%AF%87/"/>
    <id>https://zasdfgbnm.github.io/2018/06/11/从头开始阅读PyTorch代码 -- Operators篇/</id>
    <published>2018-06-11T12:50:00.000Z</published>
    <updated>2018-07-10T03:46:10.784Z</updated>
    
    <content type="html"><![CDATA[<p>这篇是阅读PyTorch源代码整理的笔记，方便以后翻阅。这里主要是想知道PyTorch的operators的定义都是怎么组织的，以及如果要添加新的operator的话，该怎么做。</p>
<a id="more"></a>
<p>由于pytorch开发非常活跃，代码也在不断地更改，本文内容跟读者实际看到的最新的代码肯定也有所区别。如果读者想要查看作者写文时候的代码，可以在pytorch仓库中:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout 14cbd9adb8efafbd51444fdd88d6a34e6438b1c5</div></pre></td></tr></table></figure></p>
<h1 id="init-py跟setup-py"><a href="#init-py跟setup-py" class="headerlink" title="__init__.py跟setup.py"></a><code>__init__.py</code>跟<code>setup.py</code></h1><p>比较不错的着手点是<code>torch</code>这个模块的<code>__init__.py</code>跟安装用的<code>setup.py</code>。 把两个文件都浏览一遍有个大体的概念。然后在<code>__init__.py</code>里面搜<code>__all__</code>，通过观察这些operators是怎么被添加到<code>__all__</code>里面去的，就能知道我们用的所有的那些个operators是怎么来的了。</p>
<p>搜<code>__all__</code>发现的关键的一段是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> torch._C <span class="keyword">import</span> *</div><div class="line"></div><div class="line">__all__ += [name <span class="keyword">for</span> name <span class="keyword">in</span> dir(_C)</div><div class="line">            <span class="keyword">if</span> name[<span class="number">0</span>] != <span class="string">'_'</span> <span class="keyword">and</span></div><div class="line">            <span class="keyword">not</span> name.endswith(<span class="string">'Base'</span>)]</div></pre></td></tr></table></figure></p>
<p>这段干的事情就是把<code>torch._C</code>中定义的各种东西按需加入<code>__all__</code>里面去，所以要想知道哪些operators是怎么来的，还是需要去看<code>torch._C</code>。从名字一看就知道，<code>torch._C</code>这个东西，是PyTorch的用C/C++之类的语言写的那一部分。这就涉及到这一部分是怎么构建的了，这个要从<code>setup.py</code>里面翻找，发现的相关的代码段如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">main_sources = [</div><div class="line">    <span class="string">"torch/csrc/PtrWrapper.cpp"</span>,</div><div class="line">    <span class="comment">#......</span></div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">#.....</span></div><div class="line"></div><div class="line">extensions = []</div><div class="line">packages = find_packages(exclude=(<span class="string">'tools'</span>, <span class="string">'tools.*'</span>, <span class="string">'caffe2'</span>, <span class="string">'caffe2.*'</span>, <span class="string">'caffe'</span>, <span class="string">'caffe.*'</span>))</div><div class="line">C = Extension(<span class="string">"torch._C"</span>,</div><div class="line">              libraries=main_libraries,</div><div class="line">              sources=main_sources,</div><div class="line">              language=<span class="string">'c++'</span>,</div><div class="line">              extra_compile_args=main_compile_args + extra_compile_args,</div><div class="line">              include_dirs=include_dirs,</div><div class="line">              library_dirs=library_dirs,</div><div class="line">              extra_link_args=extra_link_args + main_link_args + [make_relative_rpath(<span class="string">'lib'</span>)],</div><div class="line">              )</div><div class="line">extensions.append(C)</div></pre></td></tr></table></figure></p>
<p>基本上就可以断定<code>torch._C</code>这个东西就是从<code>torch/csrc/</code>这个目录里面的一大堆文件编译出来的了。<code>torch/csrc/</code>里面文件一大堆，从哪里着手是个问题。因为<code>torch._C</code>是python的一个模块，那么肯定得有地方通过python的C-binding创建这个模块才是，这就是个不错的着手点。要找到这个模块是从哪里创建的，这时候就要祭出grep大法了，在<code>torch/csrc/</code>这个目录里面运行这样一条命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'torch._C'</span> -r .</div></pre></td></tr></table></figure></p>
<p>就可以得到所有有关的代码行了，发现的最像的一行是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./Module.cpp:  ASSERT_TRUE(module = Py_InitModule(&quot;torch._C&quot;, methods.data()));</div></pre></td></tr></table></figure></p>
<p>这一行一看就是在初始化这个模块，而且文件名叫做<code>Module.cpp</code>也很符合，那下一步就从这里开始好了。<code>__init__.py</code>跟<code>setup.py</code>也可以退出我们的历史舞台了。</p>
<p>另外要注意，在施展grep大法之前，一定要先把PyTorch给编译一遍，因为PyTorch的很多代码是编译的时候根据其他文件生成的，带着生成的文件一起查找比较好。</p>
<h1 id="Module-cpp跟autograd"><a href="#Module-cpp跟autograd" class="headerlink" title="Module.cpp跟autograd"></a><code>Module.cpp</code>跟autograd</h1><p>把这个文件从头到尾浏览一遍，基本上就可以断定初始化模块是在<code>initModule</code>里面完成的了，这个函数里面初始化了一大堆东西，主要还是找找具体的哪一行是负责初始化那堆operators的。注意到<code>initModule</code>里面有好多类似<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WITH_CUDA</span></div><div class="line">  <span class="comment">// do something ....</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>这种，这种就可以直接跳过不读了，因为不管你是否启用了这一堆的feature，那些个operators都是存在的，那就当你没启用这堆好了。还有一堆东西，看名字就不相关，就直接不用搭理了。所以到最后基本上筛选出来的看起来可能是的也只有：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">THPUtils_addPyMethodDefs(methods, TorchMethods);</div><div class="line">THPUtils_addPyMethodDefs(methods, torch::autograd::python_functions());</div><div class="line"><span class="comment">//....</span></div><div class="line">ASSERT_TRUE(THPVariable_initModule(<span class="keyword">module</span>));</div><div class="line">ASSERT_TRUE(THPFunction_initModule(<span class="keyword">module</span>));</div></pre></td></tr></table></figure></p>
<p>那就先从<code>TorchMethods</code>看起，这个东西就定义在<code>Module.cpp</code>里面，看一眼就会知道跟operators没啥关系。<code>torch::autograd::python_functions()</code>这个东西，使用grep大法，可以发现他的定义位于<code>torch/csrc/autograd/init.cpp</code>，也不是啥想要的，继续看<code>THPVariable_initModule</code>，使用grep大法，就会发现这个函数是在<code>torch/csrc/autograd/python_variable.cpp</code>里面定义的，翻看一下这个函数的定义，注意到下面这行：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">THPUtils_addPyMethodDefs(methods, torch::autograd::variable_methods);</div></pre></td></tr></table></figure></p>
<p>整个函数定义里面，也只有这一行最像是定义operators的了，于是继续深挖，继续使用grep大法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep variable_methods -r .</div></pre></td></tr></table></figure>
<p>就会发现这个变量是定义在<code>torch/csrc/</code>下的<code>autograd/generated/python_variable_methods.cpp</code>里面的，打开看看，发现如下的内容：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PyMethodDef variable_methods[] = &#123;</div><div class="line">  &#123;<span class="string">"__add__"</span>, (PyCFunction)THPVariable_add, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</div><div class="line">  <span class="comment">//......</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这就是一个长长的列表，列举了所有的的operators，每个operator对应一个<code>THPVariable_</code>开头的函数定义在同一个文件里面，而这个文件的开头，则说明了这个文件是从<code>tools/autograd/templates/python_variable_methods.cpp</code>这个模板生成而来。</p>
<p>浏览一下所有的<code>THPVariable_</code>开头的函数，就会发现所有的不同的这些个函数都大同小异，基本上核心部分只有下面的内容：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wrap(dispatch_xxxxx(...));</div></pre></td></tr></table></figure></p>
<p>其中<code>dispatch_xxxxx</code>应该就是<code>xxxxx</code>这个operator的核心实现部分。继续动用grep大法挖，只需要随便挑选一个operator搜索就行了，例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep dispatch_acos -r .</div></pre></td></tr></table></figure></p>
<p>搜了就会发现这些个<code>dispatch_</code>开头的函数，是定义在同目录以下的<code>python_variable_methods_dispatch.h</code>文件里面的。翻开这个文件，浏览一下这些dispatch函数的定义，都大同小异，下面摘录其中一个：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">inline</span> Tensor <span class="title">dispatch_add</span><span class="params">(Tensor &amp; self, Scalar alpha, <span class="keyword">const</span> Tensor &amp; other)</span> </span>&#123;</div><div class="line"></div><div class="line">  AutoNoGIL no_gil;</div><div class="line">  <span class="function">AutoGPU <span class="title">auto_gpu</span><span class="params">(self)</span></span>;</div><div class="line">  <span class="keyword">return</span> self.add(other, alpha);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从代码发现，这些个operator，实际上是<code>Tensor</code>这个类的成员函数，所以我们就知道，下一步应该挖的，就是<code>Tensor</code>这个类了。除此以外，还有一个很重要的东西就是搞明白代码生成的原理，这样就能知道代码生成器是怎样找到这些operators的定义，进而生成这些函数的了。</p>
<p>Tensor这个类的出处在<code>python_variable_methods_dispatch.h</code>文件的头部可以找到：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> at::Tensor;</div></pre></td></tr></table></figure></p>
<p>由此可见Tensor是ATen里面定义的，由此看来autograd也基本要退出我们的历史舞台了，轮到ATen登场了。</p>
<h1 id="ATen"><a href="#ATen" class="headerlink" title="ATen"></a>ATen</h1><p>要学习ATen其实非常简单，在<code>aten</code>目录里面乱扒乱翻一通，挨个文件夹都点开瞅两眼，把所有的<code>README.md</code>都读一遍，就会发现，实际上ATen的算符是怎么定义的，实际上，已经在<code>aten/src/ATen/native/README.md</code>文件中，进行了非常详细的说明。</p>
<p>综合各个<code>README.md</code>的信息，并简单总结一下，就是：PyTorch的算符，都是定义在ATen里面的，而ATen里面的算符的实现，一部分是从老的Lua Torch继承而来，这一部分的代码，位于<code>aten/src/TH*</code>这些个目录里面，这些都是历史遗留的遗产，继承过来直接用，并不是PyTorch最终想要的operator的实现方式。最终“好”的实现方式，是在<code>aten/src/ATen/native/</code>目录里面。很多算符，也已经在这个目录下，被重新实现了一遍。这些老的算符的列表，是在<code>aten/src/ATen/Declarations.cwrap</code>中定义的。而新的算符的列表的定义，是在<code>aten/src/ATen/native/native_functions.yaml</code>中。本文只去探讨新的算符的实现方式。</p>
<p>到了这里，想要继续扒一下新的算符实现的，就需要去扒一下<code>native_functions.yaml</code>这个文件是怎么被读取的了。在PyTorch的根目录下，继续用grep大法，搜索关键字<code>native_functions.yaml</code>，得到的结果中，一条看起来很像是我们想要的结果的是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./aten/src/ATen/gen.py:    native_files = filter_by_extension(options.files, &apos;native_functions.yaml&apos;)</div></pre></td></tr></table></figure></p>
<p>打开<code>gen.py</code>这个文件查看，就会发现下面比较有趣的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TEMPLATE_PATH = options.source_path + <span class="string">"/templates"</span></div><div class="line"><span class="comment"># ......</span></div><div class="line">TENSOR_DERIVED_H = CodeTemplate.from_file(TEMPLATE_PATH + <span class="string">"/TensorDerived.h"</span>)</div><div class="line">TENSOR_H = CodeTemplate.from_file(TEMPLATE_PATH + <span class="string">"/Tensor.h"</span>)</div><div class="line">TENSOR_METHODS_H = CodeTemplate.from_file(TEMPLATE_PATH + <span class="string">"/TensorMethods.h"</span>)</div></pre></td></tr></table></figure></p>
<p>以及：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_outputs</span><span class="params">()</span>:</span></div><div class="line">    cwrap_files = filter_by_extension(options.files, <span class="string">'.cwrap'</span>)</div><div class="line">    nn_files = filter_by_extension(options.files, <span class="string">'nn.yaml'</span>, <span class="string">'.h'</span>)</div><div class="line">    native_files = filter_by_extension(options.files, <span class="string">'native_functions.yaml'</span>)</div><div class="line"></div><div class="line">    declarations = [d</div><div class="line">                    <span class="keyword">for</span> file <span class="keyword">in</span> cwrap_files</div><div class="line">                    <span class="keyword">for</span> d <span class="keyword">in</span> cwrap_parser.parse(file)]</div><div class="line"></div><div class="line">    declarations += nn_parse.run(nn_files)</div><div class="line">    declarations += native_parse.run(native_files)</div><div class="line">    declarations = preprocess_declarations.run(declarations)</div><div class="line">    <span class="comment"># ......</span></div></pre></td></tr></table></figure></p>
<p>继续在这附近翻找上下文，就会发现，ATen的代码生成，是通过<code>gen.py</code>等的Python脚本，解析之前说过的那若干个列表文件，然后根据<code>aten/src/ATen/templates/</code>目录下的文件生成的。这些文件，都是模板，不长，全都浏览一遍就是了。阅读的过程，就会发现非常多的重要信息，比如在<code>Tensor.h</code>中有：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> at &#123;</div><div class="line"><span class="comment">// ......</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tensor</span> :</span> <span class="keyword">public</span> detail::TensorBase &#123;</div><div class="line"><span class="comment">// ......</span></div><div class="line">$&#123;tensor_method_declarations&#125;</div><div class="line"><span class="comment">// ......</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// ......</span></div><div class="line">&#125; <span class="comment">// namespace at</span></div></pre></td></tr></table></figure></p>
<p>以及<code>TensorMethods.h</code>中的：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> at &#123;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> Tensor &amp; Tensor::<span class="keyword">operator</span>=(Tensor <span class="keyword">const</span> &amp; rhs) &amp;&amp; &#123;</div><div class="line">  <span class="keyword">return</span> copy_(rhs);</div><div class="line">&#125;</div><div class="line"><span class="comment">// ......</span></div><div class="line"><span class="comment">// all static inline to allow for inlining of the non-dynamic part of dispatch</span></div><div class="line">$&#123;tensor_method_definitions&#125;</div><div class="line"><span class="comment">// ......</span></div><div class="line">&#125; <span class="comment">// namespace at</span></div></pre></td></tr></table></figure></p>
<p>基本上，上面的看完，就已经知道，Tensor类是怎么定义的了。最后一步，就是看一下<code>tensor_method_definitions</code>是怎么填充的了。</p>
<p>继续动用grep大法扒，在PyTorch的根目录用grep搜索<code>tensor_method_definitions</code>，会得到下面有意思的结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./aten/src/ATen/function_wrapper.py:            top_env[&apos;tensor_method_definitions&apos;].append(</div></pre></td></tr></table></figure></p>
<p>看了这个，直接跳到<code>function_wrapper.py</code>文件去扒，发现下面一段：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> is_method:</div><div class="line">    top_env[<span class="string">'tensor_method_declarations'</span>].append(</div><div class="line">        TENSOR_METHOD_DECLARATION.substitute(env))</div><div class="line">    top_env[<span class="string">'tensor_method_definitions'</span>].append(</div><div class="line">        TENSOR_METHOD_DEFINITION.substitute(env))</div><div class="line">    method_of.append(<span class="string">'Tensor'</span>)</div></pre></td></tr></table></figure></p>
<p>而上面代码中的<code>TENSOR_METHOD_DECLARATION</code>跟<code>TENSOR_METHOD_DEFINITION</code>，就定义在同一个文件中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># add non-virtual declaration to Tensor.h</span></div><div class="line">TENSOR_METHOD_DECLARATION = CodeTemplate(<span class="string">"""\</span></div><div class="line">$&#123;return_type&#125; $&#123;api_name&#125;($&#123;method_formals_with_defaults&#125;)$&#123;const_mark&#125;;</div><div class="line">""")</div><div class="line"><span class="comment"># add non-virtual declaration to Tensor.cpp</span></div><div class="line">TENSOR_METHOD_DEFINITION = CodeTemplate(<span class="string">"""\</span></div><div class="line">inline $&#123;return_type&#125; Tensor::$&#123;api_name&#125;($&#123;method_formals&#125;)$&#123;const_mark&#125; &#123;</div><div class="line">    return type().$&#123;api_name&#125;($&#123;method_actuals&#125;);</div><div class="line">&#125;</div><div class="line">""")</div></pre></td></tr></table></figure></p>
<p>至此，基本上，整个ATen的代码生成，基本上算是扒完了，具体做事情的时候，再去返回这些涉及到的文件查看即可。</p>
<p>本文完结</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇是阅读PyTorch源代码整理的笔记，方便以后翻阅。这里主要是想知道PyTorch的operators的定义都是怎么组织的，以及如果要添加新的operator的话，该怎么做。&lt;/p&gt;
    
    </summary>
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="PyTorch" scheme="https://zasdfgbnm.github.io/tags/PyTorch/"/>
    
      <category term="深度学习" scheme="https://zasdfgbnm.github.io/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Using docker image as your desktop system</title>
    <link href="https://zasdfgbnm.github.io/2017/12/29/Using-docker-image-as-your-desktop-system/"/>
    <id>https://zasdfgbnm.github.io/2017/12/29/Using-docker-image-as-your-desktop-system/</id>
    <published>2017-12-30T01:08:54.000Z</published>
    <updated>2017-12-30T05:22:02.933Z</updated>
    
    <content type="html"><![CDATA[<p>In recent years, docker has created a containerization boom around the world by providing a way to easily create and run application containers. Containers save people from dependency hell by packaging the software with the operating environment it needs. Although docker was designed to be neither an operating system container nor an operating system running directly on the bare metal, docker’s powerful suite of tools will also give us tremendous convenience in managing our desktop system running on bare metal.</p>
<p>Why using docker image as a desktop system is a good idea? Let’s begin with talking about the inconvenience of the normal way how people are managing their desktop systems. Nowadays, most of us has more than one computer, and we want these computers to be “consistent”. Here when I say “consistent”, I mean, for example, I begin writing a document on one computer (say, at home) and am unable to finish it before having to switch to another computer (say, at work). I don’t want to worry about copying it manually to another computer, instead, I want it to be able to magically appear there so I can access it at any time. This is exactly what cloud sync disks like Dropbox do for us.  However, for geeks, what cloud sync disks do is far from enough. For example, you are busy with a project,  which uses a number of programming languages, libraries, and a bunch of  GUI and non-GUI tools. As you keep trying new things, you install new tools and change configurations continually on your system. It would be nice if these changes can be synced across different devices automatically so that when you install something you won’t need to install it one by one on each of your computers.</p>
<a id="more"></a>
<h1 id="The-philosophy-of-docker"><a href="#The-philosophy-of-docker" class="headerlink" title="The philosophy of docker"></a>The philosophy of docker</h1><p>Readers unfamiliar with docker can check out <a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">the official tutorial at here</a>. Docker is easy to use: we start by writing a Dockerfile containing commands that install and configure the libraries and tools we want. Readers unfamiliar with docker can take a look at the Dockerfile example below <a href="https://github.com/kstaken/dockerfile-examples/blob/master/nodejs/Dockerfile" target="_blank" rel="noopener">that I borrow</a> to get a quick idea on how a Dockerfile looks like:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">MAINTAINER</span> Kimbro Staken</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y software-properties-common python</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> add-apt-repository ppa:chris-lea/node.js</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb http://us.archive.ubuntu.com/ubuntu/ precise universe"</span> &gt;&gt; /etc/apt/sources.list</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs</span></div><div class="line"><span class="comment">#RUN apt-get install -y nodejs=0.6.12~dfsg1-1ubuntu1</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /var/www</span></div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> app.js /var/www/app.js</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/bin/node"</span>, <span class="string">"/var/www/app.js"</span>]</span></div></pre></td></tr></table></figure></p>
<p>With a Dockerfile, a docker image can be created with just a single <code>docker build</code> command. The Docker company offers a service called DockerHub that can host public images for free. Use <code>docker push</code> to upload the image to DockerHub. To get the latest version of your image from DockerHub from a different computer, you only need a <code>docker pull</code>. DockerHub also supports auto-build. By connecting your DockerHub account with your GitHub account, you can make DockerHub automatically regenerates the image whenever the Dockerfile on GitHub changes.</p>
<p>Docker is actually giving us the solution to the maintenance of consistency mentioned at the beginning of the article: we create a docker image that has everything we needed for our project. In that case, everything related to this project, such as development, testing, deployment, etc., can be done by first opening a container with <code>docker run</code> and then doing all the work inside. When we want to install something new or change some settings, we simply make the appropriate changes in the Dockerfile, rebuild the image, and then update it with <code>docker pull</code> on all the machines using it. This philosophy of use provides a very elegant solution to the problem of consistency through a centralized repository. The only drawback is that not all programs can run in the container, and not all of the programs are easy to run in the container. If you are using a GUI program, or some system-level program, then using the programs inside a container can be a lot of hassle.  So, to overcome this drawback, it is natural to ask: can we mount a docker image directly as the root directory when we boot, so that we can run the image on the bare machine and use it as our daily desktop system?</p>
<p>There are other benefits to this approach other than the convenience of maintaining consistency:</p>
<ul>
<li>The entire system is stored in the cloud, the local content is only a cache of the cloud, so there is no need for regular backup of the system.</li>
<li>How your system is configured from scratch to the way you want is clearly written in the Dockerfile. Dockerfile then becomes your best note.</li>
<li>No need to worry about junk files or data corruption of some programs after using your system for a long time. Because every time you turn your computer on, you are using a brand new system.</li>
<li>When you get a new machine, you don’t have to install the operating system from scratch: just pull the image from DockerHub.</li>
<li>The process of a system update is nothing but rebuilding a Dockerfile from the latest software repository. Less human intervention will be needed compared to the normal system upgrade, which sometimes encounters file conflicts or dependency problems.</li>
</ul>
<h1 id="Docker-storage-driver"><a href="#Docker-storage-driver" class="headerlink" title="Docker storage driver"></a>Docker storage driver</h1><p>There is <a href="https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/" target="_blank" rel="noopener">an introduction to docker’s storage driver on the official site</a>, so we only discuss it briefly here. Docker uses the concept of layers. When building the image, docker executes the Dockerfile line by line and a new layer is created when executing each line. Only the diff is stored for each layer. When we do a <code>docker pull</code> or <code>docker push</code>, what docker actually does is download or upload the delta between layers instead of the whole layer. Whenever we do a <code>docker run</code>, docker will stack these downloaded deltas together to get a complete image. A new read-write layer (we will call it rwlayer in later contexts) on the top would also be created so that all writes to the container go to the rwlayer and the image itself is kept read-only. The concept of “layer” is actually implemented differently for different file systems where the docker directory (usually the directory <code>/var/lib/docker</code> on your computer) resides. These implementations are called graph drivers. Build-in graph drivers include aufs, overlay, btrfs, zfs, devicemapper and so on. Most graph drivers use copy-on-write techniques so that the process of creating a new layer does not require making a new copy of the data. The actual copy takes place when a write happens.</p>
<p>As the author only uses btrfs, this article will focus on btrfs. Btrfs is a copy-on-write system. To make use of the copy-on-write feature of btrfs, whenever stacking a new layer, docker creates a snapshot of the original layer’s subvolume and write the diff into the new snapshot. When creating a container from an image, docker would create a snapshot of the top layer’s subvolume and use it as the rwlayer.</p>
<h1 id="Boot-to-a-docker-image"><a href="#Boot-to-a-docker-image" class="headerlink" title="Boot to a docker image"></a>Boot to a docker image</h1><p>Besides the knowledge on how docker storage drivers work just discussed, we still need to know the Linux startup process to achieve our goal. During boot, the boot manager would load the kernel and a ramdisk called initramfs into memory. After some very basic initializations, the kernel will extract the initramfs to the root directory <code>/</code> and then start the init program in the memory disk (usually <code>/ init</code>). This init program will do some further initialization (for example, loading the file system drivers, do fsck, etc.). Then, this init program will mount the real root directory based on the kernel options <code>root</code>, <code>rootflags</code>, etc. and uses the <code>switch_root</code> program to switch the <code>/</code> from the initramfs to the mounted new root. The init program will be started by <code>switch_root</code> to make final initializations, such as mounting entries in fstab, loading graphics interface and so on. Many distributions provide tools to generate initramfs.  These tools are often modular and allow users to add their own hooks. The Arch Linux’s such tool is called “mkinitcpio”.</p>
<p>Now we have all the knowledge needed to boot into a docker image, and here is the idea: we can add a hook to initramfs, which creates a snapshot from the desired image’s subvolume in docker’s local cache as a rwlayer before the new root is mounted. The real root is set to be the rwlayer, which will then be mounted and <code>switch_root</code>ed by the init in initramfs. In detail, when writing the kernel option in boot manager’s config file, <code>root</code> should be the partition where your <code>/var/ lib/docker</code> is located, and <code>rootflags</code> must have a <code>subvol=XXXXX</code>, where XXXXX is the relative location of the rwlayer that we plan to create with respect to <code>root</code>. The most important thing to do is to write a hook that: find the btrfs subvolume for the desired docker image, and then create a snapshot of that subvolume named XXXXX (the same name as in the kernel option). If you are using Arch Linux like the author, then all of the works have been done and the reader can use the author’s hook at GitHub directly.</p>
<p>The code is located at: <a href="https://github.com/zasdfgbnm/mkinitcpio-docker-hooks" target="_blank" rel="noopener">https://github.com/zasdfgbnm/mkinitcpio-docker-hooks</a> .  Besides, the readers can also install <code>mkinitcpio-docker-hooks</code> directly from AUR.  A step-by-step tutorial to use this hook is given in the following section.</p>
<h1 id="Make-a-docker-image-your-desktop-system-using-mkinitcpio-docker-hooks"><a href="#Make-a-docker-image-your-desktop-system-using-mkinitcpio-docker-hooks" class="headerlink" title="Make a docker image your desktop system using mkinitcpio-docker-hooks"></a>Make a docker image your desktop system using mkinitcpio-docker-hooks</h1><p>The usage of mkinitcpio-docker-hooks is roughly divided into the following steps:</p>
<ol>
<li>Make sure your <code>/var/lib/docker</code> is in a btrfs partition</li>
<li>Prepare a docker image suitable for booting on bare metal</li>
<li>Install and configure mkinitcpio-docker-hooks in this docker image</li>
<li>Prepare the kernel and initramfs</li>
<li>Prepare the top layer content</li>
<li>Setup boot manager</li>
</ol>
<h2 id="Prepare-a-docker-image"><a href="#Prepare-a-docker-image" class="headerlink" title="Prepare a docker image"></a>Prepare a docker image</h2><p>To run a docker image on bare metal, you first need to have a docker image that is suitable for doing so. Many docker images, in order to reduce the size of the image, do not come with software packages that are only useful to bare metal running (such as dhcpcd).  So we need to manually install these packages in Dockerfile. For Arch Linux, this can be done simply by installing the group named <code>base</code>. </p>
<p>Since the next step is to install mkinitcpio-docker-hooks, it is recommended to base your docker image from an image that comes with yaourt. Personally, I use <a href="https://cloud.docker.com/swarm/zasdfgbnm/repository/docker/zasdfgbnm/archlinux-yaourt/general" target="_blank" rel="noopener">my own archlinux-yaourt image named <code>zasdfgbnm/archlinux-yaourt</code></a>. Therefore, the first few lines of Dockerfile looks like this:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> zasdfgbnm/archlinux-yaourt</div><div class="line"><span class="keyword">USER</span> root</div><div class="line"><span class="keyword">RUN</span><span class="bash"> pacman -Syu --noconfirm base</span></div></pre></td></tr></table></figure></p>
<p>Since this is just a demo, I will not install any other package here. The readers may want to install other packages according to their needs.</p>
<h2 id="Installation-and-configuration-of-mkinitcpio-docker-hooks"><a href="#Installation-and-configuration-of-mkinitcpio-docker-hooks" class="headerlink" title="Installation and configuration of mkinitcpio-docker-hooks"></a>Installation and configuration of mkinitcpio-docker-hooks</h2><p>The mkinitcpio-docker-hooks package should be installed inside the docker image that we plan to use as our desktop. The reason is mainly that the Linux kernel does not provide ABI stability. Therefore, the kernel modules must be strictly consistent the kernel version, otherwise, the modules cannot be loaded. In order to maintain this consistency, what we do is to install mkinitcpio-docker-hooks and generate initramfs in docker, and use the kernel from the docker image to boot. Doing so will ensure that the kernel, modules copied to initramfs, and the <code>/lib/modules</code> inside the docker image are for the same kernel. To install mkinitcpio-docker-hooks, add the following to Dockerfile:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo -u user yaourt -S --noconfirm mkinitcpio-docker-hooks</span></div></pre></td></tr></table></figure></p>
<p>The configuration file for mkinitcpio-docker-hooks is <code>/etc/docker-btrfs.json</code>, whose default value reads:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"docker_image"</span>: <span class="string">"archlinux/base"</span>,</div><div class="line">    <span class="attr">"docker_tag"</span>: <span class="string">"latest"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>All we need to do is replace the values of these two variables with the values we want, for example, I’m going to name my demo docker image “sample_image”. At the same time, we also need to add the <code>docker-btrfs</code> hook to<code>/etc/mkinitcpio.conf</code>. The following two lines in Dockerfile does the above configuration:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/archlinux\/base/sample_image/g'</span> /etc/docker-btrfs.json</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> perl -i -p -e <span class="string">'s/(?&lt;=^HOOKS=\()(.*)(?=\))/$1 docker-btrfs/g'</span> /etc/mkinitcpio.conf</span></div></pre></td></tr></table></figure></p>
<p>Now we have a ready-to-use demo Dockerfile:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> zasdfgbnm/archlinux-yaourt</div><div class="line"><span class="keyword">USER</span> root</div><div class="line"><span class="keyword">RUN</span><span class="bash"> pacman -Syu --noconfirm base</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo -u user yaourt -S --noconfirm mkinitcpio-docker-hooks</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/archlinux\/base/sample_image/g'</span> /etc/docker-btrfs.json</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> perl -i -p -e <span class="string">'s/(?&lt;=^HOOKS=\()(.*)(?=\))/$1 docker-btrfs/g'</span> /etc/mkinitcpio.conf</span></div></pre></td></tr></table></figure></p>
<p>We can the use the command <code>docker build . -t sample_image</code> to create our docker image from this Dockerfile.</p>
<h2 id="Prepare-kernel-and-initramfs"><a href="#Prepare-kernel-and-initramfs" class="headerlink" title="Prepare kernel and initramfs"></a>Prepare kernel and initramfs</h2><p>After the image is generated, the next step is to prepare the kernel and initramfs. Note that this step is best done on the machine that you intend to use to start the docker image because mkinitcpio automatically places the appropriate kernel modules into initramfs based on the machine, and if run on other machines, there may be wrong drivers will be packed into initramfs. As mentioned earlier, this step is done inside the docker container.</p>
<p>First, run the container and open an interactive shell:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -v $(<span class="built_in">pwd</span>):/workspace -w /workspace -it sample_image bash</div></pre></td></tr></table></figure></p>
<p>Then, run the following commands inside the shell:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkinitcpio -p linux</div><div class="line">cp /boot/* .</div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure></p>
<p>Now you can see the <code>vmlinuz-linux</code> and generated <code>initramfs-linux-fallback.img</code> and <code>initramfs-linux.img</code> in the current directory.</p>
<h2 id="Prepare-the-top-layer-content"><a href="#Prepare-the-top-layer-content" class="headerlink" title="Prepare the top layer content"></a>Prepare the top layer content</h2><p>The top layer is a new concept introduced by mkinitcpio-docker-hooks. It refers to a directory in a drive that will be copied to the rwlayer via busybox’s <code>cp -a</code> at startup, before mounting the real root and after the creation of rwlayer. Why do you need top layer? Because we need to start the same image on multiple machines, different machines often need to have different configuration files, such as <code>/etc/fstab</code> and <code>/etc/X11/xorg.conf</code>. In addition, DockerHub free account can only host very few private images, but <code>/etc/passwd</code>, <code>/etc/shadow</code> and other private files are not suitable to be in a public image.</p>
<p>Preparation of the top layer is to find a folder to store separate configuration files, in a structure the same way as in image’s file system. For example, if you want a separate <code>/etc/fstab</code>, you should add the file<code>etc/fstab</code> in the top layer’s directory. Here’s the suggested operation flow: first, enter the shell in the container through <code>docker run -v $(pwd): /workspace -w /workspace -it sample_image bash</code>; then, config the system in the shell, such as <code>useradd ...</code>; finally, copy new configuration file to the top layer folder.</p>
<h2 id="Setup-boot-manager"><a href="#Setup-boot-manager" class="headerlink" title="Setup boot manager"></a>Setup boot manager</h2><p>Now the only thing we need is to set the boot manager. Here we take refind as an example. Everything (docker directory, the top layer, kernel, initramfs) is assumed to be in a btrfs partition labeled “linux”. The docker directory (i.e. the <code>/var/lib/docker</code>) is in a subvolume called “docker” at the root of this partition. The kernel, initramfs, and top layer are all located in the “boot_docker” folder at the root of the partition. We want to name the rwlayer “docker_rwlayer”. Then the menuentry in <code>refind.conf</code> should read:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menuentry archlinux-docker &#123;</div><div class="line">        icon EFI/refind/icons/os_arch.png</div><div class="line">        volume linux</div><div class="line">        loader boot_docker/vmlinuz-linux</div><div class="line">        initrd boot_docker/initramfs-linux.img</div><div class="line">        options &quot;root=LABEL=linux rootflags=subvol=docker_rwlayer rw docker_path=docker toplayer=LABEL=linux toplayer_path=boot_docker&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Among the kernel options, we specify the partition where the docker directory is located by <code>root</code>. The <code>subvol</code> inside <code>rootflags</code> is used to specify the location of the rwlayer. The <code>docker_path</code> is used to specify the relative position of the docker directory in <code>root</code>. The partition where the top layer is located is specified by <code>toplayer</code>, and <code>toplayerflags</code> is used to specify the mount option for that partition. The <code>toplayer_path</code> is used to specify the relative position of the top layer directory in the<code>toplayer</code> partition.</p>
<p>Everything is done. Reboot and enjoy!</p>
<p>In addition, interested readers can take a look at the docker image that the author is using:<br><a href="https://cloud.docker.com/swarm/zasdfgbnmsystem/repository/docker/zasdfgbnmsystem/archlinux-kde/general" target="_blank" rel="noopener">https://cloud.docker.com/swarm/zasdfgbnmsystem/repository/docker/zasdfgbnmsystem/archlinux-kde/general</a><br><a href="https://github.com/zasdfgbnm-dockers/archlinux-kde" target="_blank" rel="noopener">https://github.com/zasdfgbnm-dockers/archlinux-kde</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In recent years, docker has created a containerization boom around the world by providing a way to easily create and run application containers. Containers save people from dependency hell by packaging the software with the operating environment it needs. Although docker was designed to be neither an operating system container nor an operating system running directly on the bare metal, docker’s powerful suite of tools will also give us tremendous convenience in managing our desktop system running on bare metal.&lt;/p&gt;
&lt;p&gt;Why using docker image as a desktop system is a good idea? Let’s begin with talking about the inconvenience of the normal way how people are managing their desktop systems. Nowadays, most of us has more than one computer, and we want these computers to be “consistent”. Here when I say “consistent”, I mean, for example, I begin writing a document on one computer (say, at home) and am unable to finish it before having to switch to another computer (say, at work). I don’t want to worry about copying it manually to another computer, instead, I want it to be able to magically appear there so I can access it at any time. This is exactly what cloud sync disks like Dropbox do for us.  However, for geeks, what cloud sync disks do is far from enough. For example, you are busy with a project,  which uses a number of programming languages, libraries, and a bunch of  GUI and non-GUI tools. As you keep trying new things, you install new tools and change configurations continually on your system. It would be nice if these changes can be synced across different devices automatically so that when you install something you won’t need to install it one by one on each of your computers.&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/tags/Linux/"/>
    
      <category term="docker" scheme="https://zasdfgbnm.github.io/tags/docker/"/>
    
      <category term="initramfs" scheme="https://zasdfgbnm.github.io/tags/initramfs/"/>
    
  </entry>
  
  <entry>
    <title>把docker镜像当作桌面系统来用</title>
    <link href="https://zasdfgbnm.github.io/2017/12/28/%E6%8A%8Adocker%E9%95%9C%E5%83%8F%E5%BD%93%E4%BD%9C%E6%A1%8C%E9%9D%A2%E7%B3%BB%E7%BB%9F%E6%9D%A5%E7%94%A8/"/>
    <id>https://zasdfgbnm.github.io/2017/12/28/把docker镜像当作桌面系统来用/</id>
    <published>2017-12-28T15:41:58.000Z</published>
    <updated>2017-12-29T20:50:17.149Z</updated>
    
    <content type="html"><![CDATA[<p>博主一直都很喜欢思考怎样管理装在自己电脑上的桌面系统，这篇算是前作<a href="2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/">能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大</a>的后续探索吧。</p>
<p>近些年来，Docker由于提供了一套非常方便地创建并运行应用容器的方法，而在全球掀起了一股容器化的热潮。容器通过将软件及其所需要的运行环境一同打包带走，从而将人们从依赖的苦海中拯救出来。虽然Docker设计的初衷并不是操作系统容器，更不是一个直接运行在裸机上的操作系统，但是docker这套强大的工具也会给我们管理操作系统带来巨大的便利。</p>
<p>为什么要用Docker镜像当作桌面系统？这就要从普通桌面系统的不方便之处说起。通常我们都拥有不止一台电脑，我们希望这些电脑能够保持一致。这里所说的“一致”，用一个例子来讲，就是我在一台电脑上编辑了一半的文件，不需要认为拷贝到另一台电脑上，而是直接打开电脑就能编辑。如果这个文件只是一个纯文本文件，或者一个Microsoft Word文档，那么实现这个一致性非常简单：把文件扔到Dropbox之类的云同步盘就好。然而对于专业用户来讲，这种一致性的保持并非单纯的扔到Dropbox里面那么简单：比如说你最近忙于一个项目，这个项目要用到若干编程语言，然后在电脑里装了一堆库，一堆工具软件，有图形界面的，也有命令行的。在工作的过程中，你有可能不断安装新的工具，或者决定弃用某个之前计划使用的库或者工具。要让你的工作在你的若干台电脑上都能工作，就要一直维护不同机器的环境的一致性：在一台机器上安装的工具，要在所有机器上重新安装一遍。在一台机器上升级了的库，要在所有机器上都升级，稍微有所差池，就有可能出现某个脚本/程序在一台机器上跑的好好的，在另一台机器上却无法运行的问题。</p>
<a id="more"></a>
<h1 id="docker哲学"><a href="#docker哲学" class="headerlink" title="docker哲学"></a>docker哲学</h1><p>不熟悉docker的读者可以戳<a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">这里</a>来了解docker。Docker的使用非常简单：我们通过写一个Dockerfile，在Dockerfile中写入相应的命令来安装以及配置我们想要的库跟工具。不熟悉docker的读者可以看一下下面这个<a href="https://github.com/kstaken/dockerfile-examples/blob/master/nodejs/Dockerfile" target="_blank" rel="noopener">抄来的Dockerfile的例子</a>，来了解一下Dockerfile长啥样子：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">MAINTAINER</span> Kimbro Staken</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y software-properties-common python</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> add-apt-repository ppa:chris-lea/node.js</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb http://us.archive.ubuntu.com/ubuntu/ precise universe"</span> &gt;&gt; /etc/apt/sources.list</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nodejs</span></div><div class="line"><span class="comment">#RUN apt-get install -y nodejs=0.6.12~dfsg1-1ubuntu1</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /var/www</span></div><div class="line"></div><div class="line"><span class="keyword">ADD</span><span class="bash"> app.js /var/www/app.js</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/bin/node"</span>, <span class="string">"/var/www/app.js"</span>]</span></div></pre></td></tr></table></figure></p>
<p>有了Dockerfile，只需要<code>docker build</code>一条命令就可以创建一个docker镜像。同时Docker公司提供一个叫做DockerHub的服务，可以免费托管公开镜像。只需要使用<code>docker push</code>就可以直接把镜像上传到DockerHub。在不同的电脑上只需要<code>docker pull</code>就可以从DockerHub获取最新版的镜像。DockerHub还支持自动构建，通过把DockerHub帐号跟GitHub帐号关联起来，就可以让DockerHub在GitHub上面的Dockerfile出现更改的时候自动重新生成镜像。</p>
<p>本文开头所说的这种一致性的维护，docker实际上已经在给我们提供答案了：我们通过构建一个docker镜像，让这个镜像包含着我们项目所需要的所有的一切。这样的话，我们开发，测试，部署等等一切任务，都可以在先用<code>docker run</code>来开启一个容器，然后在容里面进行所有的工作。当我们决定修改运行环境，比如引入新的库的时候，就在Dockerfile中进行相应的修改，重新生成镜像，然后在不同的机器上用<code>docker pull</code>来更新一下就好。这种使用哲学，通过一个中心化了的仓库，非常优雅地解决了不同机器上环境一致的问题。美中不足的是，并不是所有的程序都能在容器里运行的，也并不是所有的程序都方便在容器里运行的。如果你用到了图形界面的程序，或者说是一些系统级别的程序，那么在容器里面使用这些程序会麻烦很多，有的甚至根本无法实现。于是自然地就会想到，如果我们能够在每次开机的时候，直接把某个docker生成的镜像挂载起来当根目录来使用，就可以让这个镜像直接在裸机上（而不是在容器中）运行，来做我们的日常桌面系统了。</p>
<p>这种做法，除了在保持一致性方面带来的便利以外，还有一些其他的好处：</p>
<ul>
<li>整个系统保存在云端，本地的内容仅仅是云端的一份缓存而已，这样就完全没有必要定期对系统进行备份了。</li>
<li>你的系统是如何从零开始一步一步配置成你想要的样子的，所有的一切都清晰地展现在Dockerfile里面。Dockerfile就是你最好的笔记。</li>
<li>完全不用担心系统长时间使用产生一些残余的垃圾文件、或者某些系统中某些程序的数据出现损坏，因为每次开机，我们用的都是一个全新的系统。</li>
<li>要装一台新机器，并不需要从头安装操作系统，只要从DockerHub拉取镜像拿来用就好，安装系统这个过程变得极其方便。</li>
<li>系统更新的过程实际上就是根据Dockerfile从最新的软件仓库重新从头安装生成docker镜像的过程，不会出现某些更新遇到文件冲突或者依赖无法处理，需要人为干预才能完成的问题。</li>
</ul>
<h1 id="docker存储驱动的工作原理"><a href="#docker存储驱动的工作原理" class="headerlink" title="docker存储驱动的工作原理"></a>docker存储驱动的工作原理</h1><p>Docker的存储驱动<a href="https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/" target="_blank" rel="noopener">官方有介绍其工作原理</a>，这里只是简单概括一下。Docker使用了层的概念，docker在构建镜像的时候，会逐行执行我们的Dockerfile中的每一行，每执行一行的时候，docker就会创建出一个新的层来存放新的内容。当我们执行<code>docker pull</code>或者<code>docker push</code>的时候，docker实际上传跟下载的是这些层之间的增量。每当执行<code>docker run</code>，docker就会把这些下载下来的层组合到一起，组合成一个完整的镜像，然后新建一个读写层，所有运行过程中的写入都会被写入到读写层中，而镜像本身则是保持只读，不会被更改。“层”这个概念具体实现起来，根据docker目录（通常为<code>/var/lib/docker</code>这个目录）所在的文件系统的不同而不同，具体的实现在docker中被称为graph driver，docker自带的graph driver包括aufs、 overlay、btrfs、zfs、devicemapper等。这些graph driver大多使用了写时复制的技术，这样在把各个层组合在一起的过程不需要重新拷贝一份数据，实际的拷贝是在写入的时候发生的。</p>
<p>由于笔者使用的是btrfs，所以本文就以btrfs为例子来介绍怎么让系统启动到docker镜像上去。btrfs是一个写时复制的系统，由于docker的镜像是由一个一个的层叠在一起组成的，docker在使用btrfs的时候，每往上叠一层，docker就会创建一个原来层的快照，然后把新层的内容写到快照里面去。然后docker会在从镜像创建容器的时候，给镜像的最顶层做个快照，把这个快照当作容器读写层来用。</p>
<h1 id="启动到docker镜像中去"><a href="#启动到docker镜像中去" class="headerlink" title="启动到docker镜像中去"></a>启动到docker镜像中去</h1><p>明白了docker存储驱动的工作原理，还需要知道Linux的启动过程才能达成我们的目标。Linux在启动的时候，一般会让启动器给内核装载一个内存盘initramfs，然后内核完成简单的早期初始化以后，就会解压内存盘的内容到根目录<code>/</code>，然后启动内存盘中的init程序（一般为<code>/init</code>），这个init程序会进行进一步的初始化（比如说加载文件系统的驱动，对文件系统进行fsck等），这一步初始化完成了以后，这个init程序就会根据内核选项中的<code>root</code>、<code>rootflags</code>等内容挂载真正的根目录，然后通过<code>switch_root</code>程序启动真正根目录中的init程序，这个init程序则会完成最后的初始化工作，比如挂载fstab、加载图形界面等等。很多发行版都提供制作initramfs的工具，比如archlinux的mkinitcpio，这些工具通常都是模块化的，允许用户自己添加hook。</p>
<p>让系统启动到docker镜像所需要的知识已经完备了。思路也清晰了：通过给initramfs中添加hook，让initramfs中的init在挂载root之前从docker本地缓存中的镜像中创建出一个快照作为读写层，然后把这个读写层当作真正的root来挂载。具体操作上，在启动管理器里面写启动项的内核选项的时候，<code>root</code>就写<code>/var/lib/docker</code>所在的分区，而<code>rootflags</code>里面至少要有一项<code>subvol=XXXXX</code>，其中XXXXX是我们打算创建的读写层的位置。然后重中之重则是，写一个hook，这个hook干的事情是：找到想要的docker镜像对应的btrfs子卷，给这个子卷创建一个快照，命名为XXXXX（跟内核选项中的名字保持一致）。这样的话，在Linux把控制权交给initramfs中的init程序以后，init程序会先去从docker缓存中的子卷创造出XXXXX快照，然后把XXXXX快照当作root来挂载以及进行接下来的操作。如果读者跟笔者一样使用Arch Linux的话，那么所有的这些工作笔者已经做了，读者可以直接拿来用。</p>
<p>笔者的源码位于GitHub： <a href="https://github.com/zasdfgbnm/mkinitcpio-docker-hooks" target="_blank" rel="noopener">https://github.com/zasdfgbnm/mkinitcpio-docker-hooks</a> ，同时读者也可以直接从AUR中搜索<code>mkinitcpio-docker-hooks</code>来安装笔者的hook。下面就来介绍一下这个hook的使用方法。</p>
<h1 id="mkinitcpio-docker-hooks的使用"><a href="#mkinitcpio-docker-hooks的使用" class="headerlink" title="mkinitcpio-docker-hooks的使用"></a>mkinitcpio-docker-hooks的使用</h1><p>mkinitcpio-docker-hooks的使用流程大概分为如下几步：</p>
<ol>
<li>确保你的<code>/var/lib/docker</code>位于某个btrfs分区中</li>
<li>准备一个适合在裸机上启动的docker镜像</li>
<li>然后在这个镜像中安装并配置mkinitcpio-docker-hooks</li>
<li>准备内核跟initramfs</li>
<li>准备top layer的内容</li>
<li>设置启动管理器</li>
</ol>
<h2 id="docker镜像的准备"><a href="#docker镜像的准备" class="headerlink" title="docker镜像的准备"></a>docker镜像的准备</h2><p>要想启动到docker镜像中去，首先你得有一个适合在裸机上启动的docker镜像。很多docker镜像，为了减小镜像的大小，是不会附带只有裸机上才能用到的软件包（比如<code>dhcpcd</code>）的，所以读者可能需要在Dockerfile中手动安装这些软件包，对于Arch Linux来讲，只需要安装base组就可以了。由于接下来要安装<code>mkinitcpio-docker-hooks</code>，这里推荐使用一个已经内置yaourt的镜像，笔者使用的是自己的archlinux-yaourt镜像<a href="https://cloud.docker.com/swarm/zasdfgbnm/repository/docker/zasdfgbnm/archlinux-yaourt/general" target="_blank" rel="noopener">zasdfgbnm/archlinux-yaourt</a>。所以，Dockerfile的开头看起来是这个样子的：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> zasdfgbnm/archlinux-yaourt</div><div class="line"><span class="keyword">USER</span> root</div><div class="line"><span class="keyword">RUN</span><span class="bash"> pacman -Syu --noconfirm base</span></div></pre></td></tr></table></figure></p>
<p>作为示例，这里就不安装base之外的其他软件了，读者请自己根据需要安装其他软件。</p>
<h2 id="安装并配置mkinitcpio-docker-hooks"><a href="#安装并配置mkinitcpio-docker-hooks" class="headerlink" title="安装并配置mkinitcpio-docker-hooks"></a>安装并配置mkinitcpio-docker-hooks</h2><p><code>mkinitcpio-docker-hooks</code>的安装是在docker里面而不是当前运行在裸机上的系统中进行的。之所以要把这个软件包安装在docker镜像里面，很重要的原因是因为Linux内核不提供ABI的稳定性，所以内核模块跟内核的版本必须严格对应，不然模块是无法加载的。为了保持这种一致性，我们采取的措施是，在docker里面安装<code>mkinitcpio-docker-hooks</code>，在docker中生成initramfs，并且在启动的时候用镜像里面的内核启动，就可以确保内核、initramfs中的模块、启动到镜像以后的<code>/lib/modules</code>三者保持一致。安装过程在Dockerfile中的写法如下：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo -u user yaourt -S --noconfirm mkinitcpio-docker-hooks</span></div></pre></td></tr></table></figure></p>
<p>安装完了<code>mkinitcpio-docker-hooks</code>以后还需要配置，配置文件在<code>/etc/docker-btrfs.json</code>，初始内容如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"docker_image"</span>: <span class="string">"archlinux/base"</span>,</div><div class="line">    <span class="attr">"docker_tag"</span>: <span class="string">"latest"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们需要做的就是把这两个变量的值替换为我们想要的值，比如说这里我打算把我的docker镜像的名字叫做“sample_image”。同时，我们还需要在<code>/etc/mkinitcpio.conf</code>中添加<code>docker-btrfs</code>这个hook。<br>综上，可以在Dockerfile中使用如下命令来配置：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/archlinux\/base/sample_image/g'</span> /etc/docker-btrfs.json</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> perl -i -p -e <span class="string">'s/(?&lt;=^HOOKS=\()(.*)(?=\))/$1 docker-btrfs/g'</span> /etc/mkinitcpio.conf</span></div></pre></td></tr></table></figure></p>
<p>现在，我们有了一个完整的示例Dockerfile了：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> zasdfgbnm/archlinux-yaourt</div><div class="line"><span class="keyword">USER</span> root</div><div class="line"><span class="keyword">RUN</span><span class="bash"> pacman -Syu --noconfirm base</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sudo -u user yaourt -S --noconfirm mkinitcpio-docker-hooks</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/archlinux\/base/sample_image/g'</span> /etc/docker-btrfs.json</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> perl -i -p -e <span class="string">'s/(?&lt;=^HOOKS=\()(.*)(?=\))/$1 docker-btrfs/g'</span> /etc/mkinitcpio.conf</span></div></pre></td></tr></table></figure>
<p>只需要通过<code>docker build . -t sample_image</code>就可以构建自己的镜像了。</p>
<h2 id="准备内核跟initramfs"><a href="#准备内核跟initramfs" class="headerlink" title="准备内核跟initramfs"></a>准备内核跟initramfs</h2><p>镜像生成好了以后，下一步就是准备内核跟构建initramfs了。注意这一步操作尽量在你打算用来启动docker镜像的机器上进行，因为mkinitcpio会自动根据机器把相应的内核模块放入initramfs中去，如果在别的机器上进行的话，那就可能会有一些驱动没有被自动装入initramfs中。如前所述，这一步的工作是在docker容器中进行的。首先运行容器并开启一个shell：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -v $(<span class="built_in">pwd</span>):/workspace -w /workspace -it sample_image bash</div></pre></td></tr></table></figure></p>
<p>然后在容器中执行如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkinitcpio -p linux</div><div class="line">cp /boot/* .</div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure></p>
<p>然后就可以在当前目录下看到准备好的<code>initramfs-linux-fallback.img</code>、<code>initramfs-linux.img</code>以及<code>vmlinuz-linux</code>了。</p>
<h2 id="准备top-layer的内容"><a href="#准备top-layer的内容" class="headerlink" title="准备top layer的内容"></a>准备top layer的内容</h2><p>Top layer是<code>mkinitcpio-docker-hooks</code>引入的新概念，它指的是某个驱动器中的某个目录，这个目录会在启动的时候读写层创建之后，真正的root挂载之前，通过busybox的<code>cp -a</code>命令整个拷贝到读写层里面去。为什么需要top layer呢？因为我们需要在多台机器上启动同一个镜像，而不同机器上的往往会根据需要配置不同的配置文件，比如<code>/etc/fstab</code>以及<code>/etc/X11/xorg.conf</code>。另外，DockerHub免费账户上的镜像都是公开的，<code>/etc/passwd</code>、<code>/etc/shadow</code>等的私密性文件也不适合放在镜像里面存储。</p>
<p>准备top layer的内容，实际上就是找一个文件夹，把需要单独配置的文件，按照从根目录算起的相对路径存放在这个文件夹里面。比如说如果你想给某台机器单独配置<code>/etc/fstab</code>，那么你就应该在top layer的目录中添加<code>etc/fstab</code>这个文件。这里推荐的具体的操作流程是：首先通过<code>docker run -v $(pwd):/workspace -w /workspace -it sample_image bash</code>进入容器中的shell，然后在其中做各种配置，比如<code>useradd ...</code>，完了以后把新生成的配置文件拷贝到top layer的文件夹中去</p>
<h2 id="设置启动管理器"><a href="#设置启动管理器" class="headerlink" title="设置启动管理器"></a>设置启动管理器</h2><p>设置好了top layer以后，我们基本上可以算是万事具备只差东风了。我们只需要简单设置一下启动管理器就可以启动我们的系统了。这里以refind为例子，这里假设我们的所有东西放在一个label为“linux”的btrfs分区中，docker目录（也就是你系统启动以后会挂载到<code>/var/lib/docker</code>的目录）存放在这个分区根目录下的一个叫做“docker”的子卷中，而内核、initramfs以及top layer都是位于分区根目录下的“boot_docker”文件夹中，而我们希望创建的读写层名字叫做“docker_rwlayer”，那么相应的<code>refind.conf</code>中的菜单项的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menuentry archlinux-docker &#123;</div><div class="line">        icon EFI/refind/icons/os_arch.png</div><div class="line">        volume linux</div><div class="line">        loader boot_docker/vmlinuz-linux</div><div class="line">        initrd boot_docker/initramfs-linux.img</div><div class="line">        options &quot;root=LABEL=linux rootflags=subvol=docker_rwlayer rw docker_path=docker toplayer=LABEL=linux toplayer_path=boot_docker&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中内核选项中，我们通过<code>root</code>来指定docker目录所在的分区，<code>rootflags</code>中的<code>subvol</code>来指定读写层的位置，<code>docker_path</code>来指定docker目录在<code>root</code>中的相对位置；通过<code>toplayer</code>来指定top layer目录所在的分区，<code>toplayerflags</code>来指定top layer所在分区的挂载选项，<code>toplayer_path</code>来指定top layer的目录在<code>toplayer</code>分区中的相对位置。</p>
<p>一切就绪，重启并享受吧！</p>
<p>另外，有兴趣的读者可以看一下笔者自用的docker镜像作为参考：<br><a href="https://cloud.docker.com/swarm/zasdfgbnmsystem/repository/docker/zasdfgbnmsystem/archlinux-kde/general" target="_blank" rel="noopener">https://cloud.docker.com/swarm/zasdfgbnmsystem/repository/docker/zasdfgbnmsystem/archlinux-kde/general</a><br><a href="https://github.com/zasdfgbnm-dockers/archlinux-kde" target="_blank" rel="noopener">https://github.com/zasdfgbnm-dockers/archlinux-kde</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;博主一直都很喜欢思考怎样管理装在自己电脑上的桌面系统，这篇算是前作&lt;a href=&quot;2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/&quot;&gt;能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大&lt;/a&gt;的后续探索吧。&lt;/p&gt;
&lt;p&gt;近些年来，Docker由于提供了一套非常方便地创建并运行应用容器的方法，而在全球掀起了一股容器化的热潮。容器通过将软件及其所需要的运行环境一同打包带走，从而将人们从依赖的苦海中拯救出来。虽然Docker设计的初衷并不是操作系统容器，更不是一个直接运行在裸机上的操作系统，但是docker这套强大的工具也会给我们管理操作系统带来巨大的便利。&lt;/p&gt;
&lt;p&gt;为什么要用Docker镜像当作桌面系统？这就要从普通桌面系统的不方便之处说起。通常我们都拥有不止一台电脑，我们希望这些电脑能够保持一致。这里所说的“一致”，用一个例子来讲，就是我在一台电脑上编辑了一半的文件，不需要认为拷贝到另一台电脑上，而是直接打开电脑就能编辑。如果这个文件只是一个纯文本文件，或者一个Microsoft Word文档，那么实现这个一致性非常简单：把文件扔到Dropbox之类的云同步盘就好。然而对于专业用户来讲，这种一致性的保持并非单纯的扔到Dropbox里面那么简单：比如说你最近忙于一个项目，这个项目要用到若干编程语言，然后在电脑里装了一堆库，一堆工具软件，有图形界面的，也有命令行的。在工作的过程中，你有可能不断安装新的工具，或者决定弃用某个之前计划使用的库或者工具。要让你的工作在你的若干台电脑上都能工作，就要一直维护不同机器的环境的一致性：在一台机器上安装的工具，要在所有机器上重新安装一遍。在一台机器上升级了的库，要在所有机器上都升级，稍微有所差池，就有可能出现某个脚本/程序在一台机器上跑的好好的，在另一台机器上却无法运行的问题。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/tags/Linux/"/>
    
      <category term="docker" scheme="https://zasdfgbnm.github.io/tags/docker/"/>
    
      <category term="initramfs" scheme="https://zasdfgbnm.github.io/tags/initramfs/"/>
    
  </entry>
  
  <entry>
    <title>Adding new expressions to nftables</title>
    <link href="https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/"/>
    <id>https://zasdfgbnm.github.io/2017/09/07/Extending-nftables/</id>
    <published>2017-09-07T19:50:12.000Z</published>
    <updated>2017-09-14T01:58:43.677Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentations about this topic I find online are quite dated. These old documents are mainly for kernel version 2.4 and earlier 2.6.x, in which new matches or targets are registered by calling <code>ipt_register_match</code> and <code>ipt_register_target</code>. The related subsystem of kernel has changed a lot since then, and iptables has been replaced by nftables. Although we can use <code>xt_register_match</code> and <code>xt_register_target</code> instead, I prefer to move to the new nftables framework. Due to the lack of documentation, I have to dig into the source code of Linux kernel to figure out how things works, and this post is the note for that. As Linus Torvalds says in 2008, “Linux is evolution, not intelligent design”, the design and API of nftables might be changing very fast. So I’m not only trying to make a brief review on the design or API of nftables. But also, this post will serve as a guide on how to find the correct way of doing things by reading the kernel source code. The eager reader can go directly to <a href="#summary">the summary section</a>. This post is based on kernel version 4.13, the most recent version when this post is started writing.</p>
<p>Here in this post, we will solve a toy problem: monitor all outgoing TCP traffic from port 80, if it contains the string given by the user, log it. I don’t assume any knowledge in the design or kernel API of nftables, but I do assume the reader has read and understand well <a href="https://wiki.nftables.org" target="_blank" rel="noopener">the official documents on how to use nftables</a>.</p>
<a id="more"></a>
<h1 id="Starting-point-of-kernel-code"><a href="#Starting-point-of-kernel-code" class="headerlink" title="Starting point of kernel code"></a>Starting point of kernel code</h1><p>The starting point is to find which source file to read. The following command gives a nice overview on nftables in Linux kernel:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -P <span class="string">'nftables|nf_tables'</span> -r .</div></pre></td></tr></table></figure></p>
<p>The output shall be something that looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">./include/net/netfilter/nf_tables_core.h:int nf_tables_core_module_init(void);</div><div class="line">./include/net/netfilter/nf_tables_core.h:void nf_tables_core_module_exit(void);</div><div class="line">./include/net/netfilter/nf_tables_ipv4.h:#include &lt;net/netfilter/nf_tables.h&gt;</div><div class="line">./include/net/netfilter/nf_tables.h:#include &lt;linux/netfilter/nf_tables.h&gt;</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_verdict - nf_tables verdict</div><div class="line">./include/net/netfilter/nf_tables.h: *  @code: nf_tables/netfilter verdict code</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_regs - nf_tables register set</div><div class="line">./include/net/netfilter/nf_tables.h: *  struct nft_ctx - nf_tables rule/set context</div><div class="line">...........</div></pre></td></tr></table></figure></p>
<p>The files listed in the output will be the files to look at. A good tool to read Linux kernel source code is <a href="http://elixir.free-electrons.com/linux/v4.13/source" target="_blank" rel="noopener">FreeElectrons</a>. We can start by looking at the file names in directory <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter" target="_blank" rel="noopener">include/net/netfilter</a> on its website. We can see nft_masq.h, nft_redir.h, nft_reject.h in that directory. These are all actions in nftables. Following the references of symbols defined in these files will lead us towards sample codes on how to create new actions. Let’s take reject as an example. From its <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nft_reject.h" target="_blank" rel="noopener">header</a>, we can find an interesting symbol <code>nft_reject_init</code>. Looking around <a href="http://elixir.free-electrons.com/linux/v4.13/ident/nft_reject_init" target="_blank" rel="noopener">all the definitions and references of that symbol</a>, we are able to find the core code at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/ipv4/netfilter/nft_reject_ipv4.c" target="_blank" rel="noopener">net/ipv4/netfilter/nft_reject_ipv4.c</a>.  In its core code, <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/ipv4/netfilter/nft_reject_ipv4.c#L61" target="_blank" rel="noopener">L61-L72</a> reads:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">nft_reject_ipv4_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> nft_register_expr(&amp;nft_reject_ipv4_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">nft_reject_ipv4_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	nft_unregister_expr(&amp;nft_reject_ipv4_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(nft_reject_ipv4_module_init);</div><div class="line">module_exit(nft_reject_ipv4_module_exit);</div></pre></td></tr></table></figure></p>
<p>We can immediately know from the above code that we should call <code>nft_register_expr</code> to register an expression and call <code>nft_unregister_expr</code> to unregister.</p>
<p>Now let’s take a look at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L999" target="_blank" rel="noopener">the prototype of <code>nft_register_expr</code> in nf_tables.h</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_register_expr</span><span class="params">(struct nft_expr_type *)</span></span>;</div></pre></td></tr></table></figure></p>
<p>It takes one parameter of type <code>struct nft_expr_type *</code>. This struct is also defined in nf_tables.h at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L681" target="_blank" rel="noopener">L681</a>.  The usage of <code>nft_register_expr</code> and <code>nft_expr_type</code> can be guessed by reading all the examples. The list of all examples can be found from its reference in <a href="http://elixir.free-electrons.com/linux/v4.13/ident/nft_register_expr" target="_blank" rel="noopener">here</a>. In that list, there is one file that looks very interesting from its file name:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net/netfilter/nf_tables_core.c, line 251</div></pre></td></tr></table></figure></p>
<p><a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nf_tables_core.c#L251" target="_blank" rel="noopener">Open this link</a>, we can see all these basic expressions:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">nft_basic_types</span>[] = &#123;</span></div><div class="line">	&amp;nft_imm_type,</div><div class="line">	&amp;nft_cmp_type,</div><div class="line">	&amp;nft_lookup_type,</div><div class="line">	&amp;nft_bitwise_type,</div><div class="line">	&amp;nft_byteorder_type,</div><div class="line">	&amp;nft_payload_type,</div><div class="line">	&amp;nft_dynset_type,</div><div class="line">	&amp;nft_range_type,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">nf_tables_core_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> err, i;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(nft_basic_types); i++) &#123;</div><div class="line">		err = nft_register_expr(nft_basic_types[i]);</div><div class="line">		<span class="keyword">if</span> (err)</div><div class="line">			<span class="keyword">goto</span> err;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">err:</div><div class="line">	<span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</div><div class="line">		nft_unregister_expr(nft_basic_types[i]);</div><div class="line">	<span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Now we know what to look at. The next step will be to read these examples to get a feeling on how to write our own expression.</p>
<h1 id="The-usage-of-kernel-API"><a href="#The-usage-of-kernel-API" class="headerlink" title="The usage of kernel API"></a>The usage of kernel API</h1><p>To know the usage of related API, we choose to read the reject operation for the inet family and compare operation as sample code. The source code of reject is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c" target="_blank" rel="noopener">net/netfilter/nft_reject_inet.c</a>. The source code of compare is loacated at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_cmp.c" target="_blank" rel="noopener">net/netfilter/nft_cmp.c</a>. In the case that one expression only correspond to one operation, the usage is shown below by the source code of reject operation at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L120" target="_blank" rel="noopener">L120</a>:<a name="nft_expr_ops_and_nft_expr_type_reject"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_reject_inet_type</span>;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_reject_inet_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_reject_inet_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_reject)),</div><div class="line">	.eval		= nft_reject_inet_eval,</div><div class="line">	.init		= nft_reject_inet_init,</div><div class="line">	.dump		= nft_reject_inet_dump,</div><div class="line">	.validate	= nft_reject_validate,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_reject_inet_type</span> __<span class="title">read_mostly</span> = &#123;</span></div><div class="line">	.family		= NFPROTO_INET,</div><div class="line">	.name		= <span class="string">"reject"</span>,</div><div class="line">	.ops		= &amp;nft_reject_inet_ops,</div><div class="line">	.policy		= nft_reject_policy,</div><div class="line">	.maxattr	= NFTA_REJECT_MAX,</div><div class="line">	.owner		= THIS_MODULE,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From the above code, we know that we should create an instance of both <code>struct nft_expr_ops</code> and <code>struct nft_expr_type</code> and point to each other at <code>nft_expr_ops.type</code> and <code>nft_expr_type.ops</code>.  In the case that one expression correspond to many operations, the usage is shown below by the source code of compare operation:<a name="nft_expr_ops_and_nft_expr_type_cmp"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_cmp_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_cmp_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_cmp_expr)),</div><div class="line">	.eval		= nft_cmp_eval,</div><div class="line">	.init		= nft_cmp_init,</div><div class="line">	.dump		= nft_cmp_dump,</div><div class="line">&#125;;</div><div class="line">...........</div><div class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_cmp_fast_ops</span> = &#123;</span></div><div class="line">	.type		= &amp;nft_cmp_type,</div><div class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_cmp_fast_expr)),</div><div class="line">	.eval		= <span class="literal">NULL</span>,	<span class="comment">/* inlined */</span></div><div class="line">	.init		= nft_cmp_fast_init,</div><div class="line">	.dump		= nft_cmp_fast_dump,</div><div class="line">&#125;;</div><div class="line">...........</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct nft_expr_ops *</span></div><div class="line"><span class="title">nft_cmp_select_ops</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span></div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data_desc</span> <span class="title">desc</span>;</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data</span> <span class="title">data</span>;</span></div><div class="line">	<span class="keyword">enum</span> nft_cmp_ops op;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_CMP_SREG] == <span class="literal">NULL</span> ||</div><div class="line">	    tb[NFTA_CMP_OP] == <span class="literal">NULL</span> ||</div><div class="line">	    tb[NFTA_CMP_DATA] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line"></div><div class="line">	op = ntohl(nla_get_be32(tb[NFTA_CMP_OP]));</div><div class="line">	<span class="keyword">switch</span> (op) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_EQ:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_NEQ:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LT:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LTE:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GT:</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GTE:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	err = nft_data_init(<span class="literal">NULL</span>, &amp;data, <span class="keyword">sizeof</span>(data), &amp;desc,</div><div class="line">			    tb[NFTA_CMP_DATA]);</div><div class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> ERR_PTR(err);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (desc.type != NFT_DATA_VALUE) &#123;</div><div class="line">		err = -EINVAL;</div><div class="line">		<span class="keyword">goto</span> err1;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (desc.len &lt;= <span class="keyword">sizeof</span>(u32) &amp;&amp; op == NFT_CMP_EQ)</div><div class="line">		<span class="keyword">return</span> &amp;nft_cmp_fast_ops;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;nft_cmp_ops;</div><div class="line">err1:</div><div class="line">	nft_data_release(&amp;data, desc.type);</div><div class="line">	<span class="keyword">return</span> ERR_PTR(-EINVAL);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_cmp_type</span> __<span class="title">read_mostly</span> = &#123;</span></div><div class="line">	.name		= <span class="string">"cmp"</span>,</div><div class="line">	.select_ops	= nft_cmp_select_ops,</div><div class="line">	.policy		= nft_cmp_policy,</div><div class="line">	.maxattr	= NFTA_CMP_MAX,</div><div class="line">	.owner		= THIS_MODULE,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From this we can see that we should create an instance of <code>struct nft_expr_ops</code> for each operation, and use <code>select_ops</code> to choose dynamically which operation to use.  The <code>select_ops</code> should return the pointer to the operation chosen, or an <code>ERR_PTR</code> in case of error. Now Let’s discuss <code>struct nft_expr_ops</code> and <code>struct nft_expr_type</code> in detail separately.</p>
<h2 id="struct-nft-expr-ops"><a href="#struct-nft-expr-ops" class="headerlink" title="struct nft_expr_ops"></a>struct nft_expr_ops</h2><p>Let’s take a look at <code>struct nft_expr_ops</code> first. It’s definition is at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L722" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L722</a>:<a name="nft_expr_ops"></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *	struct nft_expr_ops - nf_tables expression operations</div><div class="line"> *</div><div class="line"> *	@eval: Expression evaluation function</div><div class="line"> *	@size: full expression size, including private data size</div><div class="line"> *	@init: initialization function</div><div class="line"> *	@destroy: destruction function</div><div class="line"> *	@dump: function to dump parameters</div><div class="line"> *	@type: expression type</div><div class="line"> *	@validate: validate expression, called during loop detection</div><div class="line"> *	@data: extra data to attach to this expression operation</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span>;</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> &#123;</span></div><div class="line">	<span class="keyword">void</span>				(*eval)(<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						struct nft_regs *regs,</div><div class="line">						<span class="keyword">const</span> struct nft_pktinfo *pkt);</div><div class="line">	<span class="keyword">int</span>				(*clone)(struct nft_expr *dst,</div><div class="line">						 <span class="keyword">const</span> struct nft_expr *src);</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>			size;</div><div class="line"></div><div class="line">	<span class="keyword">int</span>				(*init)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[]);</div><div class="line">	<span class="keyword">void</span>				(*destroy)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						   <span class="keyword">const</span> struct nft_expr *expr);</div><div class="line">	<span class="keyword">int</span>				(*dump)(struct sk_buff *skb,</div><div class="line">						<span class="keyword">const</span> struct nft_expr *expr);</div><div class="line">	<span class="keyword">int</span>				(*validate)(<span class="keyword">const</span> struct nft_ctx *ctx,</div><div class="line">						    <span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">						    <span class="keyword">const</span> struct nft_data **data);</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span>	*<span class="title">type</span>;</span></div><div class="line">	<span class="keyword">void</span>				*data;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>From the name and comments of these fields, we can see that <code>init</code>, <code>destroy</code>, <code>clone</code> play the role of constructor, destructor, and copy constructor. What to do in these functions is shown in <a href="#nft_expr_ops_and_nft_expr_type_reject">the code above</a>. In that code, <code>init</code> is defined as <code>nft_reject_inet_init</code> and <code>clone</code> and <code>destroy</code> are not defined. The source code for <code>nft_reject_inet_init</code> is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L64" target="_blank" rel="noopener">L64</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_reject_inet_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></div><div class="line">				<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">				<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">int</span> icmp_code;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_REJECT_TYPE] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">	priv-&gt;type = ntohl(nla_get_be32(tb[NFTA_REJECT_TYPE]));</div><div class="line">	<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">		<span class="keyword">if</span> (tb[NFTA_REJECT_ICMP_CODE] == <span class="literal">NULL</span>)</div><div class="line">			<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">		icmp_code = nla_get_u8(tb[NFTA_REJECT_ICMP_CODE]);</div><div class="line">		<span class="keyword">if</span> (priv-&gt;type == NFT_REJECT_ICMPX_UNREACH &amp;&amp;</div><div class="line">		    icmp_code &gt; NFT_REJECT_ICMPX_MAX)</div><div class="line">			<span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">		priv-&gt;icmp_code = icmp_code;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>By reading this function and looking into all other functions called by this function, we can see that the following things will happen: The kernel will allocate memory for an instance of <code>struct nft_reject</code>, which is the struct that stores operation specific data, at <code>expr-&gt;data</code>. In order for the kernel to know the size of memory to allocate for <code>struct nft_reject</code>, its size is passed to <code>nft_expr_ops.size</code> as shown in the 4th line at <a href="#nft_expr_ops_and_nft_expr_type_reject">the code snippet above</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.size = NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_reject))</div></pre></td></tr></table></figure></p>
<p>The <code>init</code> function is responsible to initialize the fields of this instance by reading attributes from <a href="https://en.wikipedia.org/wiki/Netlink" target="_blank" rel="noopener">netlink</a> by calling functions like <code>nla_get_&lt;type&gt;</code>. Data from netlink is stored at the argument <code>tb</code>. In case of error, the <code>init</code> function should return a negative number, otherwise <code>0</code> should be returned. <a name="question_netlink"></a>Up to now, we are not sure how to let netlink know what attributes are expected and what are the length of these attributes yet, but don’t worry, things will become clear as we keep reading. Let’s for now just forget about this problem.</p>
<p>Now let’s take a look at the <code>dump</code> field, it is implemented by <code>nft_reject_inet_dump</code> for reject operation. The code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L96" target="_blank" rel="noopener">L96</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_reject_inet_dump</span><span class="params">(struct sk_buff *skb,</span></span></div><div class="line">				<span class="keyword">const</span> struct nft_expr *expr)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (nla_put_be32(skb, NFTA_REJECT_TYPE, htonl(priv-&gt;type)))</div><div class="line">		<span class="keyword">goto</span> nla_put_failure;</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">	<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">		<span class="keyword">if</span> (nla_put_u8(skb, NFTA_REJECT_ICMP_CODE, priv-&gt;icmp_code))</div><div class="line">			<span class="keyword">goto</span> nla_put_failure;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">nla_put_failure:</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>We can see that this operation send back the parameters to netlink using functions like <code>nla_put_&lt;type&gt;</code>. In case of success, <code>0</code> should be returned, otherwise it should return a negative number.</p>
<p>The function that evaluate the evaluation correspond to the field <code>eval</code>. We can think of there are two types of expressions: those that match some conditions, and those that do something, such as drop, reject, accept, dnat, etc., to the packets. For these two types, the <code>eval</code> should be slightly different. Here we use the source code of both compare and reject as example. In reject, it is implemented as <code>nft_reject_inet_eval</code>. The source code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject_inet.c#L20" target="_blank" rel="noopener">L20</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_reject_inet_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr,</span></span></div><div class="line">				 struct nft_regs *regs,</div><div class="line">				 <span class="keyword">const</span> struct nft_pktinfo *pkt)</div><div class="line">&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_reject</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (nft_pf(pkt)) &#123;</div><div class="line">	<span class="keyword">case</span> NFPROTO_IPV4:</div><div class="line">		<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">			nf_send_unreach(pkt-&gt;skb, priv-&gt;icmp_code,</div><div class="line">					nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">			nf_send_reset(nft_net(pkt), pkt-&gt;skb, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">			nf_send_unreach(pkt-&gt;skb,</div><div class="line">					nft_reject_icmp_code(priv-&gt;icmp_code),</div><div class="line">					nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFPROTO_IPV6:</div><div class="line">		<span class="keyword">switch</span> (priv-&gt;type) &#123;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMP_UNREACH:</div><div class="line">			nf_send_unreach6(nft_net(pkt), pkt-&gt;skb,</div><div class="line">					 priv-&gt;icmp_code, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_TCP_RST:</div><div class="line">			nf_send_reset6(nft_net(pkt), pkt-&gt;skb, nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> NFT_REJECT_ICMPX_UNREACH:</div><div class="line">			nf_send_unreach6(nft_net(pkt), pkt-&gt;skb,</div><div class="line">					 nft_reject_icmpv6_code(priv-&gt;icmp_code),</div><div class="line">					 nft_hook(pkt));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	regs-&gt;verdict.code = NF_DROP;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>In the compare operation, it is implemented as <code>nft_cmp_eval</code>. The source code is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_cmp.c#L27" target="_blank" rel="noopener">L27</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_cmp_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr,</span></span></div><div class="line">			 struct nft_regs *regs,</div><div class="line">			 <span class="keyword">const</span> struct nft_pktinfo *pkt)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_cmp_expr</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">int</span> d;</div><div class="line"></div><div class="line">	d = <span class="built_in">memcmp</span>(&amp;regs-&gt;data[priv-&gt;sreg], &amp;priv-&gt;data, priv-&gt;len);</div><div class="line">	<span class="keyword">switch</span> (priv-&gt;op) &#123;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_EQ:</div><div class="line">		<span class="keyword">if</span> (d != <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_NEQ:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LT:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_LTE:</div><div class="line">		<span class="keyword">if</span> (d &gt; <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GT:</div><div class="line">		<span class="keyword">if</span> (d == <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">	<span class="keyword">case</span> NFT_CMP_GTE:</div><div class="line">		<span class="keyword">if</span> (d &lt; <span class="number">0</span>)</div><div class="line">			<span class="keyword">goto</span> mismatch;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"></div><div class="line">mismatch:</div><div class="line">	regs-&gt;verdict.code = NFT_BREAK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>From these two functions, we can see that this function tells the kernel to do something by setting <code>regs-&gt;verdict.code</code> or to continue to the next expression by not changing <code>regs-&gt;verdict.code</code>. For actions, the value of <code>regs-&gt;verdict.code</code> should be set to one of the following as shown in <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter.h#L9" target="_blank" rel="noopener">include/uapi/linux/netfilter.h#L9</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Responses from hook functions. */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_DROP 0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_ACCEPT 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_STOLEN 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_QUEUE 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_REPEAT 4</span></div></pre></td></tr></table></figure></p>
<p>For matches, it should be a value in <code>enum nft_verdicts</code>, which is listed at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h#L49" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h#L49</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * enum nft_verdicts - nf_tables internal verdicts</div><div class="line"> *</div><div class="line"> * @NFT_CONTINUE: continue evaluation of the current rule</div><div class="line"> * @NFT_BREAK: terminate evaluation of the current rule</div><div class="line"> * @NFT_JUMP: push the current chain on the jump stack and jump to a chain</div><div class="line"> * @NFT_GOTO: jump to a chain without pushing the current chain on the jump stack</div><div class="line"> * @NFT_RETURN: return to the topmost chain on the jump stack</div><div class="line"> *</div><div class="line"> * The nf_tables verdicts share their numeric space with the netfilter verdicts.</div><div class="line"> */</div><div class="line"><span class="keyword">enum</span> nft_verdicts &#123;</div><div class="line">	NFT_CONTINUE	= <span class="number">-1</span>,</div><div class="line">	NFT_BREAK	= <span class="number">-2</span>,</div><div class="line">	NFT_JUMP	= <span class="number">-3</span>,</div><div class="line">	NFT_GOTO	= <span class="number">-4</span>,</div><div class="line">	NFT_RETURN	= <span class="number">-5</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>validate</code> is used to check the validation of operation, for example: masquerade is only available at hook point <code>POSTROUTING</code>, reject is only available at hook point <code>LOCAL INPUT</code>, <code>LOCAL_OUTPUT</code> and <code>FORWARD</code>, etc. This can be shown at the source code of at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject.c#L29" target="_blank" rel="noopener">net/netfilter/nft_reject.c#L29</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_reject_validate</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></div><div class="line">			<span class="keyword">const</span> struct nft_expr *expr,</div><div class="line">			<span class="keyword">const</span> struct nft_data **data)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> nft_chain_validate_hooks(ctx-&gt;chain,</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_IN) |</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_FORWARD) |</div><div class="line">					(<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_OUT));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>The function <code>nft_chain_validate_hooks</code> is used to validate the hook point. There are other helper functions to validate different things, the list of these functions can be obtained by searching the string “validate” at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h</a>.</p>
<h2 id="struct-nft-expr-type"><a href="#struct-nft-expr-type" class="headerlink" title="struct nft_expr_type"></a>struct nft_expr_type</h2><p>The definition of <code>nft_expr_type</code> is at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L681" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L681</a>:<a name="nft_expr_type"></a><br><a name="nft_expr_type"></a><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *	struct nft_expr_type - nf_tables expression type</div><div class="line"> *</div><div class="line"> *	@select_ops: function to select nft_expr_ops</div><div class="line"> *	@ops: default ops, used when no select_ops functions is present</div><div class="line"> *	@list: used internally</div><div class="line"> *	@name: Identifier</div><div class="line"> *	@owner: module reference</div><div class="line"> *	@policy: netlink attribute policy</div><div class="line"> *	@maxattr: highest netlink attribute number</div><div class="line"> *	@family: address family for AF-specific types</div><div class="line"> *	@flags: expression type flags</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> &#123;</span></div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span>	*(*<span class="title">select_ops</span>)(<span class="title">const</span> <span class="title">struct</span> <span class="title">nft_ctx</span> *,</span></div><div class="line">						       <span class="title">const</span> <span class="title">struct</span> <span class="title">nlattr</span> * <span class="title">const</span> <span class="title">tb</span>[]);</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span>	*<span class="title">ops</span>;</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span>			*name;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>			*<span class="title">owner</span>;</span></div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span>		*<span class="title">policy</span>;</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>			maxattr;</div><div class="line">	u8				family;</div><div class="line">	u8				flags;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>ops</code> and <code>select_ops</code> is already discussed; the field <code>list</code> is internally, so we should not worry about it here; the field <code>name</code> is the name of the expression; the field <code>owner</code> should be set to the pointer towards the current module. These are all trivial fields. Now let’s take a look at the <code>policy</code> and <code>maxattr</code> field. The related code at <a href="#nft_expr_ops_and_nft_expr_type_reject">the definition of <code>nft_reject_inet_type</code></a> is:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">.policy = nft_reject_policy,</div><div class="line">.maxattr = NFTA_REJECT_MAX,</div></pre></td></tr></table></figure></p>
<p>The array <code>nft_reject_policy</code> is defined at <a href="http://elixir.free-electrons.com/linux/v4.13/source/net/netfilter/nft_reject.c#L23" target="_blank" rel="noopener">L23</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> <span class="title">nft_reject_policy</span>[<span class="title">NFTA_REJECT_MAX</span> + 1] = &#123;</span></div><div class="line">	[NFTA_REJECT_TYPE]		= &#123; .type = NLA_U32 &#125;,</div><div class="line">	[NFTA_REJECT_ICMP_CODE]		= &#123; .type = NLA_U8 &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The two array index above, <code>NFTA_REJECT_TYPE</code> and <code>NFTA_REJECT_ICMP_CODE</code>, belongs to an enum named <code>nft_reject_attributes</code>. And the definition of <code>NFTA_REJECT_MAX</code> and <code>nft_reject_attributes</code> is located at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h#L1089" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h#L1089</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * enum nft_reject_attributes - nf_tables reject expression netlink attributes</div><div class="line"> *</div><div class="line"> * @NFTA_REJECT_TYPE: packet type to use (NLA_U32: nft_reject_types)</div><div class="line"> * @NFTA_REJECT_ICMP_CODE: ICMP code to use (NLA_U8)</div><div class="line"> */</div><div class="line"><span class="keyword">enum</span> nft_reject_attributes &#123;</div><div class="line">	NFTA_REJECT_UNSPEC,</div><div class="line">	NFTA_REJECT_TYPE,</div><div class="line">	NFTA_REJECT_ICMP_CODE,</div><div class="line">	__NFTA_REJECT_MAX</div><div class="line">&#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFTA_REJECT_MAX		(__NFTA_REJECT_MAX - 1)</span></div></pre></td></tr></table></figure></p>
<p>Recall that we raised a question <a href="#question_netlink">before</a> on how does the kernel knows what are the attributes expected by the expression. The <code>policy</code> field is exactly the answer to this question. Let’s now dig deeper and read the source code of netlink starting at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netlink.h#L9" target="_blank" rel="noopener">include/net/netlink.h#L9</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ========================================================================</span></div><div class="line"> *         Netlink Messages and Attributes Interface (As Seen On TV)</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *                          Messages Interface</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Message Format:</div><div class="line"> *    &lt;--- nlmsg_total_size(payload)  ---&gt;</div><div class="line"> *    &lt;-- nlmsg_msg_size(payload) -&gt;</div><div class="line"> *   +----------+- - -+-------------+- - -+-------- - -</div><div class="line"> *   | nlmsghdr | Pad |   Payload   | Pad | nlmsghdr</div><div class="line"> *   +----------+- - -+-------------+- - -+-------- - -</div><div class="line"> *   nlmsg_data(nlh)---^                   ^</div><div class="line"> *   nlmsg_next(nlh)-----------------------+</div><div class="line"> *</div><div class="line"> * Payload Format:</div><div class="line"> *    &lt;---------------------- nlmsg_len(nlh) ---------------------&gt;</div><div class="line"> *    &lt;------ hdrlen ------&gt;       &lt;- nlmsg_attrlen(nlh, hdrlen) -&gt;</div><div class="line"> *   +----------------------+- - -+--------------------------------+</div><div class="line"> *   |     Family Header    | Pad |           Attributes           |</div><div class="line"> *   +----------------------+- - -+--------------------------------+</div><div class="line"> *   nlmsg_attrdata(nlh, hdrlen)---^</div><div class="line"> *</div><div class="line"> * Data Structures:</div><div class="line"> *   struct nlmsghdr			netlink message header</div><div class="line"> *</div><div class="line"> * Message Construction:</div><div class="line"> *   nlmsg_new()			create a new netlink message</div><div class="line"> *   nlmsg_put()			add a netlink message to an skb</div><div class="line"> *   nlmsg_put_answer()			callback based nlmsg_put()</div><div class="line"> *   nlmsg_end()			finalize netlink message</div><div class="line"> *   nlmsg_get_pos()			return current position in message</div><div class="line"> *   nlmsg_trim()			trim part of message</div><div class="line"> *   nlmsg_cancel()			cancel message construction</div><div class="line"> *   nlmsg_free()			free a netlink message</div><div class="line"> *</div><div class="line"> * Message Sending:</div><div class="line"> *   nlmsg_multicast()			multicast message to several groups</div><div class="line"> *   nlmsg_unicast()			unicast a message to a single socket</div><div class="line"> *   nlmsg_notify()			send notification message</div><div class="line"> *</div><div class="line"> * Message Length Calculations:</div><div class="line"> *   nlmsg_msg_size(payload)		length of message w/o padding</div><div class="line"> *   nlmsg_total_size(payload)		length of message w/ padding</div><div class="line"> *   nlmsg_padlen(payload)		length of padding at tail</div><div class="line"> *</div><div class="line"> * Message Payload Access:</div><div class="line"> *   nlmsg_data(nlh)			head of message payload</div><div class="line"> *   nlmsg_len(nlh)			length of message payload</div><div class="line"> *   nlmsg_attrdata(nlh, hdrlen)	head of attributes data</div><div class="line"> *   nlmsg_attrlen(nlh, hdrlen)		length of attributes data</div><div class="line"> *</div><div class="line"> * Message Parsing:</div><div class="line"> *   nlmsg_ok(nlh, remaining)		does nlh fit into remaining bytes?</div><div class="line"> *   nlmsg_next(nlh, remaining)		get next netlink message</div><div class="line"> *   nlmsg_parse()			parse attributes of a message</div><div class="line"> *   nlmsg_find_attr()			find an attribute in a message</div><div class="line"> *   nlmsg_for_each_msg()		loop over all messages</div><div class="line"> *   nlmsg_validate()			validate netlink message incl. attrs</div><div class="line"> *   nlmsg_for_each_attr()		loop over all attributes</div><div class="line"> *</div><div class="line"> * Misc:</div><div class="line"> *   nlmsg_report()			report back to application?</div><div class="line"> *</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *                          Attributes Interface</div><div class="line"> * ------------------------------------------------------------------------</div><div class="line"> *</div><div class="line"> * Attribute Format:</div><div class="line"> *    &lt;------- nla_total_size(payload) -------&gt;</div><div class="line"> *    &lt;---- nla_attr_size(payload) -----&gt;</div><div class="line"> *   +----------+- - -+- - - - - - - - - +- - -+-------- - -</div><div class="line"> *   |  Header  | Pad |     Payload      | Pad |  Header</div><div class="line"> *   +----------+- - -+- - - - - - - - - +- - -+-------- - -</div><div class="line"> *                     &lt;- nla_len(nla) -&gt;      ^</div><div class="line"> *   nla_data(nla)----^                        |</div><div class="line"> *   nla_next(nla)-----------------------------'</div><div class="line"> *</div><div class="line"> * Data Structures:</div><div class="line"> *   struct nlattr			netlink attribute header</div><div class="line"> *</div><div class="line"> * Attribute Construction:</div><div class="line"> *   nla_reserve(skb, type, len)	reserve room for an attribute</div><div class="line"> *   nla_reserve_nohdr(skb, len)	reserve room for an attribute w/o hdr</div><div class="line"> *   nla_put(skb, type, len, data)	add attribute to skb</div><div class="line"> *   nla_put_nohdr(skb, len, data)	add attribute w/o hdr</div><div class="line"> *   nla_append(skb, len, data)		append data to skb</div><div class="line"> *</div><div class="line"> * Attribute Construction for Basic Types:</div><div class="line"> *   nla_put_u8(skb, type, value)	add u8 attribute to skb</div><div class="line"> *   nla_put_u16(skb, type, value)	add u16 attribute to skb</div><div class="line"> *   nla_put_u32(skb, type, value)	add u32 attribute to skb</div><div class="line"> *   nla_put_u64_64bit(skb, type,</div><div class="line"> *                     value, padattr)	add u64 attribute to skb</div><div class="line"> *   nla_put_s8(skb, type, value)	add s8 attribute to skb</div><div class="line"> *   nla_put_s16(skb, type, value)	add s16 attribute to skb</div><div class="line"> *   nla_put_s32(skb, type, value)	add s32 attribute to skb</div><div class="line"> *   nla_put_s64(skb, type, value,</div><div class="line"> *               padattr)		add s64 attribute to skb</div><div class="line"> *   nla_put_string(skb, type, str)	add string attribute to skb</div><div class="line"> *   nla_put_flag(skb, type)		add flag attribute to skb</div><div class="line"> *   nla_put_msecs(skb, type, jiffies,</div><div class="line"> *                 padattr)		add msecs attribute to skb</div><div class="line"> *   nla_put_in_addr(skb, type, addr)	add IPv4 address attribute to skb</div><div class="line"> *   nla_put_in6_addr(skb, type, addr)	add IPv6 address attribute to skb</div><div class="line"> *</div><div class="line"> * Nested Attributes Construction:</div><div class="line"> *   nla_nest_start(skb, type)		start a nested attribute</div><div class="line"> *   nla_nest_end(skb, nla)		finalize a nested attribute</div><div class="line"> *   nla_nest_cancel(skb, nla)		cancel nested attribute construction</div><div class="line"> *</div><div class="line"> * Attribute Length Calculations:</div><div class="line"> *   nla_attr_size(payload)		length of attribute w/o padding</div><div class="line"> *   nla_total_size(payload)		length of attribute w/ padding</div><div class="line"> *   nla_padlen(payload)		length of padding</div><div class="line"> *</div><div class="line"> * Attribute Payload Access:</div><div class="line"> *   nla_data(nla)			head of attribute payload</div><div class="line"> *   nla_len(nla)			length of attribute payload</div><div class="line"> *</div><div class="line"> * Attribute Payload Access for Basic Types:</div><div class="line"> *   nla_get_u8(nla)			get payload for a u8 attribute</div><div class="line"> *   nla_get_u16(nla)			get payload for a u16 attribute</div><div class="line"> *   nla_get_u32(nla)			get payload for a u32 attribute</div><div class="line"> *   nla_get_u64(nla)			get payload for a u64 attribute</div><div class="line"> *   nla_get_s8(nla)			get payload for a s8 attribute</div><div class="line"> *   nla_get_s16(nla)			get payload for a s16 attribute</div><div class="line"> *   nla_get_s32(nla)			get payload for a s32 attribute</div><div class="line"> *   nla_get_s64(nla)			get payload for a s64 attribute</div><div class="line"> *   nla_get_flag(nla)			return 1 if flag is true</div><div class="line"> *   nla_get_msecs(nla)			get payload for a msecs attribute</div><div class="line"> *</div><div class="line"> * Attribute Misc:</div><div class="line"> *   nla_memcpy(dest, nla, count)	copy attribute into memory</div><div class="line"> *   nla_memcmp(nla, data, size)	compare attribute with memory area</div><div class="line"> *   nla_strlcpy(dst, nla, size)	copy attribute to a sized string</div><div class="line"> *   nla_strcmp(nla, str)		compare attribute with string</div><div class="line"> *</div><div class="line"> * Attribute Parsing:</div><div class="line"> *   nla_ok(nla, remaining)		does nla fit into remaining bytes?</div><div class="line"> *   nla_next(nla, remaining)		get next netlink attribute</div><div class="line"> *   nla_validate()			validate a stream of attributes</div><div class="line"> *   nla_validate_nested()		validate a stream of nested attributes</div><div class="line"> *   nla_find()				find attribute in stream of attributes</div><div class="line"> *   nla_find_nested()			find attribute in nested attributes</div><div class="line"> *   nla_parse()			parse and validate stream of attrs</div><div class="line"> *   nla_parse_nested()			parse nested attribuets</div><div class="line"> *   nla_for_each_attr()		loop over all attributes</div><div class="line"> *   nla_for_each_nested()		loop over the nested attributes</div><div class="line"> *=========================================================================</div><div class="line"> */</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Standard attribute types to specify validation policy</div><div class="line">  */</div><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">	NLA_UNSPEC,</div><div class="line">	NLA_U8,</div><div class="line">	NLA_U16,</div><div class="line">	NLA_U32,</div><div class="line">	NLA_U64,</div><div class="line">	NLA_STRING,</div><div class="line">	NLA_FLAG,</div><div class="line">	NLA_MSECS,</div><div class="line">	NLA_NESTED,</div><div class="line">	NLA_NESTED_COMPAT,</div><div class="line">	NLA_NUL_STRING,</div><div class="line">	NLA_BINARY,</div><div class="line">	NLA_S8,</div><div class="line">	NLA_S16,</div><div class="line">	NLA_S32,</div><div class="line">	NLA_S64,</div><div class="line">	__NLA_TYPE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NLA_TYPE_MAX (__NLA_TYPE_MAX - 1)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * struct nla_policy - attribute validation policy</div><div class="line"> * @type: Type of attribute or NLA_UNSPEC</div><div class="line"> * @len: Type specific length of payload</div><div class="line"> *</div><div class="line"> * Policies are defined as arrays of this struct, the array must be</div><div class="line"> * accessible by attribute type up to the highest identifier to be expected.</div><div class="line"> *</div><div class="line"> * Meaning of `len' field:</div><div class="line"> *    NLA_STRING           Maximum length of string</div><div class="line"> *    NLA_NUL_STRING       Maximum length of string (excluding NUL)</div><div class="line"> *    NLA_FLAG             Unused</div><div class="line"> *    NLA_BINARY           Maximum length of attribute payload</div><div class="line"> *    NLA_NESTED           Don't use `len' field -- length verification is</div><div class="line"> *                         done by checking len of nested header (or empty)</div><div class="line"> *    NLA_NESTED_COMPAT    Minimum length of structure payload</div><div class="line"> *    NLA_U8, NLA_U16,</div><div class="line"> *    NLA_U32, NLA_U64,</div><div class="line"> *    NLA_S8, NLA_S16,</div><div class="line"> *    NLA_S32, NLA_S64,</div><div class="line"> *    NLA_MSECS            Leaving the length field zero will verify the</div><div class="line"> *                         given type fits, using it verifies minimum length</div><div class="line"> *                         just like "All other"</div><div class="line"> *    All other            Minimum length of attribute payload</div><div class="line"> *</div><div class="line"> * Example:</div><div class="line"> * static const struct nla_policy my_policy[ATTR_MAX+1] = &#123;</div><div class="line"> * 	[ATTR_FOO] = &#123; .type = NLA_U16 &#125;,</div><div class="line"> *	[ATTR_BAR] = &#123; .type = NLA_STRING, .len = BARSIZ &#125;,</div><div class="line"> *	[ATTR_BAZ] = &#123; .len = sizeof(struct mystruct) &#125;,</div><div class="line"> * &#125;;</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> &#123;</span></div><div class="line">	u16		type;</div><div class="line">	u16		len;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The comments explains itself very well. The source code of attributes of different expressions are all defined at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter/nf_tables.h" target="_blank" rel="noopener">include/uapi/linux/netfilter/nf_tables.h</a>. To get a feeling on how to write an array like this, just search the string “attributes” in this file. All definition of attributes should begin with an <code>UNSPEC</code> to leave space for internal usage.</p>
<p>The field <code>family</code> is the address family of your expression. Possible values can be found at <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/uapi/linux/netfilter.h#L59" target="_blank" rel="noopener">include/uapi/linux/netfilter.h#L59</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">	NFPROTO_UNSPEC =  <span class="number">0</span>,</div><div class="line">	NFPROTO_INET   =  <span class="number">1</span>,</div><div class="line">	NFPROTO_IPV4   =  <span class="number">2</span>,</div><div class="line">	NFPROTO_ARP    =  <span class="number">3</span>,</div><div class="line">	NFPROTO_NETDEV =  <span class="number">5</span>,</div><div class="line">	NFPROTO_BRIDGE =  <span class="number">7</span>,</div><div class="line">	NFPROTO_IPV6   = <span class="number">10</span>,</div><div class="line">	NFPROTO_DECNET = <span class="number">12</span>,</div><div class="line">	NFPROTO_NUMPROTO,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>The field <code>flags</code> are used to denote expression types. Currently, only one flag is available, that is if an expression is stateful. See <a href="http://elixir.free-electrons.com/linux/v4.13/source/include/net/netfilter/nf_tables.h#L707" target="_blank" rel="noopener">include/net/netfilter/nf_tables.h#L707</a>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFT_EXPR_STATEFUL		0x1</span></div></pre></td></tr></table></figure></p>
<h1 id="Summary-on-kernel-codes"><a href="#Summary-on-kernel-codes" class="headerlink" title="Summary on kernel codes"></a><a name="summary"></a>Summary on kernel codes</h1><p>Create an instance of <code>struct nft_expr_ops</code> for each operation of this expression. Implements its fields as in <a href="#nft_expr_ops">its definition</a>. Use <code>init</code>, <code>clone</code>, <code>destroy</code> to initialize, clone and destroy object. In <code>init</code>, read attributes from netlink and setup operation’s struct. Implement the core function of this operation in <code>eval</code>, tell kernel what to do by setting <code>regs-&gt;verdict.code</code>. In <code>dump</code>, send the attributes through netlink. Apply constraints to operations in <code>validate</code>.</p>
<p>Create an instance of <code>struct nft_expr_type</code> for your expression. Implements its fields as in <a href="#nft_expr_type">its definition</a>. If you have multiple operations that should be selected dynamically, implement <code>select_ops</code> otherwise set <code>ops</code>. Set <code>name</code>, <code>owner</code> according to your expression. If applicable, set address family at <code>family</code>. If applicable, use <code>flags</code> to indicate if your expression is stateful. Create an array of <code>struct nla_policy</code>, setup attribute information in that array, and set this array as <code>policy</code>. Set <code>maxattr</code> as the maximum number of attributes.</p>
<p>Call <code>nft_register_expr</code> to register your expression. Call <code>nft_unregister_expr</code> to unregister your expression.</p>
<h1 id="Writing-our-own-kernel-code"><a href="#Writing-our-own-kernel-code" class="headerlink" title="Writing our own kernel code"></a>Writing our own kernel code</h1><p>With the knowledge on how to write kernel codes, we are ready to write our own module to add our expression. Here we call our expression “abcde”</p>
<p>abcde.h:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _ABCDE_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _ABCDE_H</span></div><div class="line"></div><div class="line"><span class="keyword">enum</span> nft_abcde_attributes &#123;</div><div class="line">	NFTA_ABCDE_UNSPEC,</div><div class="line">	NFTA_ABCDE_TEXT,</div><div class="line">	__NFTA_ABCDE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NFTA_ABCDE_MAX (__NFTA_ABCDE_MAX - 1)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _ABCDE_H */</span></span></div></pre></td></tr></table></figure></p>
<p>abcde.c:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/netfilter/nf_tables.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"abcde.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ABCDE_TEXT_SIZE 128</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> &#123;</span></div><div class="line">	<span class="keyword">char</span> text[ABCDE_TEXT_SIZE];</div><div class="line">	<span class="keyword">int</span> len;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">match_packet</span><span class="params">(struct nft_abcde *priv, struct sk_buff *skb)</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> = <span class="title">tcp_hdr</span>(<span class="title">skb</span>);</span></div><div class="line">	<span class="keyword">char</span> *user_data = (<span class="keyword">char</span> *)((<span class="keyword">char</span> *)tcph + (tcph-&gt;doff * <span class="number">4</span>));</div><div class="line">	<span class="keyword">char</span> *tail = skb_tail_pointer(skb);</div><div class="line">	<span class="keyword">char</span> *p;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (p = user_data; p &lt; tail - priv-&gt;len; p++) &#123;</div><div class="line">		<span class="keyword">int</span> i; <span class="keyword">bool</span> found = <span class="literal">true</span>;</div><div class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; priv-&gt;len; i++)</div><div class="line">			<span class="keyword">if</span> (p[i] != priv-&gt;text[i]) &#123;</div><div class="line">				found = <span class="literal">false</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		<span class="keyword">if</span> (found)</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nla_policy</span> <span class="title">nft_abcde_policy</span>[<span class="title">NFTA_ABCDE_MAX</span> + 1] = &#123;</span></div><div class="line">	[NFTA_ABCDE_TEXT]		= &#123; .type = NLA_STRING, .len = ABCDE_TEXT_SIZE &#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_abcde_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr, struct nft_regs *regs, <span class="keyword">const</span> struct nft_pktinfo *pkt)</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span> = <span class="title">pkt</span>-&gt;<span class="title">skb</span>;</span></div><div class="line">	<span class="keyword">if</span>(match_packet(priv, skb))</div><div class="line">		regs-&gt;verdict.code = NFT_CONTINUE;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		regs-&gt;verdict.code = NFT_BREAK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_abcde_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, <span class="keyword">const</span> struct nft_expr *expr, <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span> </span>&#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">if</span> (tb[NFTA_ABCDE_TEXT] == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span> -EINVAL;</div><div class="line">	nla_strlcpy(priv-&gt;text, tb[NFTA_ABCDE_TEXT], ABCDE_TEXT_SIZE);</div><div class="line">	priv-&gt;len = <span class="built_in">strlen</span>(priv-&gt;text);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_abcde_dump</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nft_expr *expr)</span> </span>&#123;</div><div class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_abcde</span> *<span class="title">priv</span> = <span class="title">nft_expr_priv</span>(<span class="title">expr</span>);</span></div><div class="line">	<span class="keyword">if</span> (nla_put_string(skb, NFTA_ABCDE_TEXT, priv-&gt;text))</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_abcde_type</span>;</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_abcde_op</span> = &#123;</span></div><div class="line">	.eval = nft_abcde_eval,</div><div class="line">	.size = <span class="keyword">sizeof</span>(struct nft_abcde),</div><div class="line">	.init = nft_abcde_init,</div><div class="line">	.dump = nft_abcde_dump,</div><div class="line">	.type = &amp;nft_abcde_type,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_abcde_type</span> __<span class="title">read_mostly</span> =  &#123;</span></div><div class="line">	.ops = &amp;nft_abcde_op,</div><div class="line">	.name = <span class="string">"abcde"</span>,</div><div class="line">	.owner = THIS_MODULE,</div><div class="line">	.policy = nft_abcde_policy,</div><div class="line">	.maxattr = NFTA_ABCDE_MAX,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">nft_abcde_module_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> nft_register_expr(&amp;nft_abcde_type);</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">nft_abcde_module_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">	nft_unregister_expr(&amp;nft_abcde_type);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(nft_abcde_module_init);</div><div class="line">module_exit(nft_abcde_module_exit);</div><div class="line"></div><div class="line">MODULE_AUTHOR(<span class="string">"Xiang Gao"</span>);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line">MODULE_DESCRIPTION(<span class="string">"A sample nftables expression."</span>);</div></pre></td></tr></table></figure></p>
<p>Makefile:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">obj-m = abcde.o</div><div class="line">KVERSION = <span class="variable">$(<span class="built_in">shell</span> uname -r)</span></div><div class="line"><span class="section">all:</span></div><div class="line">	make -C /lib/modules/<span class="variable">$(KVERSION)</span>/build M=<span class="variable">$(PWD)</span> modules</div><div class="line"><span class="section">clean:</span></div><div class="line">	make -C /lib/modules/<span class="variable">$(KVERSION)</span>/build M=<span class="variable">$(PWD)</span> clean</div></pre></td></tr></table></figure></p>
<p>The complete source code for this example can be found at GitHub:<br><a href="https://github.com/zasdfgbnm/nftables-abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/nftables-abcde</a></p>
<h1 id="Modify-user-space-tool"><a href="#Modify-user-space-tool" class="headerlink" title="Modify user space tool"></a>Modify user space tool</h1><p>In order to be able to conveniently use our new expression “abcde”,  it would be good to modify the source code of user space tool, i.e. the <code>nft</code> command, to make it aware of our new expression. Extending the user space tool is easier. We first check it out from its git repository and switch to tag v0.7 (the newest release when this article is written):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git://git.netfilter.org/nftables</div><div class="line"><span class="built_in">cd</span> nftables</div><div class="line">git checkout v0.7 -b abcde</div></pre></td></tr></table></figure></p>
<p>To figure out where to modify, let’s run <code>grep</code> to see how the expression <code>reject</code> is implemented:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -i reject -r src include</div></pre></td></tr></table></figure></p>
<p>The above command will output something like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">src/datatype.c:         SYMBOL(&quot;reject-route&quot;,          ICMPV6_REJECT_ROUTE),</div><div class="line">......</div><div class="line">src/evaluate.c:static int reject_payload_gen_dependency_tcp(struct eval_ctx *ctx,</div><div class="line">......</div><div class="line">src/netlink_delinearize.c:static void netlink_parse_reject(struct netlink_parse_ctx *ctx,</div><div class="line">......</div><div class="line">src/parser_bison.y:%token _REJECT                       &quot;reject&quot;</div><div class="line">......</div><div class="line">src/scanner.l:&quot;reject&quot;          &#123; return _REJECT; &#125;</div><div class="line">src/statement.c:static void reject_stmt_print(const struct stmt *stmt)</div><div class="line">......</div><div class="line">include/linux/netfilter/nf_tables.h: * enum nft_reject_types - nf_tables reject expression reject types</div><div class="line">......</div><div class="line">include/statement.h:struct reject_stmt &#123;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>This tells us the files we may want to modify. A good start point is <code>scanner.l</code> and <code>parser_bison.y</code>. We can copy and paste the code for reject, replace it with our own thing.</p>
<p>After some try and error, we end up with the following patch generated by <code>git diff v0.7</code>:<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div></pre></td><td class="code"><pre><div class="line">diff --git a/include/statement.h b/include/statement.h</div><div class="line">index 277ff2f..9043790 100644</div><div class="line"><span class="comment">--- a/include/statement.h</span></div><div class="line"><span class="comment">+++ b/include/statement.h</span></div><div class="line">@@ -76,6 +76,12 @@ struct reject_stmt &#123;</div><div class="line"></div><div class="line"> extern struct stmt *reject_stmt_alloc(const struct location *loc);</div><div class="line"></div><div class="line"><span class="addition">+struct abcde_stmt &#123;</span></div><div class="line"><span class="addition">+	const char *	text;</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+extern struct stmt *abcde_stmt_alloc(const struct location *loc);</span></div><div class="line"><span class="addition">+</span></div><div class="line"> struct nat_stmt &#123;</div><div class="line"> 	enum nft_nat_types	type;</div><div class="line"> 	struct expr		*addr;</div><div class="line">@@ -199,6 +205,7 @@ extern struct stmt *xt_stmt_alloc(const struct location *loc);</div><div class="line">  * @STMT_LIMIT:		limit statement</div><div class="line">  * @STMT_LOG:		log statement</div><div class="line">  * @STMT_REJECT:	REJECT statement</div><div class="line"><span class="addition">+ * @STMT_ABCDE:		abcde statement</span></div><div class="line">  * @STMT_NAT:		NAT statement</div><div class="line">  * @STMT_MASQ:		masquerade statement</div><div class="line">  * @STMT_REDIR:		redirect statement</div><div class="line">@@ -222,6 +229,7 @@ enum stmt_types &#123;</div><div class="line"> 	STMT_LIMIT,</div><div class="line"> 	STMT_LOG,</div><div class="line"> 	STMT_REJECT,</div><div class="line"><span class="addition">+	STMT_ABCDE,</span></div><div class="line"> 	STMT_NAT,</div><div class="line"> 	STMT_MASQ,</div><div class="line"> 	STMT_REDIR,</div><div class="line">@@ -280,6 +288,7 @@ struct stmt &#123;</div><div class="line"> 		struct log_stmt		log;</div><div class="line"> 		struct limit_stmt	limit;</div><div class="line"> 		struct reject_stmt	reject;</div><div class="line"><span class="addition">+		struct abcde_stmt	abcde;</span></div><div class="line"> 		struct nat_stmt		nat;</div><div class="line"> 		struct masq_stmt	masq;</div><div class="line"> 		struct redir_stmt	redir;</div><div class="line">diff --git a/src/evaluate.c b/src/evaluate.c</div><div class="line">index 8a3da54..751d702 100644</div><div class="line"><span class="comment">--- a/src/evaluate.c</span></div><div class="line"><span class="comment">+++ b/src/evaluate.c</span></div><div class="line">@@ -2495,6 +2495,8 @@ int stmt_evaluate(struct eval_ctx *ctx, struct stmt *stmt)</div><div class="line"> 		return stmt_evaluate_ct(ctx, stmt);</div><div class="line"> 	case STMT_LOG:</div><div class="line"> 		return stmt_evaluate_log(ctx, stmt);</div><div class="line"><span class="addition">+	case STMT_ABCDE:</span></div><div class="line"><span class="addition">+		return 0;</span></div><div class="line"> 	case STMT_REJECT:</div><div class="line"> 		return stmt_evaluate_reject(ctx, stmt);</div><div class="line"> 	case STMT_NAT:</div><div class="line">diff --git a/src/netlink_delinearize.c b/src/netlink_delinearize.c</div><div class="line">index cb0f6ac..f8b83a6 100644</div><div class="line"><span class="comment">--- a/src/netlink_delinearize.c</span></div><div class="line"><span class="comment">+++ b/src/netlink_delinearize.c</span></div><div class="line">@@ -799,6 +799,16 @@ static void netlink_parse_reject(struct netlink_parse_ctx *ctx,</div><div class="line"> 	ctx-&gt;stmt = stmt;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void netlink_parse_abcde(struct netlink_parse_ctx *ctx,</span></div><div class="line"><span class="addition">+				 const struct location *loc,</span></div><div class="line"><span class="addition">+				 const struct nftnl_expr *expr)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct stmt *stmt;</span></div><div class="line"><span class="addition">+	stmt = abcde_stmt_alloc(loc);</span></div><div class="line"><span class="addition">+	stmt-&gt;abcde.text = xstrdup(nftnl_expr_get_str(expr, NFTNL_EXPR_ABCDE_TEXT));</span></div><div class="line"><span class="addition">+	ctx-&gt;stmt = stmt;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void netlink_parse_nat(struct netlink_parse_ctx *ctx,</div><div class="line"> 			      const struct location *loc,</div><div class="line"> 			      const struct nftnl_expr *nle)</div><div class="line">@@ -1144,6 +1154,7 @@ static const struct &#123;</div><div class="line"> 	&#123; .name = "limit",	.parse = netlink_parse_limit &#125;,</div><div class="line"> 	&#123; .name = "range",	.parse = netlink_parse_range &#125;,</div><div class="line"> 	&#123; .name = "reject",	.parse = netlink_parse_reject &#125;,</div><div class="line"><span class="addition">+	&#123; .name = "abcde",	.parse = netlink_parse_abcde &#125;,</span></div><div class="line"> 	&#123; .name = "nat",	.parse = netlink_parse_nat &#125;,</div><div class="line"> 	&#123; .name = "notrack",	.parse = netlink_parse_notrack &#125;,</div><div class="line"> 	&#123; .name = "masq",	.parse = netlink_parse_masq &#125;,</div><div class="line">diff --git a/src/netlink_linearize.c b/src/netlink_linearize.c</div><div class="line">index 0915038..893ae7e 100644</div><div class="line"><span class="comment">--- a/src/netlink_linearize.c</span></div><div class="line"><span class="comment">+++ b/src/netlink_linearize.c</span></div><div class="line">@@ -874,6 +874,18 @@ static void netlink_gen_reject_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 	nftnl_rule_add_expr(ctx-&gt;nlr, nle);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void netlink_gen_abcde_stmt(struct netlink_linearize_ctx *ctx,</span></div><div class="line"><span class="addition">+				    const struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr *nle;</span></div><div class="line"><span class="addition">+	nle = alloc_nft_expr("abcde");</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (stmt-&gt;abcde.text != NULL) &#123;</span></div><div class="line"><span class="addition">+		nftnl_expr_set_str(nle, NFTNL_EXPR_ABCDE_TEXT, stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	nftnl_rule_add_expr(ctx-&gt;nlr, nle);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void netlink_gen_nat_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 				 const struct stmt *stmt)</div><div class="line"> &#123;</div><div class="line">@@ -1200,6 +1212,8 @@ static void netlink_gen_stmt(struct netlink_linearize_ctx *ctx,</div><div class="line"> 		return netlink_gen_log_stmt(ctx, stmt);</div><div class="line"> 	case STMT_REJECT:</div><div class="line"> 		return netlink_gen_reject_stmt(ctx, stmt);</div><div class="line"><span class="addition">+	case STMT_ABCDE:</span></div><div class="line"><span class="addition">+		return netlink_gen_abcde_stmt(ctx, stmt);</span></div><div class="line"> 	case STMT_NAT:</div><div class="line"> 		return netlink_gen_nat_stmt(ctx, stmt);</div><div class="line"> 	case STMT_MASQ:</div><div class="line">diff --git a/src/parser_bison.y b/src/parser_bison.y</div><div class="line">index deaaf06..ac16c72 100644</div><div class="line"><span class="comment">--- a/src/parser_bison.y</span></div><div class="line"><span class="comment">+++ b/src/parser_bison.y</span></div><div class="line">@@ -399,6 +399,7 @@ static void location_update(struct location *loc, struct location *rhs, int n)</div><div class="line"> %token RANDOM			"random"</div><div class="line"> %token FULLY_RANDOM		"fully-random"</div><div class="line"> %token PERSISTENT		"persistent"</div><div class="line"><span class="addition">+%token ABCDE			"abcde"</span></div><div class="line"></div><div class="line"> %token QUEUE			"queue"</div><div class="line"> %token QUEUENUM			"num"</div><div class="line">@@ -499,6 +500,8 @@ static void location_update(struct location *loc, struct location *rhs, int n)</div><div class="line"> %type &lt;val&gt;			set_stmt_op</div><div class="line"> %type &lt;stmt&gt;			flow_stmt flow_stmt_alloc</div><div class="line"> %destructor &#123; stmt_free($$); &#125;	flow_stmt flow_stmt_alloc</div><div class="line"><span class="addition">+%type &lt;stmt&gt;			abcde_stmt abcde_stmt_alloc</span></div><div class="line"><span class="addition">+%destructor &#123; stmt_free($$); &#125;	abcde_stmt abcde_stmt_alloc</span></div><div class="line"></div><div class="line"> %type &lt;expr&gt;			symbol_expr verdict_expr integer_expr variable_expr</div><div class="line"> %destructor &#123; expr_free($$); &#125;	symbol_expr verdict_expr integer_expr variable_expr</div><div class="line">@@ -1400,6 +1403,7 @@ stmt			:	verdict_stmt</div><div class="line"> 			|	limit_stmt</div><div class="line"> 			|	quota_stmt</div><div class="line"> 			|	reject_stmt</div><div class="line"><span class="addition">+			|	abcde_stmt</span></div><div class="line"> 			|	nat_stmt</div><div class="line"> 			|	queue_stmt</div><div class="line"> 			|	ct_stmt</div><div class="line">@@ -1736,6 +1740,21 @@ reject_opts		:       /* empty */</div><div class="line"> 			&#125;</div><div class="line"> 			;</div><div class="line"></div><div class="line"><span class="addition">+abcde_stmt		:	abcde_stmt_alloc	abcde_opts</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+abcde_stmt_alloc	:	ABCDE</span></div><div class="line"><span class="addition">+			&#123;</span></div><div class="line"><span class="addition">+				$$ = abcde_stmt_alloc(&amp;@$);</span></div><div class="line"><span class="addition">+			&#125;</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+abcde_opts		:	string</span></div><div class="line"><span class="addition">+			&#123;</span></div><div class="line"><span class="addition">+				$&lt;stmt&gt;0-&gt;abcde.text = $1;</span></div><div class="line"><span class="addition">+			&#125;</span></div><div class="line"><span class="addition">+			;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> nat_stmt		:	nat_stmt_alloc	nat_stmt_args</div><div class="line"> 			;</div><div class="line"></div><div class="line">diff --git a/src/scanner.l b/src/scanner.l</div><div class="line">index 625023f..595db76 100644</div><div class="line"><span class="comment">--- a/src/scanner.l</span></div><div class="line"><span class="comment">+++ b/src/scanner.l</span></div><div class="line">@@ -333,6 +333,7 @@ addrstring	(&#123;macaddr&#125;|&#123;ip4addr&#125;|&#123;ip6addr&#125;)</div><div class="line"> "random"		&#123; return RANDOM; &#125;</div><div class="line"> "fully-random"		&#123; return FULLY_RANDOM; &#125;</div><div class="line"> "persistent"		&#123; return PERSISTENT; &#125;</div><div class="line"><span class="addition">+"abcde"             &#123; return ABCDE; &#125;</span></div><div class="line"></div><div class="line"> "ll"			&#123; return LL_HDR; &#125;</div><div class="line"> "nh"			&#123; return NETWORK_HDR; &#125;</div><div class="line">diff --git a/src/statement.c b/src/statement.c</div><div class="line">index e70eb51..29b8015 100644</div><div class="line"><span class="comment">--- a/src/statement.c</span></div><div class="line"><span class="comment">+++ b/src/statement.c</span></div><div class="line">@@ -417,6 +417,28 @@ struct stmt *reject_stmt_alloc(const struct location *loc)</div><div class="line"> 	return stmt_alloc(loc, &amp;reject_stmt_ops);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="addition">+static void abcde_stmt_print(const struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	printf("abcde \"%s\"", stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void abcde_stmt_destroy(struct stmt *stmt)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	xfree(stmt-&gt;abcde.text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static const struct stmt_ops abcde_stmt_ops = &#123;</span></div><div class="line"><span class="addition">+	.type		= STMT_ABCDE,</span></div><div class="line"><span class="addition">+	.name		= "abcde",</span></div><div class="line"><span class="addition">+	.print		= abcde_stmt_print,</span></div><div class="line"><span class="addition">+	.destroy	= abcde_stmt_destroy,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct stmt *abcde_stmt_alloc(const struct location *loc)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	return stmt_alloc(loc, &amp;abcde_stmt_ops);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> static void print_nf_nat_flags(uint32_t flags)</div><div class="line"> &#123;</div><div class="line"> 	const char *delim = " ";</div></pre></td></tr></table></figure></p>
<p>Same thing applies to libnftnl, we clone the repository and checkout the tag libnftnl-1.0.7:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git://git.netfilter.org/libnftnl</div><div class="line"><span class="built_in">cd</span> libnftnl</div><div class="line">git checkout libnftnl-1.0.7 -b abcde</div></pre></td></tr></table></figure></p>
<p>After some try and error, we end up with the following patch using command <code>git diff libnftnl-1.0.7</code>:<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line">diff --git a/include/libnftnl/expr.h b/include/libnftnl/expr.h</div><div class="line">index 74e986d..26259a7 100644</div><div class="line"><span class="comment">--- a/include/libnftnl/expr.h</span></div><div class="line"><span class="comment">+++ b/include/libnftnl/expr.h</span></div><div class="line">@@ -186,6 +186,10 @@ enum &#123;</div><div class="line"> 	NFTNL_EXPR_REJECT_CODE,</div><div class="line"> &#125;;</div><div class="line"></div><div class="line"><span class="addition">+enum &#123;</span></div><div class="line"><span class="addition">+	NFTNL_EXPR_ABCDE_TEXT	= NFTNL_EXPR_BASE,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"> enum &#123;</div><div class="line"> 	NFTNL_EXPR_QUEUE_NUM	= NFTNL_EXPR_BASE,</div><div class="line"> 	NFTNL_EXPR_QUEUE_TOTAL,</div><div class="line">diff --git a/include/linux/netfilter/abcde.h b/include/linux/netfilter/abcde.h</div><div class="line">new file mode 100644</div><div class="line">index 0000000..eb027a7</div><div class="line"><span class="comment">--- /dev/null</span></div><div class="line"><span class="comment">+++ b/include/linux/netfilter/abcde.h</span></div><div class="line"><span class="meta">@@ -0,0 +1,12 @@</span></div><div class="line"><span class="addition">+#ifndef _ABCDE_H</span></div><div class="line"><span class="addition">+#define _ABCDE_H</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+enum nft_abcde_attributes &#123;</span></div><div class="line"><span class="addition">+	NFTA_ABCDE_UNSPEC,</span></div><div class="line"><span class="addition">+	NFTA_ABCDE_TEXT,</span></div><div class="line"><span class="addition">+	__NFTA_ABCDE_MAX,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#define NFTA_ABCDE_MAX (__NFTA_ABCDE_MAX - 1)</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#endif /* _ABCDE_H */</span></div><div class="line">diff --git a/src/Makefile.am b/src/Makefile.am</div><div class="line">index 485a8c4..a9cb87d 100644</div><div class="line"><span class="comment">--- a/src/Makefile.am</span></div><div class="line"><span class="comment">+++ b/src/Makefile.am</span></div><div class="line">@@ -35,6 +35,7 @@ libnftnl_la_SOURCES = utils.c		\</div><div class="line"> 		      expr/fwd.c	\</div><div class="line"> 		      expr/limit.c	\</div><div class="line"> 		      expr/log.c	\</div><div class="line"><span class="addition">+		      expr/abcde.c	\</span></div><div class="line"> 		      expr/lookup.c	\</div><div class="line"> 		      expr/dynset.c	\</div><div class="line"> 		      expr/immediate.c	\</div><div class="line">diff --git a/src/expr/abcde.c b/src/expr/abcde.c</div><div class="line">new file mode 100644</div><div class="line">index 0000000..e76abd4</div><div class="line"><span class="comment">--- /dev/null</span></div><div class="line"><span class="comment">+++ b/src/expr/abcde.c</span></div><div class="line"><span class="meta">@@ -0,0 +1,183 @@</span></div><div class="line"><span class="addition">+#include &lt;stdio.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;stdint.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;string.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;arpa/inet.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;errno.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;linux/netfilter/nf_tables.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;linux/netfilter/abcde.h&gt;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+#include "internal.h"</span></div><div class="line"><span class="addition">+#include &lt;libmnl/libmnl.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;libnftnl/expr.h&gt;</span></div><div class="line"><span class="addition">+#include &lt;libnftnl/rule.h&gt;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct nftnl_expr_abcde &#123;</span></div><div class="line"><span class="addition">+	const char		*text;</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_set(struct nftnl_expr *e, uint16_t type,</span></div><div class="line"><span class="addition">+				 const void *data, uint32_t data_len)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	switch(type)&#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		abcde-&gt;text = strdup(data);</span></div><div class="line"><span class="addition">+		if (!abcde-&gt;text)</span></div><div class="line"><span class="addition">+			return -1;</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static const void *</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_get(const struct nftnl_expr *e, uint16_t type,</span></div><div class="line"><span class="addition">+		      uint32_t *data_len)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		*data_len = strlen(abcde-&gt;text)+1;</span></div><div class="line"><span class="addition">+		return abcde-&gt;text;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return NULL;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_cb(const struct nlattr *attr, void *data)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	const struct nlattr **tb = data;</span></div><div class="line"><span class="addition">+	int type = mnl_attr_get_type(attr);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (mnl_attr_type_valid(attr, NFTA_ABCDE_MAX) &lt; 0)</span></div><div class="line"><span class="addition">+		return MNL_CB_OK;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_EXPR_ABCDE_TEXT:</span></div><div class="line"><span class="addition">+		if (mnl_attr_validate(attr, MNL_TYPE_STRING) &lt; 0)</span></div><div class="line"><span class="addition">+			abi_breakage();</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	tb[type] = attr;</span></div><div class="line"><span class="addition">+	return MNL_CB_OK;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_build(struct nlmsghdr *nlh, const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT))</span></div><div class="line"><span class="addition">+		mnl_attr_put_strz(nlh, NFTNL_EXPR_ABCDE_TEXT, abcde-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_parse(struct nftnl_expr *e, struct nlattr *attr)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	struct nlattr *tb[NFTA_ABCDE_MAX+1] = &#123;&#125;;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (mnl_attr_parse_nested(attr, nftnl_expr_abcde_cb, tb) &lt; 0)</span></div><div class="line"><span class="addition">+		return -1;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (tb[NFTNL_EXPR_ABCDE_TEXT]) &#123;</span></div><div class="line"><span class="addition">+		if (abcde-&gt;text)</span></div><div class="line"><span class="addition">+			xfree(abcde-&gt;text);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+		abcde-&gt;text = strdup(mnl_attr_get_str(tb[NFTNL_EXPR_ABCDE_TEXT]));</span></div><div class="line"><span class="addition">+		if (!abcde-&gt;text)</span></div><div class="line"><span class="addition">+			return -1;</span></div><div class="line"><span class="addition">+		e-&gt;flags |= (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_json_parse(struct nftnl_expr *e, json_t *root,</span></div><div class="line"><span class="addition">+					struct nftnl_parse_err *err)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+#ifdef JSON_PARSING</span></div><div class="line"><span class="addition">+	const char *text;</span></div><div class="line"><span class="addition">+	uint16_t group, qthreshold;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	text = nftnl_jansson_parse_str(root, "text", err);</span></div><div class="line"><span class="addition">+	if (text != NULL)</span></div><div class="line"><span class="addition">+		nftnl_expr_set_str(e, NFTNL_EXPR_ABCDE_TEXT, text);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return 0;</span></div><div class="line"><span class="addition">+#else</span></div><div class="line"><span class="addition">+	errno = EOPNOTSUPP;</span></div><div class="line"><span class="addition">+	return -1;</span></div><div class="line"><span class="addition">+#endif</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_snprintf_default(char *buf, size_t size,</span></div><div class="line"><span class="addition">+					   const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	int ret, offset = 0, len = size;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT)) &#123;</span></div><div class="line"><span class="addition">+		ret = snprintf(buf, len, "text %s ", abcde-&gt;text);</span></div><div class="line"><span class="addition">+		SNPRINTF_BUFFER_SIZE(ret, size, len, offset);</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return offset;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int nftnl_expr_abcde_export(char *buf, size_t size,</span></div><div class="line"><span class="addition">+				 const struct nftnl_expr *e, int type)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+	NFTNL_BUF_INIT(b, buf, size);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	if (e-&gt;flags &amp; (1 &lt;&lt; NFTNL_EXPR_ABCDE_TEXT))</span></div><div class="line"><span class="addition">+		nftnl_buf_str(&amp;b, type, abcde-&gt;text, "text");</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	return nftnl_buf_done(&amp;b);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static int</span></div><div class="line"><span class="addition">+nftnl_expr_abcde_snprintf(char *buf, size_t len, uint32_t type,</span></div><div class="line"><span class="addition">+			uint32_t flags, const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	switch(type) &#123;</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_DEFAULT:</span></div><div class="line"><span class="addition">+		return nftnl_expr_abcde_snprintf_default(buf, len, e);</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_XML:</span></div><div class="line"><span class="addition">+	case NFTNL_OUTPUT_JSON:</span></div><div class="line"><span class="addition">+		return nftnl_expr_abcde_export(buf, len, e, type);</span></div><div class="line"><span class="addition">+	default:</span></div><div class="line"><span class="addition">+		break;</span></div><div class="line"><span class="addition">+	&#125;</span></div><div class="line"><span class="addition">+	return -1;</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static void nftnl_expr_abcde_free(const struct nftnl_expr *e)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *abcde = nftnl_expr_data(e);</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+	xfree(abcde-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+static bool nftnl_expr_abcde_cmp(const struct nftnl_expr *e1,</span></div><div class="line"><span class="addition">+				     const struct nftnl_expr *e2)</span></div><div class="line"><span class="addition">+&#123;</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *l1 = nftnl_expr_data(e1);</span></div><div class="line"><span class="addition">+	struct nftnl_expr_abcde *l2 = nftnl_expr_data(e2);</span></div><div class="line"><span class="addition">+	return !strcmp(l1-&gt;text, l2-&gt;text);</span></div><div class="line"><span class="addition">+&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line"><span class="addition">+struct expr_ops expr_ops_abcde = &#123;</span></div><div class="line"><span class="addition">+	.name		= "abcde",</span></div><div class="line"><span class="addition">+	.alloc_len	= sizeof(struct nftnl_expr_abcde),</span></div><div class="line"><span class="addition">+	.max_attr	= NFTA_ABCDE_MAX,</span></div><div class="line"><span class="addition">+	.free		= nftnl_expr_abcde_free,</span></div><div class="line"><span class="addition">+	.cmp		= nftnl_expr_abcde_cmp,</span></div><div class="line"><span class="addition">+	.set		= nftnl_expr_abcde_set,</span></div><div class="line"><span class="addition">+	.get		= nftnl_expr_abcde_get,</span></div><div class="line"><span class="addition">+	.parse		= nftnl_expr_abcde_parse,</span></div><div class="line"><span class="addition">+	.build		= nftnl_expr_abcde_build,</span></div><div class="line"><span class="addition">+	.snprintf	= nftnl_expr_abcde_snprintf,</span></div><div class="line"><span class="addition">+	.json_parse	= nftnl_expr_abcde_json_parse,</span></div><div class="line"><span class="addition">+&#125;;</span></div><div class="line">diff --git a/src/expr_ops.c b/src/expr_ops.c</div><div class="line">index 7a0e1e3..a02878c 100644</div><div class="line"><span class="comment">--- a/src/expr_ops.c</span></div><div class="line"><span class="comment">+++ b/src/expr_ops.c</span></div><div class="line">@@ -33,6 +33,7 @@ extern struct expr_ops expr_ops_target;</div><div class="line"> extern struct expr_ops expr_ops_dynset;</div><div class="line"> extern struct expr_ops expr_ops_hash;</div><div class="line"> extern struct expr_ops expr_ops_fib;</div><div class="line"><span class="addition">+extern struct expr_ops expr_ops_abcde;</span></div><div class="line"></div><div class="line"> static struct expr_ops expr_ops_notrack = &#123;</div><div class="line"> 	.name	= "notrack",</div><div class="line">@@ -69,6 +70,7 @@ static struct expr_ops *expr_ops[] = &#123;</div><div class="line"> 	&amp;expr_ops_hash,</div><div class="line"> 	&amp;expr_ops_fib,</div><div class="line"> 	&amp;expr_ops_objref,</div><div class="line"><span class="addition">+	&amp;expr_ops_abcde,</span></div><div class="line"> 	NULL,</div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>
<p>The abcde branch of nftables and libnftnl can be found at GitHub:<br><a href="https://github.com/zasdfgbnm/nftables/tree/abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/nftables/tree/abcde</a><br><a href="https://github.com/zasdfgbnm/libnftnl/tree/abcde" target="_blank" rel="noopener">https://github.com/zasdfgbnm/libnftnl/tree/abcde</a></p>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>Our new module can be tested by inserting our module, and then using our self-compiled nft tool to add a rule that looks like:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PREFIX=/home/gaoxiang/tmp/test_nftables</div><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$PREFIX</span>/lib</div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add table ip <span class="built_in">test</span></div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add chain <span class="built_in">test</span> <span class="built_in">test</span> \&#123; <span class="built_in">type</span> filter hook postrouting priority 0\; \&#125;</div><div class="line"><span class="variable">$PREFIX</span>/sbin/nft add rule ip <span class="built_in">test</span> <span class="built_in">test</span> tcp sport 4000 abcde darkhttpd <span class="built_in">log</span> prefix <span class="string">"darkhttpd___"</span></div></pre></td></tr></table></figure></p>
<p>Open a darkhttpd server, access to it, and the output of <code>dmesg</code> will looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[ 2427.056229] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=43690 RES=0x00 ACK SYN URGP=0</div><div class="line">[ 2427.094038] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9012 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK URGP=0</div><div class="line">[ 2427.094162] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=269 TOS=0x00 PREC=0x00 TTL=64 ID=9013 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.094216] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=97 TOS=0x00 PREC=0x00 TTL=64 ID=9014 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=357 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.361198] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=246 TOS=0x00 PREC=0x00 TTL=64 ID=9015 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2427.361215] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=258 TOS=0x00 PREC=0x00 TTL=64 ID=9016 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK PSH URGP=0</div><div class="line">[ 2475.658088] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9017 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div><div class="line">[ 2521.747363] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9018 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div><div class="line">[ 2567.826378] darkhttpd___IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=9019 DF PROTO=TCP SPT=4000 DPT=36840 WINDOW=372 RES=0x00 ACK URGP=0</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;I’m recently writing something that uses Linux’s firewall framework to do some non-standard operations packets. Extending the kernel is required for my task but unfortunately documentations about this topic I find online are quite dated. These old documents are mainly for kernel version 2.4 and earlier 2.6.x, in which new matches or targets are registered by calling &lt;code&gt;ipt_register_match&lt;/code&gt; and &lt;code&gt;ipt_register_target&lt;/code&gt;. The related subsystem of kernel has changed a lot since then, and iptables has been replaced by nftables. Although we can use &lt;code&gt;xt_register_match&lt;/code&gt; and &lt;code&gt;xt_register_target&lt;/code&gt; instead, I prefer to move to the new nftables framework. Due to the lack of documentation, I have to dig into the source code of Linux kernel to figure out how things works, and this post is the note for that. As Linus Torvalds says in 2008, “Linux is evolution, not intelligent design”, the design and API of nftables might be changing very fast. So I’m not only trying to make a brief review on the design or API of nftables. But also, this post will serve as a guide on how to find the correct way of doing things by reading the kernel source code. The eager reader can go directly to &lt;a href=&quot;#summary&quot;&gt;the summary section&lt;/a&gt;. This post is based on kernel version 4.13, the most recent version when this post is started writing.&lt;/p&gt;
&lt;p&gt;Here in this post, we will solve a toy problem: monitor all outgoing TCP traffic from port 80, if it contains the string given by the user, log it. I don’t assume any knowledge in the design or kernel API of nftables, but I do assume the reader has read and understand well &lt;a href=&quot;https://wiki.nftables.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;the official documents on how to use nftables&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/tags/Linux/"/>
    
      <category term="Kernel" scheme="https://zasdfgbnm.github.io/tags/Kernel/"/>
    
      <category term="nftables" scheme="https://zasdfgbnm.github.io/tags/nftables/"/>
    
      <category term="network" scheme="https://zasdfgbnm.github.io/tags/network/"/>
    
      <category term="netfilter" scheme="https://zasdfgbnm.github.io/tags/netfilter/"/>
    
  </entry>
  
  <entry>
    <title>Rademacher复杂度学习笔记</title>
    <link href="https://zasdfgbnm.github.io/2017/07/06/Rademacher%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://zasdfgbnm.github.io/2017/07/06/Rademacher复杂度学习笔记/</id>
    <published>2017-07-07T02:40:59.000Z</published>
    <updated>2017-07-07T20:02:18.885Z</updated>
    
    <content type="html"><![CDATA[<p>计算学习理论中的一类很重要的问题是研究训练集训练出来的模型在训练集以外的表现，即泛化误差（generalization error）。我们来考虑这样一个问题，我们想要拟合目标函数$f:\mathcal{X}\to\mathbb{R}$，为此，我们选取假设空间（hypothesis space） $\mathcal{H}$，然后通过某种方法获得一个训练集$S=\left\{(x_1,f(x_1)),(x_2,f(x_2)),\ldots(x_m,f(x_m))\right\}$。这个训练集被认为是从$\mathcal{X}$上的概率分布$\mathcal{P}$进行独立同分布的抽样而来。获得训练集以后，我们把训练集作为输入输送给某个优化算法$\mathscr{A}$。这个算法本身可能是带有随机性的，比如SGD，但是如果把算法使用的随机数发生器生成的随机数也看成算法的输入的话，那么这个优化算法就没有任何随机可言，给定一个训练集$S$以及随机数$\theta$，算法输出唯一的$h=\mathscr{A}(S,\theta)\in\mathcal{H}$。如果我们使用$\mathfrak{l}:\mathbb{R}\times\mathbb{R}\to\mathbb{R}_{\ge0}$作为损失函数来衡量$f$与$g$的差异的话，我们关心的是，当我们的训练误差为$\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]:=\frac{1}{m}\sum_{i=1}^m\mathfrak{l}(h(x_i),f(x_i))$时，我们有多大的置信度来保证这个算法的输出的$h$的泛化误差$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]$比训练误差不会高出超过$\epsilon$，即<br>$$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\leq\epsilon$$</p>
<a id="more"></a>
<p>作为算法的输出，$h$依赖于具体选取的优化算法，以及提供给算法的随机数，这些都不是什么方便研究的东西，于是通常情况下将这层信息抹去。要将这层信息抹去，我们将上式的要求收紧：我们不仅仅要求算法输出的$h$满足上式，而是要求$\mathcal{H}$中的所有元素都满足上式要求。写成式子就是：<br>$$\sup_{h\in\mathcal{H}}\left\{\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right\}\leq\epsilon$$</p>
<p>我们将上式左边的部分记为$\varphi(S)$。由于要求更苛刻了，所以我们估算出来的置信度是更悲观的。实际上的置信度要比估算出来的大一些，即：<br>$$\mathrm{Pr}\left(\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\leq\epsilon\right)\geq\mathrm{Pr}\left(\varphi(S)\leq\epsilon\right)$$也就是说，通过估算$\mathcal{P}\left(\varphi(S)\leq\epsilon\right)$，我们可以找到我们最终想要的置信度的一个下界。</p>
<p>下面就来考察$\varphi(S)\leq\epsilon$这个条件。首先来思考一个问题：在保证大的置信度的前提下，$\epsilon$的值我们能往下压到多小呢？我们可以通过加大样本的数量来把$\epsilon$压到任意接近于$0$吗？如果我们对$\mathcal{H}$不加任何限定的话，答案是否定的。为了说明这一点，我们来考虑$\mathcal{H}$是所有$\mathcal{X}\to\mathbb{R}$的函数的集合的情况：通常情况下，我们遇到的问题中的$\mathcal{X}$都是某个$\mathbb{R}^n$，而$\mathcal{P}$则是一个相对于$\mathcal{X}$上的Lebesgue测度绝对连续的概率测度。而$S$呢？一个Lebesgue零测集而已，存在感为零。来看泛化误差吧，根据其定义：$$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]=\int\mathfrak{l}(h(x),f(x))d\mathcal{P}(x)$$我们非常容易就能找到一个与$f$相去甚远的$h$，这样上述Lebesgue积分的值可以任意大，然后我们把$S$上$h$的值替换为$f$在$S$上的值，上述Lebesgue积分的值仍然保持不变，然而训练误差却变成了$0$。</p>
<p>上面的思考告诉我们，$\epsilon$的值能往下压到多小是取决于$\mathcal{H}$的性质的。为了能把$\epsilon$的值能往下压，我们必须要对$\mathcal{H}$进行一些限制。而本文所讨论的Rademacher复杂度就是这样一个限制。为了推导出Rademacher复杂度的相关定理，我们将$\varphi(S)$拆成两部分：<br>$$\varphi(S)=\mathrm{E}_S[\varphi(S)]+\left(\varphi(S)-\mathrm{E}_S[\varphi(S)]\right)$$其中$\mathrm{E}_S[\cdot]$表示针对$S$根据其概率（$m$个分布为$\mathcal{P}$的独立同分布的联合概率）求取期望。这两部分的含义我们可以这样直观地理解：设想我们在打靶，砰砰砰若干枪射出去了以后，我们在靶上打下了若干弹孔。这些弹孔的中心（平均位置）代表我们打靶的准确度。如果我们的弹孔中心不在靶心，而是有个整体偏移，这就说明我们的瞄准方法不当，导致没有瞄准到靶心。而这些弹孔的散布，则说明我们的稳定性，如果我们的弹孔散布很大四处都有，这就说明我们打枪的时候手抖得厉害。上面公式中的第一部分$\mathrm{E}_S[\varphi(S)]$相当于打枪弹孔的中心位置，而第二部分$\varphi(S)-\mathrm{E}_S[\varphi(S)]$则相当于每个弹孔相对于中心位置的相对位置。那么，中心位置跟相对位置又分别代表了什么呢？我们来思考一下为什么泛化误差通常会比训练误差大吧：</p>
<p>一方面，我们的假设空间$\mathcal{H}$并不是只有少数几个元素，而是有非常多的元素的。多到即使把$m$个点的值固定下来，不管这$m$个点具体是什么点，也都远远不足以唯一确定一个$h$。相反，不管取哪$m$个点，总会有很多个$h\in\mathcal{H}$与$f$在这$m$个点处吻合很好并且在这$m$个点之外的地方仍然保持一定的任意性。不要忘了，我们研究的$\varphi(S)$可是要从所有这些吻合的$h$中挑选一个泛化误差最不好的，而$h$在这$m$个点外的这种任意性就给了泛化误差上升的空间。这种独立于这$m$个点的具体的选取方式的效应，造成的泛化误差的上升对于$\varphi(S)$的贡献就是$\mathrm{E}_S[\varphi(S)]$。由于与这$m$个点的选取无关，这种效应是不具有随机性的，它仅与$\mathcal{H}$的性质有关。</p>
<p>另一方面，具体选取的这$m$个点不一样，自然也会给$h$带来不同大小的任意性。因此，泛化误差比训练误差多出来的那部分$\varphi(S)$不会是一成不变的$\mathrm{E}_S[\varphi(S)]$，而是会根据具体的$S$的值在$\mathrm{E}_S[\varphi(S)]$附近上下波动。这部分对$\varphi(S)$的贡献则是$\varphi(S)-\mathrm{E}_S[\varphi(S)]$。由于$S$是随机选取的，这部分是个随机问题。</p>
<p>我们既然想要以比较大的置信度断定$\varphi(S)$比较小，这就相当于要求射击选手能够稳定发挥，保证子弹在靶心附近不远，不会出差错。要达到这点要求，射击选手既要保证自己打靶的准确度高，也要保证自己打靶子弹的散布是比较小，二者缺一不可。</p>
<p>先来看第二部分$\varphi(S)-\mathrm{E}_S[\varphi(S)]$。我们想要这部分比较小，而概率论中刚好有个不等式是这种形式，那就是McDiarmid不等式：</p>
<blockquote>
<p><strong>定理（McDiarmid不等式）：</strong> 若$x_1,\ldots,x_m$是$m$个独立随机变量，关于$x_1,\ldots,x_m$的函数$\varphi$满足<br>$$\sup_{x_1,\ldots,x_i,\ldots,x_m,x_i’}\left|\varphi(x_1,\ldots,x_i,\ldots,x_m)-\varphi(x_1,\ldots,x_i’,\ldots,x_m)\right|\leq c_i$$则<br>$$\mathrm{Pr}\left(\varphi(x_1,\ldots,x_m)-\mathrm{E}\left[\varphi(x_1,\ldots,x_m)\right]\geq\epsilon\right)\leq e^{-2\epsilon^2/\sum_{i=1}^m c_i^2}$$</p>
</blockquote>
<p>要想套用McDiarmid不等式，我们先来看一下不等式要求中的$\left|\varphi(S)-\varphi(S’)\right|$，其中$S’$是将$S$中第$i$个元素由$x_i$替换为$x_i’$得来：<br>$$\begin{eqnarray}<br>\left|\varphi(S)-\varphi(S’)\right|=\left|\sup_{h\in\mathcal{H}}\left\{\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right\}-\sup_{h\in\mathcal{H}}\left\{\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S’}[\mathfrak{l}(h(x),f(x))]\right\}\right| \\<br>\leq\sup_{h\in\mathcal{H}}\left|\hat{\mathrm{E}}_{x\in S’}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right|=\frac{1}{m}\sup_{h\in\mathcal{H}}\left|\mathfrak{l}(h(x_i’),f(x_i’))-\mathfrak{l}(h(x_i),f(x_i))\right|\leq\frac{M}{m}<br>\end{eqnarray}$$其中<br>$$M=\sup_{h\in\mathcal{H}}\left\{\sup_{x\in\mathcal{X}}\mathfrak{l}(h(x),f(x))-\inf_{x\in\mathcal{X}}\mathfrak{l}(h(x),f(x))\right\}$$这里我们确实有假定$h$与$f$之间的最大误差是有界的。有了上面的关系，我们就得到<br>$$\mathrm{Pr}\left(\varphi(S)-\mathrm{E}_S\left[\varphi(S)\right]\geq\epsilon\right)\leq e^{-2m\epsilon^2/M^2}$$如果我们令上述概率为$\delta$，则可解出<br>$$\epsilon=M\sqrt{\frac{\log\frac{1}{\delta}}{2m}}$$于是，我们可以以$1-\delta$的置信概率来相信$\varphi(S)-\mathrm{E}_S[\varphi(S)]$的值不会超过$M\sqrt{\frac{\log\frac{1}{\delta}}{2m}}$。第二部分算是研究完了。</p>
<p>再来看一下第一部分$\mathrm{E}_S[\varphi(S)]$。我们希望通过对这一部分的研究来导出一个对$\mathcal{H}$的合理的约束。引入一个同样包含$m$个元素的幽灵样本$\tilde{S}$，则$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]$可以写成<br>$$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]=\mathrm{E}_{\tilde{S}}\left[\hat{\mathrm{E}}_{\tilde{x}\in\tilde{S}}[\mathfrak{l}(h(\tilde{x}),f(\tilde{x}))]\right]$$由于$\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]$相对于$\tilde{S}$来讲只是个常数而已，因此有<br>$$\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]=\mathrm{E}_{\tilde{S}}\left[\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right]$$于是$\varphi(S)$可以写成<br>$$\begin{eqnarray}<br>\varphi(S)=\sup_{h\in\mathcal{H}}\left\{\mathrm{E}_{\tilde{S}}\left[\hat{\mathrm{E}}_{\tilde{x}\in\tilde{S}}[\mathfrak{l}(h(\tilde{x}),f(\tilde{x}))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right]\right\} \\<br>\leq\mathrm{E}_{\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\hat{\mathrm{E}}_{\tilde{x}\in\tilde{S}}[\mathfrak{l}(h(\tilde{x}),f(\tilde{x}))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right\}\right]<br>\end{eqnarray}$$于是有<br>$$\begin{eqnarray}<br>\mathrm{E}_S[\varphi(S)]\leq\mathrm{E}_{S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\hat{\mathrm{E}}_{\tilde{x}\in\tilde{S}}[\mathfrak{l}(h(\tilde{x}),f(\tilde{x}))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\right\}\right] \\<br>=\mathrm{E}_{S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\left[\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))-\mathfrak{l}(h(x_{i}),f(x_{i}))\right] \right\}\right]<br>\end{eqnarray}$$注意到上式中的$S$跟$\tilde{S}$相互独立且服从相同的分布，并且他们中的每个元素也是独立同分布的。于是对于任意的$i$，我们总是可以把$\tilde{x}_i$与$x_i$对调让$\tilde{x}_i$到$S$中去而让$x_i$到$\tilde{S}$中去，这种对调并不影响总的结果。于是可以引入一个新的在$\{-1,1\}$中取值的随机变量$\sigma$用来控制是否进行上述对调。只要$\sigma$与$S$跟$\tilde{S}$相互独立，这个新引入的随机变量并不会对结果有任何改变。写成式子就是：<br>$$\mathrm{E}_{S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\left[\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))-\mathfrak{l}(h(x_{i}),f(x_{i}))\right] \right\}\right]=\mathrm{E}_{\sigma,S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\left[\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))-\mathfrak{l}(h(x_{i}),f(x_{i}))\right] \right\}\right]$$<br>注意到<br>$$\begin{eqnarray}<br>\mathrm{E}_{\sigma,S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\left[\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))-\mathfrak{l}(h(x_{i}),f(x_{i}))\right] \right\}\right] \leq \mathrm{E}_{\sigma,S,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))\right\} + \sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}-\sigma_i\mathfrak{l}(h(x_{i}),f(x_{i}))\right\} \right]    \\<br>= \mathrm{E}_{\sigma,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))\right\}\right] + \mathrm{E}_{\sigma,S}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}-\sigma_i\mathfrak{l}(h(x_{i}),f(x_{i}))\right\} \right]    \\<br>= \mathrm{E}_{\sigma,\tilde{S}}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(\tilde{x}_{i}),f(\tilde{x}_{i}))\right\}\right] + \mathrm{E}_{\sigma,S}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(x_{i}),f(x_{i}))\right\} \right]    \\<br>= 2 \mathrm{E}_{\sigma,S}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(x_{i}),f(x_{i}))\right\} \right]<br>\end{eqnarray}<br>$$<br>记<br>$$\mathrm{R}_m(\mathfrak{l}(\mathcal{H},f))=\mathrm{E}_{\sigma,S}\left[\sup_{h\in\mathcal{H}}\left\{\frac{1}{m}\sum_{i=1}^{m}\sigma_i\mathfrak{l}(h(x_{i}),f(x_{i}))\right\} \right]$$并称其为函数$\mathfrak{l}(h(x),f(x))$的Rademacher复杂度。我们有关系式：<br>$$\mathrm{E}_S[\varphi(S)]\leq 2\mathrm{R}_m(\mathfrak{l}(\mathcal{H},f))$$</p>
<p>综上，我们可以说：我们可以以$1-\delta$的置信概率来相信$\varphi(S)$的值不会超过<br>$$2\mathrm{R}_m(\mathfrak{l}(\mathcal{H},f))+M\sqrt{\frac{\log\frac{1}{\delta}}{2m}}$$<br>这就是我们想要的最终结果。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;计算学习理论中的一类很重要的问题是研究训练集训练出来的模型在训练集以外的表现，即泛化误差（generalization error）。我们来考虑这样一个问题，我们想要拟合目标函数$f:\mathcal{X}\to\mathbb{R}$，为此，我们选取假设空间（hypothesis space） $\mathcal{H}$，然后通过某种方法获得一个训练集$S=\left\{(x_1,f(x_1)),(x_2,f(x_2)),\ldots(x_m,f(x_m))\right\}$。这个训练集被认为是从$\mathcal{X}$上的概率分布$\mathcal{P}$进行独立同分布的抽样而来。获得训练集以后，我们把训练集作为输入输送给某个优化算法$\mathscr{A}$。这个算法本身可能是带有随机性的，比如SGD，但是如果把算法使用的随机数发生器生成的随机数也看成算法的输入的话，那么这个优化算法就没有任何随机可言，给定一个训练集$S$以及随机数$\theta$，算法输出唯一的$h=\mathscr{A}(S,\theta)\in\mathcal{H}$。如果我们使用$\mathfrak{l}:\mathbb{R}\times\mathbb{R}\to\mathbb{R}_{\ge0}$作为损失函数来衡量$f$与$g$的差异的话，我们关心的是，当我们的训练误差为$\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]:=\frac{1}{m}\sum_{i=1}^m\mathfrak{l}(h(x_i),f(x_i))$时，我们有多大的置信度来保证这个算法的输出的$h$的泛化误差$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]$比训练误差不会高出超过$\epsilon$，即&lt;br&gt;$$\mathrm{E}_{x\sim\mathcal{P}}[\mathfrak{l}(h(x),f(x))]-\hat{\mathrm{E}}_{x\in S}[\mathfrak{l}(h(x),f(x))]\leq\epsilon$$&lt;/p&gt;
    
    </summary>
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="Rademacher复杂度" scheme="https://zasdfgbnm.github.io/tags/Rademacher%E5%A4%8D%E6%9D%82%E5%BA%A6/"/>
    
      <category term="计算学习理论" scheme="https://zasdfgbnm.github.io/tags/%E8%AE%A1%E7%AE%97%E5%AD%A6%E4%B9%A0%E7%90%86%E8%AE%BA/"/>
    
      <category term="机器学习" scheme="https://zasdfgbnm.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>我与学校SafeConnect软件斗智斗勇的经历</title>
    <link href="https://zasdfgbnm.github.io/2017/07/01/%E6%88%91%E4%B8%8E%E5%AD%A6%E6%A0%A1SafeConnect%E8%BD%AF%E4%BB%B6%E6%96%97%E6%99%BA%E6%96%97%E5%8B%87%E7%9A%84%E7%BB%8F%E5%8E%86/"/>
    <id>https://zasdfgbnm.github.io/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/</id>
    <published>2017-07-01T16:53:10.000Z</published>
    <updated>2017-07-07T12:48:50.934Z</updated>
    
    <content type="html"><![CDATA[<p><strong>版权信息：博主就是本文原创作者，但是本文最早发布于<a href="http://www.freebuf.com/news/topnews/125994.html" target="_blank" rel="noopener">FreeBuf</a>，并属FreeBuf原创奖励计划，如需转载请联系FreeBuf。</strong></p>
<p>故事是这样的，本文作者读书的学校，IT部门要求我们如果使用Windows或者Mac OS要连接学校网络的话，必须安装SafeConnect客户端。这个客户端干的事情就是监视你的系统，确保你安装、启用并及时更新杀毒软件，确保你及时更新电脑上的Flash跟Java，确保你不使用P2P软件。然而我一直很不喜欢这种被监视的感觉，感觉这是侵犯了我的人权，况且我很少用P2P来下载盗版内容，偶尔用P2P一直都是用来下载Linux的安装镜像的，这种宁可错杀一千也不放过一个的做法实在是让人难以忍受。再加上学校的IT部门的人非常官僚，自己还没啥技术，曾经有同学找他们备份数据结果数据没备份成他们反而把分区表给搞坏了，这就让我坚定了跟他们斗争到底的想法，刚好也可以打发业余时光。由于SafeConnect客户端不支持Linux系统，同时学校中Linux用户的数量相当多，所以Linux系统不需要安装任何客户端，直接就能访问网络，这是一个关键性的切入点。</p>
<a id="more"></a>
<p>要同SafeConnect斗争，有两个切入点，一个是从SafeConnect客户端做手脚，想办法让SafeConnect客户端丧失相应的监测功能，只是傻傻地给他们的服务器汇报一切符合要求，另一个则是从SafeConnect网关的操作系统检测入手，只要能让网关认为我们用的是Linux系统，我们就可以上网了，这样连SafeConnect客户端都不用装了。</p>
<p>第一个切入点需要对SafeConnect进行逆向工程，搞清楚SafeConnect这些项目的检测机制。逆向工程向来都是费时费力，成本巨大，而且不可以跨平台。不过幸运的是，SafeConnect检测P2P软件的方式经过简单测试作者就发现了端倪：<br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/p2p-blocked.png" title="打开P2P软件，网络被断，遭到警告"><br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/p2p-changeprocname.png" title="把P2P软件的进程名改掉，正常使用未被发现"><br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/helloworld-blockedasp2p.png" title="自己写一个Hello World程序并命名为为BitTorrent.exe并打开，网络被断，遭到警告"></p>
<p>从上面的测试不难看出，SafeConnect通过列举系统的进程，如果发现黑名单中的进程名，就给你断开网络链接，然后弹出网页警告你说我们检测到你在使用P2P软件，这违反了学校的规定。明白了原理，就可以开干了。既然SafeConnect列举系统进程，那我们就使用进程隐藏技术把P2P软件的进程隐藏起来。</p>
<p>Windows系统有很多API可以访问系统的进程信息，但是所有这些API在底层最终都会调用<code>NtQuerySystemInformation</code>来获取系统进程信息。这个系统调用总共有四个参数，其中第一个参数<code>SystemInformationClass</code>表示的是你要查询的系统信息的类型，对于列举系统进程而言，这个参数的值应为<code>SystemProcessInformation</code>。第二个参数<code>SystemInformation</code>存储着获得的系统信息，对于列举进程而言，这个参数存储着一个链表，链表的每一项都是一个进程，而要隐藏进程，我们只需要从链表中删除相应的项即可。要篡改系统调用的结果，需要用到DLL注入技术将DLL注入到目标进程的地址空间，然后篡改地址空间中<code>NtQuerySystemInformation</code>函数的的代码加入跳转语句跳转到我们伪造的<code>NtQuerySystemInformation</code>去，这就是DLL注入的整个运行过程。整个DLL注入的过程不需要亲自动手，有现成的<a href="http://easyhook.github.io" target="_blank" rel="noopener">EasyHook库</a>可以实现。</p>
<p>不多说，贴代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;easyhook.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shlwapi.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winternl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntstatus.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"EasyHook32.lib"</span>)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"ntdll.lib"</span> )</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HIDE_PROCESS_NAME TEXT(<span class="meta-string">"BitTorrent.exe"</span>)</span></div><div class="line"></div><div class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们要Hook的函数位于ntdll.dll，所以在代码中要引用一下ntdll.lib。我们要写的dll的entry不需要做任何事情。接下来就是我们的自定义<code>NtQuerySystemInformation</code>了，在这里我把它命名为<code>myNtQuerySystemInformation</code>：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function">NTSTATUS WINAPI <span class="title">myNtQuerySystemInformation</span><span class="params">(SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></div><div class="line">                                           PVOID SystemInformation, ULONG SystemInformationLength,</div><div class="line">                                           PULONG ReturnLength) &#123;</div><div class="line">    NTSTATUS status = NtQuerySystemInformation(SystemInformationClass, SystemInformation,</div><div class="line">                                               SystemInformationLength, ReturnLength);</div><div class="line">    <span class="keyword">if</span> (status != STATUS_SUCCESS)</div><div class="line">        <span class="keyword">return</span> status;</div><div class="line">    <span class="keyword">if</span> (SystemInformationClass == SystemProcessInformation) &#123;</div><div class="line">        PSYSTEM_PROCESS_INFORMATION pcur = <span class="literal">NULL</span>, pprev = <span class="literal">NULL</span>;</div><div class="line">        pcur = (PSYSTEM_PROCESS_INFORMATION)SystemInformation;</div><div class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (pcur-&gt;Reserved2[<span class="number">1</span>] != <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (_tcscmp((LPTSTR)(pcur-&gt;Reserved2[<span class="number">1</span>]), HIDE_PROCESS_NAME) == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// delete element from linked list</span></div><div class="line">                    <span class="keyword">if</span> (pcur-&gt;NextEntryOffset == <span class="number">0</span> &amp;&amp; pprev != <span class="literal">NULL</span>)</div><div class="line">                        pprev-&gt;NextEntryOffset = <span class="number">0</span>;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (pprev != <span class="literal">NULL</span>)</div><div class="line">                        pprev-&gt;NextEntryOffset += pcur-&gt;NextEntryOffset;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    pprev = pcur;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (pcur-&gt;NextEntryOffset == <span class="number">0</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            pcur = (PSYSTEM_PROCESS_INFORMATION)((ULONG)pcur + pcur-&gt;NextEntryOffset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> status;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如刚刚介绍的那样，这个函数做的事情就是把要隐藏的进程从链表删掉。同时，EasyHook还要求我们在dll中定义安装函数，这个不复杂，直接从官方教程粘贴代码简单改改就好：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">void</span> __declspec(dllexport) __<span class="function">stdcall <span class="title">NativeInjectionEntryPoint</span><span class="params">(REMOTE_ENTRY_INFO* inRemoteInfo)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">NativeInjectionEntryPoint</span><span class="params">(REMOTE_ENTRY_INFO* inRemoteInfo)</span> </span>&#123;</div><div class="line">    HOOK_TRACE_INFO hHook = &#123; <span class="literal">NULL</span> &#125;;</div><div class="line">    HMODULE ntdll = GetModuleHandle(TEXT(<span class="string">"ntdll"</span>));</div><div class="line">    NTSTATUS result = LhInstallHook(GetProcAddress(ntdll, <span class="string">"NtQuerySystemInformation"</span>),</div><div class="line">                                    myNtQuerySystemInformation,<span class="literal">NULL</span>,&amp;hHook);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (FAILED(result))</div><div class="line">        <span class="built_in">std</span>::wcout &lt;&lt; RtlGetLastErrorString() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"NtQuerySystemInformation hook success!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="comment">// If the threadId in the ACL is set to 0,</span></div><div class="line">    <span class="comment">// then internally EasyHook uses GetCurrentThreadId()</span></div><div class="line">    ULONG ACLEntries[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Disable the hook for the provided threadIds, enable for all others</span></div><div class="line">    LhSetExclusiveACL(ACLEntries, <span class="number">1</span>, &amp;hHook);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>写好了DLL，下一步就是找到目标进程注入进去了。仔细研究一下那个SafeConnect，可以发现他总共有两部分：一个scManager.sys系统服务，以及一个SafeConnectClient.exe进程，实测发现把DLL注入到SafeConnectClient.exe不管用，于是断定负责检索系统进程列表的是scManager.sys。</p>
<p>下图是用来将我们写的DLL注入到scManager.sys的代码，这里代码做的事情是查找名为scManager.sys的进程，读取进程的PID，然后调用EasyHook的API将我们写的DLL注入到对应的进程中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;easyhook.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;psapi.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"EasyHook32.lib"</span>)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"psapi.lib"</span> )</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_PROC 1</span></div><div class="line">TCHAR * targets[NUM_PROC] = &#123;</div><div class="line">    TEXT(<span class="string">"scManager.sys"</span>)</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function">DWORD <span class="title">getTargetProcessID</span><span class="params">(TCHAR *target)</span> </span>&#123;</div><div class="line">    DWORD aProcesses[<span class="number">1024</span>], cbNeeded, cProcesses;</div><div class="line">    <span class="keyword">if</span>(!EnumProcesses(aProcesses, <span class="keyword">sizeof</span>(aProcesses), &amp;cbNeeded))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    cProcesses = cbNeeded / <span class="keyword">sizeof</span>(DWORD);</div><div class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; cProcesses; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (aProcesses[i] != <span class="number">0</span>)&#123;</div><div class="line">            TCHAR szProcessName[MAX_PATH] = TEXT(<span class="string">"&lt;unknown&gt;"</span>);</div><div class="line">            HANDLE hProcess = OpenProcess(PROCESS_QUERY_INFORMATION|PROCESS_VM_READ,</div><div class="line">                                          FALSE, aProcesses[i]);</div><div class="line">            <span class="keyword">if</span> (<span class="literal">NULL</span> != hProcess) &#123;</div><div class="line">                HMODULE hMod;</div><div class="line">                DWORD cbNeeded;</div><div class="line">                <span class="keyword">if</span> (EnumProcessModules(hProcess, &amp;hMod, <span class="keyword">sizeof</span>(hMod),&amp;cbNeeded))</div><div class="line">                    GetModuleBaseName(hProcess, hMod, szProcessName,<span class="keyword">sizeof</span>(szProcessName)/<span class="keyword">sizeof</span>(TCHAR));</div><div class="line">                CloseHandle(hProcess);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (_tcscmp(target, szProcessName) == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> aProcesses[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PROC; i++) &#123;</div><div class="line">        DWORD processId = getTargetProcessID(targets[i]);</div><div class="line">        HMODULE ntdll = GetModuleHandle(TEXT(<span class="string">"ntdll"</span>));</div><div class="line">        <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"target func in injector has address "</span></div><div class="line">                   &lt;&lt; GetProcAddress(ntdll, <span class="string">"NtQuerySystemInformation"</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">if</span> (processId == <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"Unable to find the process ID for "</span></div><div class="line">                       &lt;&lt; targets[i] &lt;&lt; <span class="string">", please manually input: "</span>;</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cin</span> &gt;&gt; processId;</div><div class="line">            <span class="built_in">std</span>::wstring input;</div><div class="line">            <span class="built_in">std</span>::getline(<span class="built_in">std</span>::wcin, input);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (processId!=<span class="number">0</span>) &#123;</div><div class="line">            NTSTATUS nt = RhInjectLibrary(processId, <span class="number">0</span>, EASYHOOK_INJECT_DEFAULT,</div><div class="line">                                          <span class="string">L"fuck_safeconnect.dll"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span> (nt != <span class="number">0</span>) &#123;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"RhInjectLibrary failed with error code = %d\n"</span>, nt);</div><div class="line">                PWCHAR err = RtlGetLastErrorString();</div><div class="line">                <span class="built_in">std</span>::wcout &lt;&lt; err &lt;&lt; <span class="string">"\n"</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"inject success!\n"</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"Press Enter to exit"</span>;</div><div class="line">    <span class="built_in">std</span>::wstring input;</div><div class="line">    <span class="built_in">std</span>::getline(<span class="built_in">std</span>::wcin, input);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于scManager.sys是个系统服务，单纯的“以管理员身份运行”是无法成功注入的，这时候就需要把注入器提权到SYSTEM用户来进行注入。提权到SYSTEM的操作可以用微软提供的<a href="https://technet.microsoft.com/en-us/sysinternals/pxexec.aspx" target="_blank" rel="noopener">PsExec</a>工具来进行。PsExec是个命令行工具，使用PsExec非常简单，只需要<code>psexec –i –s 程序名</code>即可。<br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/inject-success.png" title="注入成功，这时候再打开BitTorrent就不被断网了"></p>
<p>由于逆向工程太过费时费力，笔者并没有在SafeConnect客户端上多费心思，而是转向了第二种方法：欺骗SafeConnect的服务器端的操作系统检测功能。要检测连进来的设备的操作系统，一种常用的方法是TCP Fingerprinting，此外，还可以运用深度包检测技术读取设备发送的数据包的内容，推测设备的类型。只需要针对这几项进行伪装，然后观察SafeConnect的行为就可以推测SafeConnect检测用户操作系统的方式。</p>
<p>经过一番实验，推测SafeConnect服务器的工作原理如下：客户端新设备连进网络的时候，他们是直接不给你互联网接入的。但是他们会监测你的的外出http流量，从http流量中读取User-Agent中的操作系统信息。</p>
<p>如果发现是他们SafeConnect客户端不支持的系统，比如Linux，iOS，android之类，就把你这个IP地址限制放开。如果是客户端支持的系统，比如Windows，Mac OS，并且你的SafeConnect已经安装了，那么SafeConnect会跟他们服务器通讯把你放开，如果你还没安装SafeConnect，那么就把你跳转到相关页面让你装SafeConnect。</p>
<p>明白了这一点，解决方法自然就来了：给浏览器安装可以更改User-Agent的插件，把User-Agent里面的操作系统信息改成Linux即可，这样在访问网络的时候，SafeConnect的服务器就会误以为你是Linux系统了。通过给浏览器更改User-Agent，几乎可以完美躲过SafeConnect的法眼，然而美中不足的是如果用多个浏览器，还需要挨个安装插件更改User-Agent，同时有的网站会检测浏览器的版本，如果发现浏览器版本过就会提示不支持需要更新，这样就需要不断地根据浏览器更新手工更改插件里的User-Agent的值。还有一点麻烦的地方是，新设备接入的时候还需要设置新的设备。对我来说有没有设置一个新设备自然很简单，但是经常有时候有客人来，用Windows设备没装SafeConnect就上网导致我家整个路由器被封。有没有简单快捷的方法自动让所有连接到路由器的设备都不受SafeConnect的影响呢？这时候就想到了bettercap。</p>
<p>Bettercap是一个模块化的开源的中间人攻击框架。使用bettercap只需要几行代码就可以实现劫持整个局域网的流量并把其中的HTTP流量的User-Agent改掉。这样的话，只要家里有客人来，我们就可以打开bettercap，自动把客人的User-Agent改掉，防止客人上网导致家里整个路由器都被断。在局域网中实现中间人攻击的一种常见方法是ARP欺骗。ARP欺骗攻击发起方通过不断向受害者发送伪造的ARP数据包，让受害者误以为自己是网关，这样受害者本来想送到网关的数据包就会错误地送给攻击方，攻击方进而可以篡改数据然后送给真正的网关。要使用bettercap实现User-Agent的伪造，首先需要写一个bettercap的代理模块。Bettercap的代理模块写起来非常简单， <a href="https://github.com/evilsocket/bettercap-proxy-modules" target="_blank" rel="noopener">这里有很多示例模块</a>，文档在<a href="https://www.bettercap.org/docs/proxying/http.html" target="_blank" rel="noopener">这里</a>。我写的模块代码如下:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Osfuscate</span> &lt; BetterCap::Proxy::<span class="title">HTTP::Module</span></span></div><div class="line">    meta(</div><div class="line">        <span class="string">'Name'</span>        =&gt; <span class="string">'Osfuscate'</span>,</div><div class="line">        <span class="string">'Description'</span> =&gt; <span class="string">'Change the operating system in User-Agent string to Linux.'</span>,</div><div class="line">        <span class="string">'Version'</span>     =&gt; <span class="string">'1.0.0'</span>,</div><div class="line">        <span class="string">'Author'</span>      =&gt; <span class="string">"zasdfgbnm"</span>,</div><div class="line">        <span class="string">'License'</span>     =&gt; <span class="string">'GPL3'</span></div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_pre_request</span><span class="params">( request )</span></span></div><div class="line">        request[<span class="string">'User-Agent'</span>].gsub!( <span class="regexp">/\(Windows.*?\)/</span>, <span class="string">'(X11; Linux x86_64)'</span> )</div><div class="line">        request[<span class="string">'User-Agent'</span>].gsub!( <span class="regexp">/\(Macintosh.*?\)/</span>, <span class="string">'(X11; Linux x86_64)'</span> )</div><div class="line">        <span class="comment"># return nil to tell the streamer that this module didn't do the request</span></div><div class="line">        <span class="comment"># and therefore the request should be done by the streamer.</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>其中<code>on_pre_request</code>函数在请求发生前会被调用，我们只需要在这里把请求中User-Agent的信息中的操作系统给替换成Linux就行了。这里需要注意的是，在函数的结尾需要返回<code>nil</code>，用来告诉bettercap请求还没有被执行，这样bettercap才会去执行请求。</p>
<p>有了这个代理模块，要想部署，只需要执行<code>bettercap–proxy-module 模块文件名</code>命令就可以了，不需要手动配置iptables这些东西, 非常简单快捷。上图：<br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/ua-windows.png" title="这是局域网内的一台Windows机器User-Agent中的操作系统信息"><br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/bettercap.png" title="这是bettercap软件的运行界面"><br><img src="/2017/07/01/我与学校SafeConnect软件斗智斗勇的经历/ua-changed.png" title="这是bettercap运行时局域网内这台Windows机器的User-Agent中的操作系统信息"></p>
<p>从图中可见User-Agent信息已经被成功修改掉了，大功告成。</p>
<p>最后说再来一句，这个工作其实稳定的解决方法是直接在路由器跟网口中间加一个电脑用来做网关来负责User-Agent的修改，这样网络会比ARP欺骗的解决方案要稳定好多。这里之所以选择ARP欺骗的方案主要是因为简单快速不需要拔网线不需要设置网关。另外，如果你已经有一台已经设置好了的网关服务器，bettercap同样可以用来完成我们想要的任务，只需要在网关服务器上执行如下命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bettercap --no-spoofing --no-discovery --proxy-module 模块名</div></pre></td></tr></table></figure></p>
<p>程序执行的界面类似，这里就不截图了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;版权信息：博主就是本文原创作者，但是本文最早发布于&lt;a href=&quot;http://www.freebuf.com/news/topnews/125994.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;FreeBuf&lt;/a&gt;，并属FreeBuf原创奖励计划，如需转载请联系FreeBuf。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;故事是这样的，本文作者读书的学校，IT部门要求我们如果使用Windows或者Mac OS要连接学校网络的话，必须安装SafeConnect客户端。这个客户端干的事情就是监视你的系统，确保你安装、启用并及时更新杀毒软件，确保你及时更新电脑上的Flash跟Java，确保你不使用P2P软件。然而我一直很不喜欢这种被监视的感觉，感觉这是侵犯了我的人权，况且我很少用P2P来下载盗版内容，偶尔用P2P一直都是用来下载Linux的安装镜像的，这种宁可错杀一千也不放过一个的做法实在是让人难以忍受。再加上学校的IT部门的人非常官僚，自己还没啥技术，曾经有同学找他们备份数据结果数据没备份成他们反而把分区表给搞坏了，这就让我坚定了跟他们斗争到底的想法，刚好也可以打发业余时光。由于SafeConnect客户端不支持Linux系统，同时学校中Linux用户的数量相当多，所以Linux系统不需要安装任何客户端，直接就能访问网络，这是一个关键性的切入点。&lt;/p&gt;
    
    </summary>
    
      <category term="信息安全" scheme="https://zasdfgbnm.github.io/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="SafeConnect" scheme="https://zasdfgbnm.github.io/tags/SafeConnect/"/>
    
      <category term="P2P" scheme="https://zasdfgbnm.github.io/tags/P2P/"/>
    
      <category term="DLL注入" scheme="https://zasdfgbnm.github.io/tags/DLL%E6%B3%A8%E5%85%A5/"/>
    
      <category term="中间人攻击" scheme="https://zasdfgbnm.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB/"/>
    
      <category term="ARP欺骗" scheme="https://zasdfgbnm.github.io/tags/ARP%E6%AC%BA%E9%AA%97/"/>
    
      <category term="逆向工程" scheme="https://zasdfgbnm.github.io/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"/>
    
      <category term="Hook" scheme="https://zasdfgbnm.github.io/tags/Hook/"/>
    
      <category term="User-Agent" scheme="https://zasdfgbnm.github.io/tags/User-Agent/"/>
    
      <category term="bettercap" scheme="https://zasdfgbnm.github.io/tags/bettercap/"/>
    
  </entry>
  
  <entry>
    <title>能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大</title>
    <link href="https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/"/>
    <id>https://zasdfgbnm.github.io/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/</id>
    <published>2017-06-29T14:52:54.000Z</published>
    <updated>2017-07-18T06:02:33.318Z</updated>
    
    <content type="html"><![CDATA[<p><strong>更新日志</strong>：<br>2017-07-18 增加了新的一章：无盘系统，将多处不当使用的术语“rootfs”替换为更贴切的“root”</p>
<p>===================</p>
<p>这里介绍一下自己管理自己的Linux桌面的一点经验吧，我觉得还是有不少可取之处的。先来说一下大多数人管理Linux桌面的方法有哪些不方便的地方吧：</p>
<ul>
<li>买新电脑了，又得在新电脑上安装Linux，安装各种软件，各种库，各种开发环境，配置各种服务，真麻烦。</li>
<li>最近一直在用电脑A，干了好多事情安装了好多软件，也配置了不少开发环境跟各种服务，然而处于某种原因，我又要开始使用好久没用过的电脑B了，难道我要把在A上的做的各种配置在B上再重新做一遍？</li>
<li>在Windows下做着PPT呢，发现需要调出自己之前的程序，然后根据若干组输入跑几个结果画张图好插到PPT里，然而这个程序是在Linux下写的，编译等的过程也严重依赖自己用的Linux环境，重启进Linux拿到结果再回Windows太不方便，想在Windows下配置好环境把自己的程序跑通更不容易。</li>
<li>要对系统安装某个软件，或者进行一些比较危险的更新操作（要知道Archlinux滚动更新滚挂了太正常了），担心把系统搞挂了，系统备份又实在太麻烦，要真挂了，系统恢复起来更麻烦。</li>
<li>我一直用Archlinux做主力，然而最近做的某件事情要用某个软件，这个软件官方只给了Ubuntu上的安装方式，Archlinux里面没有相应的包，在Archlinux上手动安装也太不方便。装个Ubuntu，然后暂时用几天Ubuntu吧，也是够折腾的。更何况有时候只是想用一小下而已，怎样才能最小化自己在折腾上浪费的时间呢？</li>
<li>有的软件官方软件仓库里面没有，而<code>make install</code>的话则会在系统中安装上不被包管理器所管理的文件，将来卸载也不方便，我还是更希望所有的文件都在一个包管理器中管理的。</li>
<li>听说新版本内核引入了某个牛逼的东西？我就想快速测试一下玩玩，我电脑还有计算在跑着呢，我可不想重启，那就只能用虚拟机尝试了。而且，一定要快速，我可不想为此特地装一个虚拟机。</li>
</ul>
<p>上述的这些不方便之处是可以通过自己管理系统时的一些技巧来克服的，本文目的就是来介绍一下这些技巧。通过这些技巧，我们实现的功能是：一台机器上，可以同时安装Windows跟若干Linux系统，Windows下可以通过虚拟机来运行位于本地磁盘的这些Linux系统，而这些Linux系统下也可以通过容器或者虚拟机的方式互相运行。并且这些系统可以非常方便地备份跟删除，也可以随时创建以及运行快照。并且这些Linux系统可以随时打包带走，只需要经过很少的修改，就能直接在U盘或者其他机器上运行。如果要换电脑，或者新装一台电脑，也不需要重新安装系统，只需要把已有的系统同步到新电脑就行。这也正是这篇文章标题的意思。</p>
<a id="more"></a>
<p>为了行文的方便，我们假定读者有一台全新的机器，硬盘还没分区，也还没装任何系统。如果已经什么都装好了，而只是想迁移到我这种管理方式的话，我相信读者能够判断这个安装教程中哪些步骤是需要做的哪些步骤是不需要做的。 另外需要注意的是这不是一个手把手的一步一步的教程，中间有一些显然的步骤我就略去不写了，所以希望读者不要照着文章里的的命令不加思考地一条一条粘贴运行，而是要搞明白这些命令的目的是什么，然后根据你自己的情况来做相应的修改。</p>
<h1 id="分区与子卷"><a href="#分区与子卷" class="headerlink" title="分区与子卷"></a>分区与子卷</h1><p>具体怎么分区我就不说了，随便找个livecd启动进去，然后找到你自己最喜欢的分区程序，按照你的喜好把区分了就好。注意别忘了EFI分区。我这里需要说的是，分区的时候，不论有多少个发行版要安装，总共只给Linux划分两个分区：一个是swap，另一个则是一个大的btrfs分区。那个btrfs分区里面装着所有的文件，包括用户的个人数据，以及所有发行版的rootfs。这两个分区在格式化的时候，一定要给他们取Label，这么做的好处接下来我们很快就会看到。我的习惯是，swap分区的Label我就叫他“swap”，而那个btrfs分区我则叫他“linux”。创建好分区以后，如果格式化工作是在图形的分区管理程序下完成的，那么指定Label是个非常简单的工作，右键属性里面就有。如果是使用命令行工具格式化分区的，则可以使用<code>-L label</code>选项来指定label，比如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkswap -L swap /dev/sdb4</div><div class="line">mkfs.btrfs -L linux /dev/nvme0n1p4</div></pre></td></tr></table></figure></p>
<p>那个大的btrfs分区上的不同内容是通过btrfs的子卷来管理的，具体来讲就是为自己想安装的每个不同的Linux系统来创建一个单独的子卷。 比如说我电脑上同时安装了Archlinux、Ubuntu、Kali、Debian四个系统，那么的btrfs分区里面就有四个子卷：archlinux、ubuntu、kali、debian。 子卷的创建可以通过<code>btrfs subvolume create &lt;name&gt;</code>命令完成，比如说要创建我这五个子卷，需要做的事情就是：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mount /dev/disk/by-label/linux /mnt</div><div class="line"><span class="built_in">cd</span> /mnt</div><div class="line">btrfs subvolume create archlinux</div><div class="line">btrfs subvolume create ubuntu</div><div class="line">btrfs subvolume create kali</div><div class="line">btrfs subvolume create debian</div></pre></td></tr></table></figure></p>
<p>如果你只想装一个发行版，比如archlinux，那么只需要archlinux子卷就够了。另外，如果你想把用户数据单独放在一个子卷里，也是完全可以的，不过这里不推荐多个Linux系统共享同一个家目录，因为不同系统上安装的软件不同，同样的软件版本也不相同，即使版本相同，不同发行版也可能应用了不同的patch，这就导致在一个系统上用户家目录里面产生的配置文件，在另一个系统里无法兼容，产生奇怪的行为。</p>
<h1 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h1><p>创建好分区与子卷，下一步就是安装操作系统了。这里分两种情况来讲：第一种情况是你想要全新安装一个Linux操作系统；第二种情况则是你已经有了某个可用的操作系统了，而只是想把这个操作系统迁移到文章所说的管理方式上。</p>
<h2 id="全新安装"><a href="#全新安装" class="headerlink" title="全新安装"></a>全新安装</h2><p>如果想要全新安装一个操作系统，安装方式上，作者只推荐纯手工安装，而不是用官方给的安装光盘不断点着“下一步”来进行安装。这么做是为了防止官方安装程序做一些我们不想让他做的事情，比如说自动安装grub。对于Archlinux跟Gentoo来讲，唯一的安装方法就是纯手工安装，所以只要按照官方的教程来就好了。对于deb系的系统，可以使用debootstrap程序。对于其他的发行版，可能会找不到手工安装的教程，这时候可以新建一个虚拟机，在虚拟机中使用官方的安装程序不断点击“下一步”来完成安装，然后按照下一节即将介绍的现有系统迁移教程把系统从虚拟机中迁移到现实机器上；除此之外，读者还可以找到发行版官方提供的安装程序的源代码阅读一下，看明白这些安装程序都在干啥，就知道怎么手工安装了，安装程序的代码还是相对简单的，有时间的读者不妨尝试一下。下面来具体说一下安装过程，这里只介绍Archlinux跟deb系。如果有多个Linux系统需要安装，建议先安装并完全配置好其中一个，让这个系统处于可用并且方便使用的状态，然后再在这个可用的系统中安装其他系统。这里我们假设读者已经完成了分区，创建了对应的子卷，并且把那个btrfs分区挂载在了<code>/mnt</code>上。</p>
<h3 id="Archlinux的手动安装"><a href="#Archlinux的手动安装" class="headerlink" title="Archlinux的手动安装"></a>Archlinux的手动安装</h3><p>Archlinux的手动安装主要还是看<a href="https://wiki.archlinux.org/index.php/Installation_guide" target="_blank" rel="noopener">官方教程</a>。分区的时候注意按照上文介绍的方法。非常关键的<code>pacstrap</code>那一步注意使用如下命令安装到子卷里，而不是整个btrfs分区中:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pacstrap -d /mnt/archlinux base</div></pre></td></tr></table></figure></p>
<p>至于fstab，就不要使用教程中的方法来生成了，我们的管理方式比较非常规，还是自己写fstab比较好。bootloader也要按照本文下文说的方式来安装跟配置。至于其他的设置键盘、设置网络、设置时区等操作，照着教程来就行。</p>
<h3 id="deb系的手动安装"><a href="#deb系的手动安装" class="headerlink" title="deb系的手动安装"></a>deb系的手动安装</h3><p>deb系的系统网上找到的教程都是使用发行版自带的安装程序的教程，并没有像Archlinux那么详细的手动安装教程。因为我们想要手动安装，所以我们就不参照网上的deb系的安装教程了。但是我们还是有教程可以参照的，那就是Archlinux的wiki里面<a href="https://wiki.archlinux.org/index.php/Systemd-nspawn#Create_a_Debian_or_Ubuntu_environment" target="_blank" rel="noopener">关于systemd-nspawn的教程</a>，这个教程里面有一节介绍如何使用debootstrap安装Debian或者Ubuntu。具体安装过程请参照上述教程，其中关键命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">debootstrap --arch amd64 zesty /mnt/ubuntu http://archive.ubuntu.com/ubuntu/</div></pre></td></tr></table></figure></p>
<p>值得一提的是，我们安装deb系的发行版并不一定要使用deb系的livecd，任何能够安装debootstrap程序的livecd都是可以的。比如说我们完全可以使用Archlinux的livecd来启动，然后安装debootstrap并通过debootstrap来安装Ubuntu。</p>
<p>注意的是，debootstrap并不会像官方安装程序那样安装一个完整齐全开袋即食的操作系统，而只是安装最基本的软件包，读者需要根据自己的情况单独安装桌面环境等的软件包。同时fstab跟bootloader也要根据本文的方法自己配置。</p>
<h2 id="现有系统迁移"><a href="#现有系统迁移" class="headerlink" title="现有系统迁移"></a>现有系统迁移</h2><p>Linux系统的迁移其实非常简单，无非就是把根目录（下文称作root）的文件全都拷贝到目的地即可。不过这个过程虽然看似简单，但是还是有一些需要注意的东西的。比如说对于符号链接，如果处理不当，则会不小心把符号链接搞成实体文件，这就不好了。再比如说，文件的权限等元数据的问题，如果处理不当，可能会导致拷贝过程中元数据的丢失。这两种问题，都有可能会导致系统不能正常运行。还有一个需要注意的地方就是，正常运行的操作系统里，会有/proc、/dev等目录，这些目录都是单独的虚拟文件系统，是不需要拷贝的，也是无法拷贝的。</p>
<p>我们现在假设用户想要把位于A的Ubuntu系统迁移到目标子卷<code>/mnt/ubuntu</code>去。其中，A可能位于虚拟机中，可能位于另一台电脑上，也可能位于本地磁盘。对系统进行迁移，大方向上来讲，需要做的有两步：</p>
<ol>
<li>挂载相应分区，设置ssh，保证我们能够访问到A。</li>
<li>使用<code>rsync</code>或者<code>btrfs send</code>命令来把数据从A发送到目标子卷中去。</li>
</ol>
<p>第一步具体怎么做就不说了，分三种情况简单几句话概括一下怎么做：</p>
<ul>
<li>如果只是一个分区的话，mount就可以了</li>
<li>如果是另一台机器，把那台机器配置好ssh，保证root用户可以用ssh访问</li>
<li>如果是虚拟机，有两种选择，一种是想办法挂载虚拟机的磁盘镜像，然后像情况1那样处理；另一种则是配置好网络跟ssh，像情况2那样处理。具体采取哪种措施请读者根据自己的情况来自行决定。</li>
</ul>
<p>第二步我们来分别介绍<code>rsync</code>跟<code>btrfs send</code>两种方法。</p>
<p><code>rsync</code>的方法<a href="https://wiki.archlinux.org/index.php/full_system_backup_with_rsync" target="_blank" rel="noopener">这里有教程</a>可以参照。我们现在假设A的ip地址为<code>192.168.88.3</code>。则只需执行如下命令即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rsync -aAXv --exclude=&#123;<span class="string">"/dev/*"</span>,<span class="string">"/proc/*"</span>,<span class="string">"/sys/*"</span>,<span class="string">"/tmp/*"</span>,<span class="string">"/run/*"</span>,<span class="string">"/mnt/*"</span>,<span class="string">"/media/*"</span>,<span class="string">"/lost+found"</span>&#125; root@192.168.88.3:/ /mnt/ubuntu</div></pre></td></tr></table></figure></p>
<p>这里提醒读者注意自己系统上是否还有其他不想要同步的文件，记得一并排除掉。</p>
<p><code>btrfs send</code>只在A的root也是btrfs的情况下才能使用。<a href="https://btrfs.wiki.kernel.org/index.php/Incremental_Backup" target="_blank" rel="noopener">这个方法的教程参见这里</a>。首先需要做的是在A机器上给root创建一个只读快照（注意下面命令是在A机器上执行的）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">btrfs subvolume snapshot -r / /ubuntu</div></pre></td></tr></table></figure></p>
<p>注意上面命令中快照的名字要和目标子卷的名字相同，这样可以省去将来改名的麻烦。然后就可以使用<code>btrfs send</code>命令来把快照/ubuntu中的内容发送到目的地了，在这之前我们需要暂时删除我们分区的时候创建的ubuntu子卷，这个子卷会在接收过程中自动重新创建：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">btrfs subvolume delete /mnt/ubuntu</div><div class="line">ssh root@192.168.88.3 btrfs send /ubuntu | btrfs receive /mnt</div></pre></td></tr></table></figure></p>
<p>最后在A机器上把刚刚创建的快照删除就可以了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">btrfs subvolume delete /ubuntu</div></pre></td></tr></table></figure></p>
<h1 id="bootloader与fstab"><a href="#bootloader与fstab" class="headerlink" title="bootloader与fstab"></a>bootloader与fstab</h1><p>系统装好了，我们的fstab还没设置，启动管理器也还没安装配置。下面来讲讲怎么配置这两样东西。我们之前说过一定要给分区取一个Label，玄机在这里。如何在虚拟机中直接运行本地磁盘上安装的Linux，以及如何能把一个系统直接进行打包带走而不需要更改太多配置，关键也在这里。</p>
<h2 id="fstab"><a href="#fstab" class="headerlink" title="fstab"></a>fstab</h2><p>先来说说fstab，fstab总共有五列，分别为fs、mountpoint、type、opts跟dump/pass。这五列分别为什么意思、以及fstab该怎么填，网上一查便知，在此不再赘述。这里只说我们需要做的跟常规不一样的地方。</p>
<p>第一个要注意的事情是，大家在填写fstab的时候，通常喜欢在fs那一列填写类似<code>/dev/sda4</code>或者<code>UUID=d5acc217-d524-4a2d-a937-bad945a047b2</code>，而在这里这样是不行的，这里我们填写的是形如<code>/dev/disk/by-label/linux</code>这样的东西。也就是说，我们的fstab里面是通过分区的Label来找分区的。这么做的原因是，我们希望我们的root不光能在这台机器上启动，还希望它能在虚拟机的环境中，或者当我们把root打包带走同步到别的机器上的时候，也能正常启动。在这台机器上root所在的分区叫做<code>/dev/sda4</code>，在别的机器上或者虚拟机里就不一定还叫<code>/dev/sda4</code>了。但是我们只要遵守自己的命名规则，所有机器上的这些分区我们都取相同的Label，那么我们的fstab就是放之四海而皆准的，不需要为不同的环境而更改。</p>
<p>第二个需要注意的问题是，不要填写root的条目。这种做法跟通常发行版或者其他用户的默认做法是非常不相同的。为了理解这一点，先来说说Linux系统的启动过程。通常情况下，Linux启动的时候，首先由bootloader把内核装载到内存，并向内核传递参数告诉内核root的位置。接下来内核就会根据传递的参数，以只读方式挂载root，并执行root中的init程序。init程序会调用相应的初始化程序执行各种初始化操作。其中一项初始化操作就是根据fstab的配置，来重新以读写方式挂载root，并且挂载fstab里面配置的其他各个分区到指定位置。明白了Linux启动的过程，我们就知道，fstab里面的root那一行其实不是必须的。删掉了root那一行，我们只需要通过修改bootloader传递给内核的参数，就可以告诉内核直接以读写而不是只读的方式挂载root。</p>
<p>那么，我们在写fstab的时候不写root那一项有啥好处呢？好处就是，我们不仅希望我们的系统能在裸机上用，还希望我们的系统能在虚拟机上用。在下文设置qemu虚拟机的时候，我们会以virtfs的方式把我们的子卷传递给虚拟机，这个时候root就已经不再是<code>/dev/disk/by-label/linux</code>了，如果我们把root的挂载方式硬编码到fstab里面，那么会导致init程序的失败，进而无法启动。</p>
<p>另外有一点值得一提的小技巧是，很多时候我们还有别的一些个分区想要自动挂载。问题在于，这些分区在虚拟机环境中，并不一定是存在的，这就会导致启动的时候由于无法挂载而启动失败。其实系统的设计者早就考虑到这个问题了。如果你不希望fstab中的某些条目自动挂载，在选项里面增加<code>noauto</code>即可。如果你希望一些条目自动挂载，但是这些条目不是那么重要，即使挂载失败也不希望这些条目导致启动失败，可以在选项中增加<code>nofail</code>。这两个选项真的是给我们的系统管理工作提供了非常大的方便。比如说我们可能会在fstab中增加<code>/dev/disk/by-label/swap</code>的条目，以便开机自动将这个分区设置为交换分区供系统使用。然而后面我们会看到，我们设置虚拟机的时候，这个分区在虚拟机环境下，并不一定是可用的。这种情况下，我们希望系统在找不到这个分区的时候直接忽略错误不用swap便是，而不是报错拒绝启动。</p>
<p>说了这么多，直接贴一个fstab的例子好了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tmpfs                  		/tmp	tmpfs	defaults		0 0</div><div class="line">/dev/disk/by-label/swap		none	swap	defaults,nofail		0 0</div></pre></td></tr></table></figure></p>
<h2 id="bootloader"><a href="#bootloader" class="headerlink" title="bootloader"></a>bootloader</h2><p>再来说说启动管理器，这里作者推荐的启动管理器是refind，<a href="http://www.rodsbooks.com/refind/installing.html" target="_blank" rel="noopener">安装教程官网有</a>，在此不赘述。这里只讲一下启动项怎么写。先贴示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menuentry archlinux &#123;</div><div class="line">	icon EFI/refind/icons/os_arch.png</div><div class="line">	volume linux</div><div class="line">	loader archlinux/boot/vmlinuz-linux</div><div class="line">	options &quot;root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw&quot;</div><div class="line">	initrd archlinux/boot/initramfs-linux.img</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中第三行的volume用来指定内核存放的分区，此分区可以通过多种方式来指定，比如通过分区的GUID，但是对我们来说最重要的是可以通过文件系统的Label来指定。我们的root分区Label是”linux”，所以这一行写作<code>volume linux</code>。</p>
<p>接下来就是指定内核位置、内核参数跟initramfs的位置了。其中loader用来指定内核位置，options用来指定内核参数，initrd则用来指定initramfs的位置。示例中的是Archlinux系统，内核是archlinux子卷中的<code>boot/vmlinuz-linux</code>文件，所以写作<code>loader archlinux/boot/vmlinuz-linux</code>。类似，initrd那一行则写作<code>initrd archlinux/boot/initramfs-linux.img</code>。至于内核参数，<code>root=/dev/disk/by-label/linux</code>告诉内核我们的root所在的分区，<code>rootflags=subvol=archlinux</code>告诉内核挂载名为archlinux的子卷，<code>rw</code>则告诉内核以读写方式挂载。对于Ubuntu系统，这三行应该写作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">loader ubuntu/vmlinuz</div><div class="line">options &quot;root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw&quot;</div><div class="line">initrd ubuntu/initrd.img</div></pre></td></tr></table></figure></p>
<p>细心的读者可能已经发现，我们的refind的配置文件中在指定分区的时候用的全是他们的Label，这就保证了这个配置文件的普适性，换台电脑，只要你用同样的管理方式，同样的命名习惯，配置文件里面的东西动都不用动，直接拷贝过去就行。</p>
<h1 id="系统的备份与恢复以及快照的应用"><a href="#系统的备份与恢复以及快照的应用" class="headerlink" title="系统的备份与恢复以及快照的应用"></a>系统的备份与恢复以及快照的应用</h1><p>由于使用了btrfs的动态卷，所以备份恢复工作做起来非常简单。备份系统只需要创建快照即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /mnt</div><div class="line">btrfs subvolume snapshot archlinux backup</div></pre></td></tr></table></figure></p>
<p>至于恢复，其实我们根本不需要恢复，直接把快照作为root用就行。我们只需要去refind的配置文件里面，把相应的启动项改改即可。比如说对于Archlinux而言，只需要改成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menuentry archlinux &#123;</div><div class="line">	icon EFI/refind/icons/os_arch.png</div><div class="line">	volume linux</div><div class="line">	loader backup/boot/vmlinuz-linux</div><div class="line">	options &quot;root=/dev/disk/by-label/linux rootflags=subvol=backup rw&quot;</div><div class="line">	initrd backup/boot/initramfs-linux.img</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果有强迫症，觉得root名字不叫archlinux很不爽，那其实改名也很简单:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /mnt</div><div class="line">btrfs subvolume delete archlinux</div><div class="line">btrfs subvolume snapshot backup archlinux</div></pre></td></tr></table></figure></p>
<p>其实，btrfs的快照功能不仅可以用来备份与恢复系统，还有很多非常灵活的运用的。比如说我想在系统里面安装一个巨大而又混乱的软件，这个软件我只想用几天干一件事情，干完这件事情我就不想用了。问题是，这个软件在官方的软件仓库并没有，要安装，我只能使用软件提供的安装程序来安装，然而软件并没有提供卸载程序，或者卸载程序卸载的很不彻底，会在系统残留垃圾。我想用这软件，然而又不想脏了我的系统，这该怎么办？很简单：创建一个快照，新增加一条以快照为root的启动项，要用软件了就启动到快照中去，用完这个软件以后把快照删除即可。再比如说，我想要搞个虚拟机跟实体机一起来测试某个东西（比如说测试某些网络协议、测试某些集群管理软件等），这个时候我根本没必要重新用安装光盘去装一个虚拟机，只需要创建一个快照，然后把快照作为虚拟机的root启动即可，具体方法下文会介绍，在此不多说。当然，快照的应用还远远不止我说的这些，更多好玩的应用还待读者自己探索。</p>
<h1 id="Windows下访问Linux"><a href="#Windows下访问Linux" class="headerlink" title="Windows下访问Linux"></a>Windows下访问Linux</h1><p>从文章的刚开头我们就说，有时候我们是有在Windows下运行本地安装的Linux的需求的。这个需求可以通过VirtualBox来满足，只需要在VirtualBox中使用本地磁盘来作虚拟磁盘即可。说起来简单，但是实现起来还是需要折腾一下子的。</p>
<p>首先我们需要新建一个虚拟机，具体过程不多说，一路“下一步”就行了，唯一需要注意的是，在创建虚拟磁盘的那一步，选择“不添加虚拟硬盘”：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/virt_hdd.png"></p>
<p>这里我的虚拟机取名为“Linux”。创建完虚拟机了以后，就需要把本地磁盘设置为虚拟磁盘了。VirtualBox只能通过命令来做这件事情，<a href="http://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html" target="_blank" rel="noopener">教程可以在这里找到</a>。首先要做的是寻找我们安装Linux的磁盘的编号，这个可以在系统自带的磁盘管理程序中找到，在我的机器上这个磁盘编号为2：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/dskmgr.png"><br>知道了磁盘的编号，就可以创建虚拟盘了。这里我们使用的命令如下，注意使用管理员身份运行：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">VBoxManage internalcommands createrawvmdk -filename <span class="string">"C:\Users\gaoxiang\VirtualBox VMs\Linux\localdisk.vmdk"</span> -rawdisk \\.\PhysicalDrive2</div></pre></td></tr></table></figure></p>
<p>有了虚拟磁盘了，就可以将虚拟磁盘添加到虚拟机中去了：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/newdisk.png"></p>
<p>虚拟磁盘设置好了，最后一步就是设置EFI了。由于我们之前在分区的时候给文件系统都赋予了Label，并且在refind设置的时候也是用的Label来指定分区，所以同一套refind的配置在虚拟机上也能用。因此我们不需要单独给虚拟机安装bootloader，而是直接用我们之前安装在物理磁盘上的EFI分区中的refind就行。VitualBox默认是不开启EFI的，我们需要在虚拟机的系统设置里面手动勾选EFI：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/efi.png"><br>为了要让VirtualBox自动启动refind，还要对EFI的分区做一些简单的设置，<a href="https://wiki.archlinux.org/index.php/VirtualBox#Installation_in_EFI_mode" target="_blank" rel="noopener">设置的教程参考这里</a>。设置的时候一定要注意，这些设置一定要是通用的，即同一份文件既能在物理机上正常工作也能在虚拟机上正常工作，不要改完了设置以后虚拟机上能跑了物理机却挂了，这就不好玩了。VirtualBox的EFI在启动的时候会优先选择<code>/EFI/BOOT/BOOTX64.EFI</code>，如果找不到的话，才会启动EFI分区根目录下的<code>startup.nsh</code>中指定的bootloader。知道了这一点，为了实现自动启动refind，首先需要检查一下<code>/EFI/BOOT/BOOTX64.EFI</code>这个文件是否存在，若存在，备份并删除之：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> EFI/BOOT</div><div class="line">mv bootx64.efi bootx64-backup.efi</div></pre></td></tr></table></figure></p>
<p>然后就是在EFI分区根目录下新建一个<code>startup.nsh</code>了，这个文件只需要一行，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\EFI\refind\refind_x64.efi</div></pre></td></tr></table></figure></p>
<p>一切设置完毕，运行虚拟机，就能看到我们熟悉的refind界面了：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/refind.png"><br>打开其中的Ubuntu系统，测试一切正常就大功告成了：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/ubuntu.png"></p>
<p>当然，要在虚拟机中使用，还有一些细节性的工作要处理，比如安装VirtualBox的guest需要的相应的内核模块等等，这些在此不谈，读者使用过程中如果发现少啥了，自己装上便是。</p>
<h1 id="Linux下不同发行版的互相访问"><a href="#Linux下不同发行版的互相访问" class="headerlink" title="Linux下不同发行版的互相访问"></a>Linux下不同发行版的互相访问</h1><p>我们已经成功地在Windows下运行Linux了，下一步就是想办法在一个Linux系统下访问其他Linux了。由于这些系统都是Linux，而且都在同一个文件系统里面，所以如果只是想要访问一下里面的文件的话，挂载了用就行了。但是很多时候我们还是有需要来运行其他系统里面安装的程序，或者对那个系统进行管理的。应对这种需求有两种解决方案：容器跟虚拟机。</p>
<p>可能很多读者并不了解这两者的区别，这里简单介绍一下。粗略来讲，虚拟机是通过软件的方式虚拟出一套硬件环境来，并在这套硬件环境中启动内核，然后内核会进行一个完整的开机过程，包括进行相应的初始化，加载init程序等。相比之下，容器则要轻量很多。容器并不会虚拟出自己的硬件环境，也不会额外加载一个内核。容器所做的，就是在现有内核上，运用namespace来创建出一套独立的进程PID、挂载点、网络接口、用户ID等等，由于不同namespace中的这些个ID之类的标识符都是独立的，所以不同namespace中的进程是互相之间看不到对方的，虚拟出来的环境乍看上去就跟在单独运行的一个系统一样，同样有PID为1的init进程，有自己一套独立的root，等等。虚拟机的优点是更不容易被突破，安全性更好，可以使用自己的内核，但是效率也更低。容器的优点是轻便效率高，但是安全性就要稍差一些，也没法使用定制内核。</p>
<h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><p>Linux下大家最熟悉的容器就是chroot了，但是作者并不喜欢chroot，主要原因有两点：</p>
<ul>
<li>/proc、 /dev等东西不会自动挂载，每次手动挂载挂的心好累</li>
<li>没有一个相对完整的开机过程，好多我希望自动启动的服务并不会运行起来</li>
</ul>
<p>基于上面的原因，作者在这里推荐的容器是systemd-nspawn。关于systemd-nspawn的介绍跟使用教程，<a href="https://wiki.archlinux.org/index.php/Systemd-nspawn" target="_blank" rel="noopener">推荐看这里</a>。systemd-nspawn的使用非常简单，假设你的linux分区已经mount到了/mnt上去了，那么你只需要下面步骤就能启动一个systemd-nspawn容器（以Debian为例）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /mnt/debian</div><div class="line">systemd-nspawn -b</div></pre></td></tr></table></figure></p>
<p>然后就能看到刷刷刷的开机界面了，真的是非常的方便快捷。这里还有一点小技巧是，如果嫌每次开容器都要把linux分区挂载到/mnt上太麻烦，可以在<code>/var/lib/machines</code>里面为每个系统新建一个目录，然后在fstab里面设置一下自动把相应的子卷挂载进去：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/dev/disk/by-label/linux        /var/lib/machines/kali          btrfs           defaults,nofail,noatime,discard,subvol=kali            0 0</div><div class="line">/dev/disk/by-label/linux        /var/lib/machines/debian        btrfs           defaults,nofail,noatime,discard,subvol=debian          0 0</div><div class="line">/dev/disk/by-label/linux        /var/lib/machines/ubuntu        btrfs           defaults,nofail,noatime,discard,subvol=ubuntu          0 0</div></pre></td></tr></table></figure></p>
<p>这么做的好处是，根目录位于<code>/var/lib/machines</code>的系统，在启动systemd-nspawn的时候可以直接使用<code>-M</code>选项来指定系统，而不需要进入相应目录。比如如果想启动Ubuntu系统：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemd-nspawn -b -M ubuntu</div></pre></td></tr></table></figure></p>
<h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p>如果只是想运行一下其他系统里面的程序，那么容器完全就够用了，但是有的时候我们还是需要玩玩不同的内核的，这就必须得用虚拟机了。通常情况下，大家用虚拟机，都是新建一个磁盘镜像，然后插入安装光盘，然后把光盘安装到镜像上。这么做的坏处，一个是访问镜像中的文件不方便，另一个是，我们在本地已经有安装过若干系统了，不去充分利用一下这些而去再重新往镜像里面安装那实在是舍近求远。那我们就来找一个把子卷当成虚拟机root的方法。困难在于，虚拟机是个很独立的东西，是无法直接访问宿主机的文件系统的。然而幸运的是，Linux的内核虚拟化方案KVM提供了一个把本地文件系统传递给虚拟机的解决方案，用到的东西叫做VirtFS，<a href="http://wiki.qemu.org/Documentation/9psetup" target="_blank" rel="noopener">相关的文档见这里</a>。</p>
<p>好消息是，VirtFS是可以作为root的。但是要能正常挂载VirtFS，内核必须要有相应的驱动才行。这里有两种方法可以做到这一点。如果你是自己编译内核的话，那么建议直接将相应的驱动编译进内核而不是模块。根据官网的指示，涉及到的内核配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CONFIG_NET_9P=y</div><div class="line">CONFIG_NET_9P_VIRTIO=y</div><div class="line">CONFIG_9P_FS=y</div><div class="line">CONFIG_9P_FS_POSIX_ACL=y</div></pre></td></tr></table></figure></p>
<p>如果使用的是发行版提供的内核的话，那么可以修改initramfs的相关设置保证9p、9pnet、9pnet_virtio三个modules能被安装到initramfs里面去。这里以Ubuntu做guest为例，具体做法是修改Ubuntu系统中的<code>/etc/initramfs-tools/modules</code>文件，增加下面三行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">9p</div><div class="line">9pnet</div><div class="line">9pnet_virtio</div></pre></td></tr></table></figure></p>
<p>然后重新生成initramfs即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">update-initramfs -u</div></pre></td></tr></table></figure></p>
<p>内核驱动设置好了，就可以启动qemu虚拟机了，这里假定Ubuntu的root已经被mount到了<code>/var/lib/machines/ubuntu</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -m 16G -kernel /var/lib/machines/ubuntu/vmlinuz -initrd /var/lib/machines/ubuntu/initrd.img -virtfs <span class="built_in">local</span>,id=root9p,path=/var/lib/machines/ubuntu,security_model=passthrough,mount_tag=root9p -nographic -append <span class="string">'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd'</span></div></pre></td></tr></table></figure></p>
<p>最后放一张成功的截图：<br><img src="/2017/06/29/能当主力，能入虚拟机，还能随时打包带走，Linux就是这么强大/qemu-ubuntu.png"></p>
<h1 id="无盘系统"><a href="#无盘系统" class="headerlink" title="无盘系统"></a>无盘系统</h1><p>在某些特定的应用场景中，无盘系统用起来还是有不少方便之处的。尤其对于计算机集群而言，使用无盘系统不光能节省购买硬盘的成本，还能大大简化集群的管理。虽然我们并没有集群要管理，但是做一个无盘系统放在硬盘上用来代替livecd，在需要的时候进行一些系统恢复类的操作还是不错的。对同时安装有多个Linux的同学来说，其实用到livecd的时候并不多，偶尔一个系统出故障了，进其他系统把故障系统修复了就好。但是有些操作还是不得不用livecd的，比如要调整Linux分区的大小跟位置，这个分区就不能处于挂载状态，这就不得不用到livecd了。相比于livecd，自己做的无盘系统的好处主要是可定制性。举个不少人遇到过的实际例子来说：系统出故障了，进livecd修复系统，当试图使用vim更改某配置文件的时候，系统提示说vim并没有安装，想要安装，系统又提示说文件系统是只读的，无法安装。其实没有vim还只是小事，用vi或者nano将就一下也就过去了。但是如果自己千辛万苦下载并刻录livecd，却发现自己修复系统必备的软件没有且不能安装，那估计砸电脑的心都有了吧。既然livecd这么不好用，那为什么不搞一个跟自己平时使用的桌面一模一样的无盘系统呢？</p>
<p>要做无盘系统，一种做法是在另一台机器上搞个nfs，然后在本机启动的时候用nfs当做root来启动（需要在内核配置中开启<code>ROOT_NFS</code>选项），这种做法优点是内存占用相对较小（跟作者接下来要介绍的方法相比简直是小多了），但是配置起来比较麻烦，而且网络延迟跟带宽也严重制约系统的性能。由于作者的电脑内存有128G之多，可以随便挥霍不需要节约内存，并且作者只想简单粗暴地把自己平时使用的桌面做成无盘系统来启动，并不想多折腾。所以，作者最终采用的方案是基于initramfs的。要想理解制作过程，需要先了解几个术语：</p>
<h2 id="ramfs、tmpfs、rootfs以及initramfs"><a href="#ramfs、tmpfs、rootfs以及initramfs" class="headerlink" title="ramfs、tmpfs、rootfs以及initramfs"></a>ramfs、tmpfs、rootfs以及initramfs</h2><p>要想理解这个方案的工作原理，需要先了解一下本小节标题中的这几个术语。<a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt" target="_blank" rel="noopener">这几个术语在内核的官方文档中有很好的解释</a>，在这里我们只做一个简单的概括。</p>
<p>首先要从Linux的磁盘缓存机制说起。程序访问文件的时候，Linux会把文件读到内存中缓存起来。磁盘缓存中的文件，如果没被修改过，或者被修改过但是改动已经从缓存同步到磁盘中去了，这种情况下内核会把对应的磁盘缓存标记为干净（clean）的。对于被修改过，但是还没来得及同步到磁盘的文件，内核会将其标记为脏（dirty）的。当Linux内存不足，需要释放内存的时候，Linux会将磁盘缓存中的一些干净的部分释放掉，从而将内存挪作他用。ramfs是一个虚拟的文件系统，直观上来讲，它相当于直接把磁盘缓存给挂载到相应的节点上去了：它其中的文件只存活在磁盘缓存中。并且由于没有物理磁盘可以将数据同步出去，所以这些文件的缓存始终是脏的，这也保证了这些文件不会被内核释放掉。而tmpfs则是对ramfs的一个扩展，相比于ramfs，它允许限制文件系统的大小，也允许数据被搬运到swap中去。</p>
<p>rootfs也是一个虚拟的文件系统，它是专门在启动的时候使用的一个特殊的ramfs。要想理解rootfs，需要了解Linux内核的启动过程。这个过程位于内核源码<code>init/main.c</code>文件中的<code>kernel_init</code>函数中，有兴趣的读者可以读一下以便深入了解。简单概括就是：Linux启动的时候，会创建一个rootfs，并把根目录“/”挂载为rootfs。这个rootfs将会伴随Linux终生：跟init进程无法被终止道理类似，rootfs是无法被卸载的。rootfs创建好以后，Linux内核会把bootloader提供的initramfs文件中的内容解压到rootfs中去，如果解压好的文件中能找到<code>/init</code>或者用户通过<code>rdinit=</code>内核参数指定的其他init程序，那么内核会执行这个init程序，并将接下来的初始化工作（比如挂载真正的root、删除旧的rootfs中的内容以节约内存、执行真正的root中的init程序）交由这个init程序负责。如果此时rootfs中无法找到相应的init程序，Linux就会尝试挂载真正的root，并执行root中的init程序。</p>
<h2 id="基于initramfs的无盘系统制作"><a href="#基于initramfs的无盘系统制作" class="headerlink" title="基于initramfs的无盘系统制作"></a>基于initramfs的无盘系统制作</h2><p>了解了上述的原理，我们的无盘系统制作思路也就清晰了：我们直接把自己的桌面打包成一个cpio，然后作为initramfs提供给内核，然后通过<code>rdinit</code>参数告诉内核启动<code>systemd</code>即可。具体做法，这里就以Ubuntu为例，并假定Linux分区被挂载在<code>/mnt</code>中。首先需要把我们的桌面制作成一个cpio包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /mnt/ubuntu</div><div class="line">find -mindepth 1 -<span class="built_in">printf</span> <span class="string">'%P\0'</span> | LANG=C bsdcpio -0 -o -H newc | xz -T 21 -9e --check=crc32 &gt; ../ubuntu.cpio.xz</div></pre></td></tr></table></figure></p>
<p>其中xz命令中的线程数跟压缩比请根据自己的实际情况设置合适的值。另外注意如果内存太小装不下整个桌面，那么这种方法是不可能成功的。有了cpio文件，要想启动无盘系统，只需要在refind中增加相应的菜单条目即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menuentry Ubuntu-diskless &#123;</div><div class="line">	icon EFI/refind/icons/os_ubuntu.png</div><div class="line">	volume linux</div><div class="line">	loader ubuntu/vmlinuz</div><div class="line">	options &quot;rdinit=/lib/systemd/systemd&quot;</div><div class="line">	initrd ubuntu.cpio.xz</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>全剧终</em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;更新日志&lt;/strong&gt;：&lt;br&gt;2017-07-18 增加了新的一章：无盘系统，将多处不当使用的术语“rootfs”替换为更贴切的“root”&lt;/p&gt;
&lt;p&gt;===================&lt;/p&gt;
&lt;p&gt;这里介绍一下自己管理自己的Linux桌面的一点经验吧，我觉得还是有不少可取之处的。先来说一下大多数人管理Linux桌面的方法有哪些不方便的地方吧：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;买新电脑了，又得在新电脑上安装Linux，安装各种软件，各种库，各种开发环境，配置各种服务，真麻烦。&lt;/li&gt;
&lt;li&gt;最近一直在用电脑A，干了好多事情安装了好多软件，也配置了不少开发环境跟各种服务，然而处于某种原因，我又要开始使用好久没用过的电脑B了，难道我要把在A上的做的各种配置在B上再重新做一遍？&lt;/li&gt;
&lt;li&gt;在Windows下做着PPT呢，发现需要调出自己之前的程序，然后根据若干组输入跑几个结果画张图好插到PPT里，然而这个程序是在Linux下写的，编译等的过程也严重依赖自己用的Linux环境，重启进Linux拿到结果再回Windows太不方便，想在Windows下配置好环境把自己的程序跑通更不容易。&lt;/li&gt;
&lt;li&gt;要对系统安装某个软件，或者进行一些比较危险的更新操作（要知道Archlinux滚动更新滚挂了太正常了），担心把系统搞挂了，系统备份又实在太麻烦，要真挂了，系统恢复起来更麻烦。&lt;/li&gt;
&lt;li&gt;我一直用Archlinux做主力，然而最近做的某件事情要用某个软件，这个软件官方只给了Ubuntu上的安装方式，Archlinux里面没有相应的包，在Archlinux上手动安装也太不方便。装个Ubuntu，然后暂时用几天Ubuntu吧，也是够折腾的。更何况有时候只是想用一小下而已，怎样才能最小化自己在折腾上浪费的时间呢？&lt;/li&gt;
&lt;li&gt;有的软件官方软件仓库里面没有，而&lt;code&gt;make install&lt;/code&gt;的话则会在系统中安装上不被包管理器所管理的文件，将来卸载也不方便，我还是更希望所有的文件都在一个包管理器中管理的。&lt;/li&gt;
&lt;li&gt;听说新版本内核引入了某个牛逼的东西？我就想快速测试一下玩玩，我电脑还有计算在跑着呢，我可不想重启，那就只能用虚拟机尝试了。而且，一定要快速，我可不想为此特地装一个虚拟机。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上述的这些不方便之处是可以通过自己管理系统时的一些技巧来克服的，本文目的就是来介绍一下这些技巧。通过这些技巧，我们实现的功能是：一台机器上，可以同时安装Windows跟若干Linux系统，Windows下可以通过虚拟机来运行位于本地磁盘的这些Linux系统，而这些Linux系统下也可以通过容器或者虚拟机的方式互相运行。并且这些系统可以非常方便地备份跟删除，也可以随时创建以及运行快照。并且这些Linux系统可以随时打包带走，只需要经过很少的修改，就能直接在U盘或者其他机器上运行。如果要换电脑，或者新装一台电脑，也不需要重新安装系统，只需要把已有的系统同步到新电脑就行。这也正是这篇文章标题的意思。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://zasdfgbnm.github.io/tags/Linux/"/>
    
      <category term="系统管理" scheme="https://zasdfgbnm.github.io/tags/%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/"/>
    
      <category term="btrfs" scheme="https://zasdfgbnm.github.io/tags/btrfs/"/>
    
      <category term="refind" scheme="https://zasdfgbnm.github.io/tags/refind/"/>
    
      <category term="fstab" scheme="https://zasdfgbnm.github.io/tags/fstab/"/>
    
      <category term="root" scheme="https://zasdfgbnm.github.io/tags/root/"/>
    
      <category term="rootfs" scheme="https://zasdfgbnm.github.io/tags/rootfs/"/>
    
      <category term="ramfs" scheme="https://zasdfgbnm.github.io/tags/ramfs/"/>
    
      <category term="虚拟机" scheme="https://zasdfgbnm.github.io/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
      <category term="容器" scheme="https://zasdfgbnm.github.io/tags/%E5%AE%B9%E5%99%A8/"/>
    
      <category term="virtfs" scheme="https://zasdfgbnm.github.io/tags/virtfs/"/>
    
      <category term="KVM" scheme="https://zasdfgbnm.github.io/tags/KVM/"/>
    
      <category term="qemu" scheme="https://zasdfgbnm.github.io/tags/qemu/"/>
    
      <category term="VitualBox" scheme="https://zasdfgbnm.github.io/tags/VitualBox/"/>
    
      <category term="Plan 9" scheme="https://zasdfgbnm.github.io/tags/Plan-9/"/>
    
  </entry>
  
</feed>
